<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Redirecting…</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      background:#0b1220; color:#fff; font-family:system-ui,sans-serif;
      display:flex; align-items:center; justify-content:center; height:100vh;
    }
  </style>
</head>
<body>
  <p>Redirecting…</p>
  <script>
    (async function(){
      // 1) Map your link keys to destinations
      const LINKS = {
        main: "https://lalaland.mx",
        yt: "https://www.youtube.com/@yourchannel",
        store: "https://yourstore.example.com",
        portfolio: "https://myname.github.io/portfolio"
      };

      // 2) Read ?link=... (default -> main)
      const params = new URLSearchParams(location.search);
      const link = (params.get("link") || "main").toLowerCase();
      const dest = LINKS[link] || LINKS.main;

      // 3) Collect client info
      const ua = navigator.userAgent;
      const screenSize = `${screen.width}x${screen.height}`;
      const lang = navigator.language || "unknown";
      const isMobile = /Mobi|Android|iPhone|iPod/i.test(ua);

      // Optional IP → city/country (may fail/timeout in IG webview; safe to ignore)
      let city = "unknown", country = "unknown";
      try {
        const r = await Promise.race([
          fetch("https://ipapi.co/json/"),
          new Promise((_, rej)=>setTimeout(()=>rej(new Error("geo timeout")), 900))
        ]);
        if (r && r.ok) {
          const g = await r.json();
          city = g.city || city;
          country = g.country_name || country;
        }
      } catch (_) {}

      // 4) Build payload + dynamic Title
      const title = `IG Click → ${link}`;
      const payload = {
        event: "IG bio click",
        link,
        time: new Date().toISOString(),
        ua,
        screen: screenSize,
        lang,
        isMobile,
        city,
        country
      };

      // 5) Post to ntfy with dynamic Title (keepalive so it sends during navigation)
      try {
        fetch("https://ntfy.sh/lalaland-webapp-clicks-track", {
          method: "POST",
          keepalive: true, // important for redirects/unload
          headers: {
            "Content-Type": "application/json",
            "Title": title,
            "Priority": "high"
          },
          body: JSON.stringify(payload)
        }).catch(()=>{});
      } catch (_) {
        // Fallback: minimal beacon without custom headers (title will be in body text)
        try {
          const text = `${title}\n${JSON.stringify(payload)}`;
          navigator.sendBeacon(
            "https://ntfy.sh/lalaland-webapp-clicks-track",
            new Blob([text], { type: "text/plain" })
          );
        } catch (_) {}
      }

      // 6) Redirect immediately
      location.replace(dest);
    })();
  </script>
</body>
</html>
