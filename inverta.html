<!DOCTYPE html>
<html>
<head>
    <title>Inverta - Whatsapp</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .container { background: #f5f5f5; padding: 20px; border-radius: 10px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #25D366; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #128C7E; }
        button.delete { background: #ff4444; }
        button.delete:hover { background: #cc0000; }
        .pair { background: white; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #25D366; }
        .success { color: green; background: #e8f5e8; padding: 10px; border-radius: 4px; }
        .error { color: red; background: #ffe8e8; padding: 10px; border-radius: 4px; }
        .loading { color: #666; }
        .form-row { display: flex; gap: 15px; }
        .form-row .form-group { flex: 1; }
        .group-preview { background: #e8f4fd; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #25D366; }
        .group-preview h3 { margin-top: 0; color: #128C7E; }
        .image-preview { display: flex; gap: 20px; margin: 15px 0; }
        .image-box { text-align: center; }
        .image-box img { width: 100px; height: 100px; object-fit: cover; border-radius: 10px; border: 2px solid #ddd; }
        .image-box p { margin: 5px 0; font-size: 12px; color: #666; }
        .connection-status { position: fixed; top: 10px; right: 10px; padding: 5px 10px; border-radius: 15px; font-size: 12px; }
        .connected { background: #28a745; color: white; }
        .disconnected { background: #dc3545; color: white; }
        
        /* Progress wheel and bar styles */
        .loading-wheel {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #25D366;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #25D366;
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }
    </style>
</head>
<body>
    <div id="connectionStatus" class="connection-status disconnected">üîå Connecting...</div>
    
    <div class="container">
        <h1>üì± Inverta Whatsapp - Powered by La-La Land</h1>
        
        <div class="form-row">
            <div class="form-group">
                <label>Buyer Name:</label>
                <input type="text" id="buyerName" placeholder="John Buyer" oninput="updatePreview()" />
            </div>
            <div class="form-group">
                <label>Buyer Phone Number:</label>
                <input type="text" id="buyerNumber" placeholder="5218111111111" oninput="updatePreview()" />
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label>Agent Name:</label>
                <input type="text" id="agentName" placeholder="Maria Agent" oninput="updatePreview()" />
            </div>
            <div class="form-group">
                <label>Agent Phone Number:</label>
                <input type="text" id="agentNumber" placeholder="5218222222222" oninput="updatePreview()" />
            </div>
        </div>
        
        <div class="group-preview">
            <h3>üìã Group Names Preview</h3>
            <div id="sellerGroupPreview"><strong>Seller Group:</strong> <span id="sellerPreview">Agente: [Agent Name] | Cliente: [Buyer Name]</span></div>
            <div id="buyerGroupPreview"><strong>Buyer Group:</strong> <span id="buyerPreview">Cliente: [Buyer Name] | Agente: [Agent Name]</span></div>
            
            <div class="image-preview">
                <div class="image-box">
                    <img src="https://la-la.land/InvertaAgente.png" alt="Seller Group Image" 
                         onerror="this.src='https://via.placeholder.com/100/25D366/ffffff?text=Agente'">
                    <p>Seller Group Image</p>
                </div>
                <div class="image-box">
                    <img src="https://la-la.land/InvertaCliente.png" alt="Buyer Group Image"
                         onerror="this.src='https://via.placeholder.com/100/128C7E/ffffff?text=Cliente'">
                    <p>Buyer Group Image</p>
                </div>
            </div>
        </div>
        
        <button onclick="createPair()" id="createButton" disabled>üîÑ Initializing...</button>
        
        <!-- Progress Container -->
        <div id="progressContainer" style="display: none;">
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            <div id="progressText" style="text-align: center; font-size: 14px; color: #666; margin-top: 5px;">
                <span id="progressPercent">0%</span> - Creating your groups...
            </div>
        </div>
        
        <div id="message"></div>
        
        <h2>Request History</h2>
        <div id="pairsList"></div>
    </div>

    <script>
        let supabaseClient = null;
        let progressInterval;
        
        function updatePreview() {
            const buyerName = document.getElementById('buyerName').value || '[Buyer Name]';
            const agentName = document.getElementById('agentName').value || '[Agent Name]';
            
            document.getElementById('sellerPreview').textContent = `Agente: ${agentName} | Cliente: ${buyerName}`;
            document.getElementById('buyerPreview').textContent = `Cliente: ${buyerName} | Agente: ${agentName}`;
        }
        
        function startProgressAnimation() {
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressPercent = document.getElementById('progressPercent');
            
            progressContainer.style.display = 'block';
            
            let progress = 0;
            const totalTime = 70000; // 70 seconds total
            
            clearInterval(progressInterval);
            progressInterval = setInterval(() => {
                progress += 100; // Update every 100ms
                const percent = Math.min((progress / totalTime) * 100, 95); // Stop at 95%
                
                progressFill.style.width = percent + '%';
                progressPercent.textContent = Math.round(percent) + '%';
                
                // Don't auto-complete - wait for backend
                if (percent >= 95) {
                    clearInterval(progressInterval);
                    progressPercent.textContent = '95% - Almost done...';
                }
            }, 100);
        }
        
        function completeProgressAnimation() {
            const progressFill = document.getElementById('progressFill');
            const progressPercent = document.getElementById('progressPercent');
            
            clearInterval(progressInterval);
            
            // Jump to 100%
            progressFill.style.width = '100%';
            progressPercent.textContent = '100% - Complete!';
            
            // Hide after 2 seconds
            setTimeout(() => {
                document.getElementById('progressContainer').style.display = 'none';
            }, 2000);
        }
        
        function stopProgressAnimation() {
            clearInterval(progressInterval);
            document.getElementById('progressContainer').style.display = 'none';
        }
        
        // Initialize Supabase dynamically
        function initializeSupabase() {
            return new Promise((resolve, reject) => {
                const supabaseScript = document.createElement('script');
                supabaseScript.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
                
                supabaseScript.onload = () => {
                    fetch('https://la-la.land/sb_config.json')
                        .then(response => {
                            if (!response.ok) throw new Error('Failed to load config');
                            return response.json();
                        })
                        .then(config => {
                            supabaseClient = window.supabaseClient = supabase.createClient(config.url, config.key);
                            console.log('‚úÖ Supabase client initialized');
                            
                            // Update UI
                            document.getElementById('createButton').disabled = false;
                            document.getElementById('createButton').textContent = 'Create Groups with Images';
                            document.getElementById('connectionStatus').className = 'connection-status connected';
                            document.getElementById('connectionStatus').textContent = '‚úÖ Connected';
                            
                            loadPairs();
                            
                            // Real-time subscription
                            const subscription = supabaseClient
                                .channel('schema-db-changes')
                                .on(
                                    'postgres_changes',
                                    {
                                        event: '*',
                                        schema: 'public',
                                        table: 'group_requests'
                                    },
                                    (payload) => {
                                        console.log('üîÑ Real-time update received!', payload);
                                        loadPairs();
                                        
                                        if (payload.eventType === 'UPDATE' && payload.new.status === 'completed') {
                                            completeProgressAnimation();
                                            showMessage(`‚úÖ Groups created for ${payload.new.buyer_name} ‚Üî ${payload.new.agent_name}`, 'success');
                                        }
                                    }
                                )
                                .subscribe((status) => {
                                    if (status === 'SUBSCRIBED') {
                                        console.log('üéØ Real-time subscription active!');
                                    }
                                });
                            
                            resolve();
                        })
                        .catch(error => {
                            console.error('‚ùå Failed to initialize Supabase:', error);
                            document.getElementById('connectionStatus').className = 'connection-status disconnected';
                            document.getElementById('connectionStatus').textContent = '‚ùå Connection Failed';
                            document.getElementById('createButton').textContent = '‚ùå Failed to Connect';
                            reject(error);
                        });
                };
                
                supabaseScript.onerror = () => {
                    reject(new Error('Failed to load Supabase client'));
                };
                
                document.head.appendChild(supabaseScript);
            });
        }
        
        async function createPair() {
            if (!supabaseClient) {
                showMessage('‚ùå Supabase client not initialized', 'error');
                return;
            }
            
            const buyerName = document.getElementById('buyerName').value;
            const buyerNumber = document.getElementById('buyerNumber').value;
            const agentName = document.getElementById('agentName').value;
            const agentNumber = document.getElementById('agentNumber').value;
            
            if (!buyerName || !buyerNumber || !agentName || !agentNumber) {
                showMessage('Please fill in all fields', 'error');
                return;
            }
            
            showMessage('', 'loading');
            startProgressAnimation();
            
            try {
                const { data, error } = await supabaseClient
                    .from('group_requests')
                    .insert([{
                        buyer_name: buyerName,
                        buyer_number: buyerNumber,
                        agent_name: agentName,
                        agent_number: agentNumber,
                        status: 'pending'
                    }])
                    .select();
                
                if (error) throw error;
                
                showMessage('<div class="loading-wheel"></div> Request submitted! Creating groups...', 'loading');
                
                document.getElementById('buyerName').value = '';
                document.getElementById('buyerNumber').value = '';
                document.getElementById('agentName').value = '';
                document.getElementById('agentNumber').value = '';
                updatePreview();
                
            } catch (err) {
                stopProgressAnimation();
                showMessage('‚ùå Failed to submit request: ' + err.message, 'error');
            }
        }
        
        async function loadPairs() {
            if (!supabaseClient) return;
            
            try {
                const { data: requests, error } = await supabaseClient
                    .from('group_requests')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const pairsList = document.getElementById('pairsList');
                
                if (!requests || requests.length === 0) {
                    pairsList.innerHTML = '<p>No requests yet.</p>';
                    return;
                }
                
                pairsList.innerHTML = requests.map((request) => `
                    <div class="pair">
                        <strong>üìû ${request.buyer_name} ‚Üî ${request.agent_name}</strong>
                        <span style="float: right; padding: 2px 8px; border-radius: 12px; font-size: 12px; 
                            background: ${getStatusColor(request.status)}; color: white;">
                            ${request.status}
                        </span><br>
                        üë§ ${request.buyer_name}: ${request.buyer_number}<br>
                        üè¢ ${request.agent_name}: ${request.agent_number}<br>
                        <small>Created: ${new Date(request.created_at).toLocaleString()}</small>
                        ${request.completed_at ? `<br><small>Completed: ${new Date(request.completed_at).toLocaleString()}</small>` : ''}
                        ${request.error_message ? `<br><small style="color: red;">Error: ${request.error_message}</small>` : ''}
                    </div>
                `).join('');
            } catch (err) {
                console.error('Error loading requests:', err);
                document.getElementById('pairsList').innerHTML = '<p>Error loading requests</p>';
            }
        }
        
        function getStatusColor(status) {
            const colors = {
                'pending': '#ffa500',
                'processing': '#007bff', 
                'completed': '#28a745',
                'error': '#dc3545'
            };
            return colors[status] || '#6c757d';
        }
        
        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = `<div class="${type}">${message}</div>`;
        }
        
        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', () => {
            updatePreview();
            initializeSupabase().catch(console.error);
        });
    </script>
</body>
</html>