<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Receipt Creator - La-La Land</title>

  <!-- Load Google Fonts with preconnect for faster loading -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
  // ===== LOAD SUPABASE =====
  window.supabaseReady = new Promise((resolve, reject) => {
    const supabaseScript = document.createElement('script');
    supabaseScript.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';

    supabaseScript.onload = () => {
      fetch('https://la-la.land/sb_config.json')
        .then(r => r.json())
        .then(cfg => {
          window.supabaseClient = supabase.createClient(cfg.url, cfg.key);
          console.log('‚úÖ Supabase client initialized');
          resolve();
        })
        .catch(e => {
          console.error('Failed to load Supabase config:', e);
          reject(new Error("‚ùå Failed to load Supabase config"));
        });
    };

    supabaseScript.onerror = () => {
      console.error("‚ùå Failed to load Supabase script");
      reject(new Error("‚ùå Failed to load Supabase script"));
    };

    document.head.appendChild(supabaseScript);
  });
  </script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Barlow Condensed', sans-serif;
      background: #fcfaf3;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    /* Modal Overlay */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #fcfaf3;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    /* Receipt Container */
    .receipt-modal {
      background: #fff;
      width: 100%;
      max-width: 1100px;
      border-radius: 12px;
      box-shadow:
        0 8px 24px rgba(26, 26, 26, 0.12),
        0 2px 8px rgba(26, 26, 26, 0.08);
      transform: translateY(0);
      transition: transform 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    /* Capture wrapper for screenshot with padding */
    .capture-wrapper {
      padding: 20px;
      background: #fcfaf3;
      display: inline-block;
      border-radius: 20px;
      width: 100%;
      font-family: 'Barlow Condensed', sans-serif !important;
    }

    /* Receipt Header */
    .receipt-header {
      background: #1a1a1a;
      padding: 24px;
      border-radius: 12px 12px 0 0;
      text-align: center;
      position: relative;
    }

    .receipt-header::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 0;
      right: 0;
      height: 8px;
      background: linear-gradient(to right,
        transparent 0%,
        transparent 10px,
        #1a1a1a 10px,
        #1a1a1a 20px,
        transparent 20px,
        transparent 30px
      );
      background-size: 30px 100%;
    }

    .logo-container {
      width: 120px;
      height: auto;
      margin: 0 auto 12px;
    }

    .logo-container svg {
      width: 100%;
      height: auto;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
      shape-rendering: geometricPrecision;
    }

    .receipt-title {
      color: #ff8400;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      font-family: 'Barlow Condensed', sans-serif;
    }

    /* Receipt Body */
    .receipt-body {
      padding: 32px 48px 24px;
      overflow: hidden;
    }

    .form-group {
      margin-bottom: 24px;
      overflow: hidden;
    }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
      font-family: 'Barlow Condensed', sans-serif;
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 16px;
      font-weight: 600;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      transition: all 0.2s ease;
      background: #fafafa;
      box-sizing: border-box;
      max-width: 100%;
      min-height: 44px;
      /* Force consistent rendering */
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }

    .form-input:focus {
      outline: none;
      border-color: #ff8400;
      background: #fff;
      box-shadow: 0 0 0 3px rgba(255, 132, 0, 0.1);
    }

    .form-input::placeholder {
      color: #aaa;
      font-family: 'Barlow Condensed', sans-serif;
    }

    .date-display {
      width: 100%;
      padding: 12px 16px;
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      background: #fafafa;
      color: #1a1a1a;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-sizing: border-box;
      max-width: 100%;
      min-height: 44px;
      display: flex;
      align-items: center;
    }

    .date-display:hover {
      border-color: #ff8400;
      background: #fff;
    }

    .date-input-hidden {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    /* Amount Field Special Styling */
    .amount-group {
      position: relative;
    }

    .currency-symbol {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 16px;
      font-weight: 700;
      color: #ff8400;
      pointer-events: none;
    }

    .amount-input {
      padding-left: 32px;
      font-weight: 700;
      color: #1a1a1a;
      font-family: 'Barlow Condensed', sans-serif;
      min-height: 44px;
    }

    /* Divider */
    .receipt-divider {
      border: none;
      border-top: 2px dashed #e0e0e0;
      margin: 24px 0;
    }

    /* Receipt Footer */
    .receipt-footer {
      padding: 0 24px 32px;
      display: flex;
      gap: 12px;
    }

    .btn {
      flex: 1;
      padding: 14px 20px;
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 1px;
      text-transform: uppercase;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-primary {
      background: #ff8400;
      color: #fff;
    }

    .btn-primary:hover {
      background: #e67700;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 132, 0, 0.3);
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #666;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
      color: #333;
    }

    .btn-download {
      background: #667eea;
      color: #fff;
      display: none;
    }

    .btn-download:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    /* Receipt Number */
    .receipt-number {
      text-align: center;
      padding: 16px 24px 0;
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 11px;
      font-weight: 600;
      color: #999;
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .modal-overlay {
        padding: 10px;
      }
      
      .receipt-body {
        padding: 24px 20px 20px;
      }
      
      .receipt-footer {
        flex-direction: column;
      }
      
      .capture-wrapper {
        padding: 15px;
      }
    }

    /* Animation */
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .receipt-modal {
      animation: slideIn 0.3s ease;
    }

    /* Ensure all form inputs have consistent height */
    #receiptClient,
    #receiptConcept,
    #receiptAmount {
      min-height: 44px;
      height: auto;
    }

    /* Amount field specific */
    .amount-group .form-input {
      min-height: 44px;
    }

    /* Make all form inputs use the same container approach */
.form-input {
  width: 100%;
  padding: 12px 16px;
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 16px;
  font-weight: 600;
  border: 2px solid #e0e0e0;
  border-radius: 6px;
  transition: all 0.2s ease;
  background: #fafafa;
  box-sizing: border-box;
  max-width: 100%;
  min-height: 44px;
  display: flex;
  align-items: center;
}

/* Style the inner inputs to be invisible */
.concept-input,
.amount-input-field {
  border: none !important;
  background: transparent !important;
  width: 100% !important;
  outline: none !important;
  font: inherit !important;
  padding: 0 !important;
  margin: 0 !important;
}

.amount-input-field {
  padding-left: 20px !important;
}

/* Focus states for the containers */
.form-input:focus-within {
  outline: none;
  border-color: #ff8400;
  background: #fff;
  box-shadow: 0 0 0 3px rgba(255, 132, 0, 0.1);
}

/* Currency symbol positioning */
.amount-display {
  position: relative;
}

.amount-display .currency-symbol {
  position: absolute;
  left: 16px;
  top: 50%;
  transform: translateY(-50%);
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 16px;
  font-weight: 700;
  color: #ff8400;
  pointer-events: none;
}

/* Make ALL form inputs exactly the same */
.form-input {
  width: 100%;
  padding: 12px 16px;
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 16px;
  font-weight: 600;
  border: 2px solid #e0e0e0;
  border-radius: 6px;
  transition: all 0.2s ease;
  background: #fafafa;
  box-sizing: border-box;
  max-width: 100%;
  min-height: 44px;
  height: 44px; /* Force exact same height */
  display: flex;
  align-items: center;
}

/* Make sure select and inputs have same height */
select.form-input {
  height: 44px;
}

/* Style the inner inputs to match exactly */
.concept-input,
.amount-input-field {
  border: none !important;
  background: transparent !important;
  width: 100% !important;
  outline: none !important;
  font: inherit !important;
  padding: 0 !important;
  margin: 0 !important;
  height: 100% !important; /* Take full height of container */
  line-height: 1 !important; /* Prevent line-height issues */
}

.amount-input-field {
  padding-left: 20px !important;
}

/* Focus states */
.form-input:focus-within {
  border-color: #ff8400;
  background: #fff;
  box-shadow: 0 0 0 3px rgba(255, 132, 0, 0.1);
}

/* Currency symbol */
.amount-display {
  position: relative;
}

.amount-display .currency-symbol {
  position: absolute;
  left: 16px;
  top: 50%;
  transform: translateY(-50%);
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 16px;
  font-weight: 700;
  color: #ff8400;
  pointer-events: none;
  z-index: 1;
}

.logo-container {
  width: 120px;
  height: auto;
  margin: 0 auto 12px;
}

.logo-container svg {
  width: 100%;
  height: auto;
  filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
  shape-rendering: geometricPrecision; /* Better SVG edges */
}

/* Force better font rendering */
.capture-wrapper {
  padding: 20px;
  background: #fcfaf3;
  display: inline-block;
  border-radius: 20px;
  width: 100%;
  font-family: 'Barlow Condensed', sans-serif !important;
  -webkit-font-smoothing: antialiased !important;
  -moz-osx-font-smoothing: grayscale !important;
  text-rendering: optimizeLegibility !important;
}
  </style>
</head>
<body>
  <div class="modal-overlay">
    <div class="capture-wrapper">
      <div class="receipt-modal">
        <!-- Receipt Header -->
        <div class="receipt-header">
          <div class="logo-container">
            <svg id="Layer_2" data-name="Layer 2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 503.03 451.17">
              <defs>
                <style>
                  .cls-1 {
                    fill: #ff8400;
                    stroke: #ff8400;
                    stroke-width: 14px;
                  }

                  .cls-1, .cls-2 {
                    stroke-miterlimit: 10;
                  }

                  .cls-2 {
                    fill: #fcfaf3;
                    stroke: #fcfaf3;
                    stroke-width: 12px;
                  }
                </style>
              </defs>
              <g id="Layer_1-2" data-name="Layer 1">
                <g>
                  <g>
                    <path class="cls-2" d="M32.38,445.17v-187.71h26.19v168.94h47.97v18.77H32.38Z"/>
                    <path class="cls-2" d="M268.71,445.17v-187.71h17.84l53.3,124.68v-124.68h21.78v187.71h-16.68l-54-128.15v128.15h-22.25Z"/>
                    <path class="cls-2" d="M400.37,445.17v-187.71h40.79c13.9,0,24.91,2.13,33.02,6.37,8.11,4.25,13.9,10.62,17.38,19.12,3.48,8.5,5.21,19.08,5.21,31.75v69.06c0,13.29-1.74,24.49-5.21,33.6-3.48,9.12-9.12,16.03-16.92,20.74-7.8,4.71-18.27,7.07-31.4,7.07h-42.87ZM426.56,426.4h14.83c9.58,0,16.37-1.85,20.39-5.56,4.01-3.71,6.45-9.11,7.3-16.22.85-7.1,1.28-15.68,1.28-25.72v-60.95c0-9.73-.62-17.61-1.85-23.64-1.24-6.03-3.94-10.43-8.11-13.21-4.17-2.78-10.74-4.17-19.7-4.17h-14.14v149.47Z"/>
                  </g>
                  <g>
                    <path class="cls-2" d="M32.38,218.96V31.25h26.19v168.94h47.97v18.77H32.38Z"/>
                    <path class="cls-2" d="M114.18,218.96L154.04,31.25h25.26l40.09,187.71h-24.8l-4.65-25.65h-44.92l-6.28,25.65h-24.56ZM144.52,177.35h42.25l-14.59-84.6c-1.05-6.02-9.69-6-10.73.01l-16.93,84.59Z"/>
                    <path class="cls-2" d="M240.86,161.02v-18.77h34v18.77h-34Z"/>
                    <path class="cls-2" d="M308.6,218.96V31.25h26.19v168.94h47.97v18.77h-74.16Z"/>
                    <path class="cls-2" d="M390.4,218.96l39.86-187.71h25.26l40.09,187.71h-24.8l-4.65-25.65h-44.92l-6.28,25.65h-24.56ZM420.75,177.35h42.25l-14.59-84.6c-1.05-6.02-9.69-6-10.73.01l-16.93,84.59Z"/>
                  </g>
                  <path class="cls-2" d="M133.49,445.17l39.86-187.71h25.26l40.09,187.71h-24.8l-4.65-25.65h-44.92l-6.28,25.65h-24.56ZM163.83,403.56h42.25l-14.59-84.6c-1.05-6.02-9.69-6-10.73.01l-16.93,84.59Z"/>
                  <g>
                    <path class="cls-1" d="M7,420.92v-187.71h26.19v168.94h47.97v18.77H7Z"/>
                    <path class="cls-1" d="M243.33,420.92v-187.71h17.84l53.3,124.68v-124.68h21.78v187.71h-16.68l-54-128.15v128.15h-22.25Z"/>
                    <path class="cls-1" d="M374.99,420.92v-187.71h40.79c13.9,0,24.91,2.13,33.02,6.37,8.11,4.25,13.9,10.62,17.38,19.12,3.48,8.5,5.21,19.08,5.21,31.75v69.06c0,13.29-1.74,24.49-5.21,33.6-3.48,9.12-9.12,16.03-16.92,20.74-7.8,4.71-18.27,7.07-31.4,7.07h-42.87ZM401.18,402.15h14.83c9.58,0,16.37-1.85,20.39-5.56,4.01-3.71,6.45-9.11,7.3-16.22.85-7.1,1.28-15.68,1.28-25.72v-60.95c0-9.73-.62-17.61-1.85-23.64-1.24-6.03-3.94-10.43-8.11-13.21-4.17-2.78-10.74-4.17-19.7-4.17h-14.14v149.47Z"/>
                  </g>
                  <g>
                    <path class="cls-1" d="M7,194.71V7h26.19v168.94h47.97v18.77H7Z"/>
                    <path class="cls-1" d="M88.8,194.71L128.66,7h25.26l40.09,187.71h-24.8l-4.65-25.65h-44.92l-6.28,25.65h-24.56ZM119.15,153.1h42.25l-14.59-84.6c-1.05-6.02-9.69-6-10.73.01l-16.93,84.59Z"/>
                    <path class="cls-1" d="M215.48,136.77v-18.77h34v18.77h-34Z"/>
                    <path class="cls-1" d="M283.22,194.71V7h26.19v168.94h47.97v18.77h-74.16Z"/>
                    <path class="cls-1" d="M365.02,194.71L404.88,7h25.26l40.09,187.71h-24.8l-4.65-25.65h-44.92l-6.28,25.65h-24.56ZM395.37,153.1h42.25l-14.59-84.6c-1.05-6.02-9.69-6-10.73.01l-16.93,84.59Z"/>
                  </g>
                  <path class="cls-1" d="M108.11,420.92l39.86-187.71h25.26l40.09,187.71h-24.8l-4.65-25.65h-44.92l-6.28,25.65h-24.56ZM138.45,379.31h42.25l-14.59-84.6c-1.05-6.02-9.69-6-10.73.01l-16.93,84.59Z"/>
                </g>
              </g>
            </svg>
          </div>
          <div class="receipt-title">Receipt</div>
        </div>

        <!-- Receipt Number -->
        <div class="receipt-number" id="receiptNumber">
          No. <span id="receiptNum">000001</span>
        </div>

<!-- Receipt Body -->
<div class="receipt-body">
  <div class="form-group">
    <label class="form-label" for="receiptClient">Client</label>
    <select id="receiptClient" class="form-input">
      <option value="inverta">Inverta</option>
    </select>
  </div>

  <div class="form-group">
    <label class="form-label" for="receiptDate">Date</label>
    <div class="date-display" id="dateDisplay" onclick="document.getElementById('receiptDate').showPicker()"></div>
    <input type="date" id="receiptDate" class="date-input-hidden">
  </div>

  <div class="form-group">
    <label class="form-label" for="receiptConcept">Concept</label>
    <div class="form-input concept-display" id="conceptDisplay">
      <input 
        type="text" 
        id="receiptConcept" 
        class="concept-input" 
        placeholder="Payment description..."
        style="border: none; background: transparent; width: 100%; outline: none; font: inherit;"
      >
    </div>
  </div>

  <hr class="receipt-divider">

  <div class="form-group amount-group">
    <label class="form-label" for="receiptAmount">Amount</label>
    <div class="form-input amount-display">
      <span class="currency-symbol">$</span>
      <input 
        type="text" 
        id="receiptAmount" 
        class="amount-input-field" 
        placeholder="0.00" 
        inputmode="decimal"
        style="border: none; background: transparent; width: 100%; outline: none; font: inherit; padding-left: 20px;"
      >
    </div>
  </div>
</div>
        <!-- Receipt Footer -->
        <div class="receipt-footer">
          <button class="btn btn-secondary" id="clearBtn" onclick="clearReceipt()">Clear</button>
          <button class="btn btn-primary" id="generateBtn" onclick="generateReceipt()">Generate</button>
          <button class="btn btn-download" id="downloadBtn" onclick="downloadReceipt()" style="display: none;">Download</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let generatedImageBlob = null;
    let currentFilename = '';
    let currentReceiptId = null;

    // Month abbreviations
    const MONTHS = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];

    // Set today's date by default
    document.addEventListener('DOMContentLoaded', async function() {
      const dateInput = document.getElementById('receiptDate');
      const today = new Date().toISOString().split('T')[0];
      dateInput.value = today;
      updateDateDisplay();

      // Fetch next receipt number from database
      await updateReceiptNumber();

      // Listen for date changes
      dateInput.addEventListener('change', updateDateDisplay);
    });

    function updateDateDisplay() {
      const dateInput = document.getElementById('receiptDate');
      const dateDisplay = document.getElementById('dateDisplay');

      if (!dateInput.value) {
        dateDisplay.textContent = 'Select date...';
        return;
      }

      const date = new Date(dateInput.value + 'T00:00:00');
      const day = String(date.getDate()).padStart(2, '0');
      const month = MONTHS[date.getMonth()];
      const year = date.getFullYear();

      dateDisplay.textContent = `${day} ${month} ${year}`;
    }

    async function updateReceiptNumber() {
      const receiptNum = document.getElementById('receiptNum');

      try {
        await window.supabaseReady;

        // Get the next ID by finding the max ID and adding 1
        const { data, error } = await window.supabaseClient
          .from('receipts')
          .select('id')
          .order('id', { ascending: false })
          .limit(1);

        if (error) {
          console.error('Error fetching next receipt number:', error);
          receiptNum.textContent = '------';
          return;
        }

        const nextId = data && data.length > 0 ? data[0].id + 1 : 1;
        receiptNum.textContent = String(nextId).padStart(6, '0');
        currentReceiptId = nextId;

      } catch (error) {
        console.error('Failed to fetch receipt number:', error);
        receiptNum.textContent = '------';
      }
    }

    function clearReceipt() {
      document.getElementById('receiptConcept').value = '';
      document.getElementById('receiptAmount').value = '';
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('receiptDate').value = today;
      updateDateDisplay();
      updateReceiptNumber();

      // Hide download button
      document.getElementById('downloadBtn').style.display = 'none';
      document.getElementById('generateBtn').style.display = 'block';
      document.getElementById('clearBtn').style.display = 'block';

      generatedImageBlob = null;
    }

async function generateReceipt() {
  const clientId = document.getElementById('receiptClient').value;
  const date = document.getElementById('receiptDate').value;
  const concept = document.getElementById('receiptConcept').value;
  const amountRaw = document.getElementById('receiptAmount').value;

  if (!clientId || !date || !concept || !amountRaw) {
    alert('Please fill in all fields');
    return;
  }

  // Parse amount (remove commas)
  const amount = parseFloat(amountRaw.replace(/,/g, ''));
  if (isNaN(amount)) {
    alert('Please enter a valid amount');
    return;
  }

  const generateBtn = document.getElementById('generateBtn');
  const clearBtn = document.getElementById('clearBtn');
  const downloadBtn = document.getElementById('downloadBtn');

  // Show saving state
  generateBtn.textContent = 'Saving...';
  generateBtn.disabled = true;

  try {
    // Save to database first
    await window.supabaseReady;

    const { data, error } = await window.supabaseClient
      .from('receipts')
      .insert([
        {
          client_id: clientId,
          concept: concept,
          amount: amount.toString()
        }
      ])
      .select();

    if (error) {
      throw new Error(`Database error: ${error.message}`);
    }

    if (!data || data.length === 0) {
      throw new Error('Failed to save receipt to database');
    }

    // Update receipt number with actual database ID
    const receiptId = data[0].id;
    const receiptNum = document.getElementById('receiptNum');
    receiptNum.textContent = String(receiptId).padStart(6, '0');
    currentReceiptId = receiptId;

    console.log('‚úÖ Receipt saved to database:', data[0]);

    // Update button text
    generateBtn.textContent = 'Generating Image...';

  } catch (error) {
    console.error('Error saving receipt:', error);
    alert(`Failed to save receipt: ${error.message}`);
    generateBtn.textContent = 'Generate';
    generateBtn.disabled = false;
    return;
  }

  const receiptFooter = document.querySelector('.receipt-footer');

  try {
    // ===== CRITICAL: Wait for fonts to load before capturing =====
    console.log('Waiting for fonts to load...');
    try {
      await document.fonts.ready;
      console.log('‚úÖ Fonts loaded successfully');
      // Extra wait to ensure fonts are fully rendered in the DOM
      await new Promise(resolve => setTimeout(resolve, 300));
    } catch (fontError) {
      console.warn('Font loading check failed, continuing anyway:', fontError);
      // Still wait a bit even if fonts.ready fails
      await new Promise(resolve => setTimeout(resolve, 500));
    }

    // Hide the footer completely before taking screenshot
    const originalFooterDisplay = receiptFooter.style.display;
    receiptFooter.style.display = 'none';

    // Wait a bit for DOM to update
    await new Promise(resolve => setTimeout(resolve, 100));

    // Generate image using html2canvas (better font support than dom-to-image)
    const captureElement = document.querySelector('.capture-wrapper');

    console.log('Starting high-res image generation with html2canvas...');

    // Generate canvas with high resolution
    const canvas = await html2canvas(captureElement, {
      scale: 4, // 4x resolution for crisp text
      useCORS: true,
      allowTaint: false,
      backgroundColor: '#fcfaf3',
      logging: false,
      removeContainer: true,
      imageTimeout: 0,
      // Force opaque rendering to prevent washed out colors
      foreignObjectRendering: false,
      ignoreElements: (element) => {
        // Ignore the footer
        return element.classList && element.classList.contains('receipt-footer');
      }
    });

    console.log('‚úÖ Canvas generated successfully');

    // Fix washed-out colors by ensuring opaque background
    const ctx = canvas.getContext('2d');
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

    // Create a new canvas with solid background
    const finalCanvas = document.createElement('canvas');
    finalCanvas.width = canvas.width;
    finalCanvas.height = canvas.height;
    const finalCtx = finalCanvas.getContext('2d', {
      alpha: false,
      colorSpace: 'srgb'
    });

    // Fill with background color first
    finalCtx.fillStyle = '#fcfaf3';
    finalCtx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);

    // Draw the captured image on top
    finalCtx.drawImage(canvas, 0, 0);

    // Convert to blob
    const blob = await new Promise((resolve) => {
      finalCanvas.toBlob(resolve, 'image/png', 1.0);
    });

    console.log('‚úÖ High-res image generated successfully');

    generatedImageBlob = blob;

    // Create filename
    const dateObj = new Date(date + 'T00:00:00');
    const year = dateObj.getFullYear();
    const month = MONTHS[dateObj.getMonth()];
    const day = String(dateObj.getDate()).padStart(2, '0');
    const receiptNumber = String(currentReceiptId).padStart(6, '0');
    currentFilename = `${year}${month}${day}_receipt_${receiptNumber}.png`;

    // Try upload but don't block the user
    generateBtn.textContent = 'Uploading...';

    try {
      const { data: uploadData, error: uploadError } = await window.supabaseClient
        .storage
        .from('receipts')
        .upload(currentFilename, blob, {
          contentType: 'image/png',
          cacheControl: '3600',
          upsert: false
        });

      if (uploadError) {
        console.error('‚ùå Storage upload failed:', uploadError);
        alert(`Image upload failed: ${uploadError.message}\n\nPlease check:\n- Storage bucket 'receipts' exists\n- Bucket has public upload permissions\n\nReceipt saved to database but without image.`);
      } else {
        console.log('‚úÖ Image uploaded to storage:', uploadData);

        const { data: urlData } = window.supabaseClient
          .storage
          .from('receipts')
          .getPublicUrl(currentFilename);

        console.log('üì∏ Public URL:', urlData.publicUrl);

        const { data: updateData, error: updateError } = await window.supabaseClient
          .from('receipts')
          .update({ image: urlData.publicUrl })
          .eq('id', currentReceiptId)
          .select();

        if (updateError) {
          console.error('‚ùå Database update failed:', updateError);
          alert(`Failed to save image URL to database: ${updateError.message}\n\nColumn name might be wrong. Check if your table has an 'image' column.`);
        } else {
          console.log('‚úÖ Database updated with image URL:', updateData);
          if (!updateData || updateData.length === 0) {
            console.warn('‚ö†Ô∏è Update returned no data - row might not exist or column name is wrong');
          }
        }
      }

    } catch (uploadErr) {
      console.error('‚ùå Upload error:', uploadErr);
      alert(`Upload failed: ${uploadErr.message}\n\nReceipt saved to database but without image.`);
    }

    // Restore footer and show download button
    receiptFooter.style.display = originalFooterDisplay;

    // Update UI
    generateBtn.style.display = 'none';
    clearBtn.style.display = 'none';
    downloadBtn.style.display = 'block';
    downloadBtn.textContent = 'Download Receipt';

    console.log('‚úÖ High-res receipt ready for download:', currentFilename);

  } catch (error) {
    console.error('Error generating high-res receipt:', error);
    
    // Restore footer in case of error
    receiptFooter.style.display = 'flex';
    
    alert(`Error generating receipt: ${error.message}`);
    
    // Reset button
    generateBtn.textContent = 'Generate';
    generateBtn.disabled = false;
  }
}

    function downloadReceipt() {
      if (!generatedImageBlob) {
        alert('Please generate the receipt first');
        return;
      }

      // Create download link
      const url = URL.createObjectURL(generatedImageBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = currentFilename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      console.log('Downloaded:', currentFilename);
    }

    // Format amount with commas on blur
    document.getElementById('receiptAmount').addEventListener('blur', function() {
      if (this.value) {
        // Remove existing commas and parse the number
        const numValue = parseFloat(this.value.replace(/,/g, ''));
        if (!isNaN(numValue)) {
          // Format with commas and 2 decimals
          this.value = numValue.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          });
        }
      }
    });

    // Only allow numbers, decimal point, and commas
    document.getElementById('receiptAmount').addEventListener('input', function(e) {
      // Remove any characters that aren't numbers, dots, or commas
      this.value = this.value.replace(/[^\d.,]/g, '');
    });
  </script>
</body>
</html>