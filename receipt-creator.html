<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Receipt Creator - La-La Land</title>
  <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
  // ===== LOAD SUPABASE =====
  window.supabaseReady = new Promise((resolve, reject) => {
    const supabaseScript = document.createElement('script');
    supabaseScript.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';

    supabaseScript.onload = () => {
      fetch('https://la-la.land/sb_config.json')
        .then(r => r.json())
        .then(cfg => {
          window.supabaseClient = supabase.createClient(cfg.url, cfg.key);
          console.log('✅ Supabase client initialized');
          resolve();
        })
        .catch(e => {
          console.error('Failed to load Supabase config:', e);
          reject(new Error("❌ Failed to load Supabase config"));
        });
    };

    supabaseScript.onerror = () => {
      console.error("❌ Failed to load Supabase script");
      reject(new Error("❌ Failed to load Supabase script"));
    };

    document.head.appendChild(supabaseScript);
  });
  </script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Barlow Condensed', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    /* Modal Overlay */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    /* Receipt Container */
    .receipt-modal {
      background: #fff;
      width: 100%;
      max-width: 400px;
      border-radius: 12px;
      box-shadow:
        0 20px 60px rgba(0, 0, 0, 0.3),
        0 0 0 1px rgba(0, 0, 0, 0.05);
      transform: translateY(0);
      transition: transform 0.3s ease;
      position: relative;
    }

    /* Capture wrapper for screenshot with padding */
    .capture-wrapper {
      padding: 40px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: inline-block;
      border-radius: 20px;
    }

    /* Receipt Header */
    .receipt-header {
      background: #1a1a1a;
      padding: 24px;
      border-radius: 12px 12px 0 0;
      text-align: center;
      position: relative;
    }

    .receipt-header::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 0;
      right: 0;
      height: 8px;
      background: linear-gradient(to right,
        transparent 0%,
        transparent 10px,
        #1a1a1a 10px,
        #1a1a1a 20px,
        transparent 20px,
        transparent 30px
      );
      background-size: 30px 100%;
    }

    .logo-container {
      width: 120px;
      height: auto;
      margin: 0 auto 12px;
    }

    .logo-container svg {
      width: 100%;
      height: auto;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
    }

    .receipt-title {
      color: #ff8400;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    /* Receipt Body */
    .receipt-body {
      padding: 32px 24px 24px;
    }

    .form-group {
      margin-bottom: 24px;
    }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      font-family: 'Courier Prime', monospace;
      font-size: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      transition: all 0.2s ease;
      background: #fafafa;
    }

    .form-input:focus {
      outline: none;
      border-color: #ff8400;
      background: #fff;
      box-shadow: 0 0 0 3px rgba(255, 132, 0, 0.1);
    }

    .form-input::placeholder {
      color: #aaa;
    }

    .date-display {
      width: 100%;
      padding: 12px 16px;
      font-family: 'Courier Prime', monospace;
      font-size: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      background: #fafafa;
      color: #1a1a1a;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .date-display:hover {
      border-color: #ff8400;
      background: #fff;
    }

    .date-input-hidden {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    /* Amount Field Special Styling */
    .amount-group {
      position: relative;
    }

    .currency-symbol {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-family: 'Courier Prime', monospace;
      font-size: 16px;
      font-weight: 700;
      color: #ff8400;
      pointer-events: none;
    }

    .amount-input {
      padding-left: 32px;
      font-weight: 700;
      color: #1a1a1a;
    }

    /* Divider */
    .receipt-divider {
      border: none;
      border-top: 2px dashed #e0e0e0;
      margin: 24px 0;
    }

    /* Receipt Footer */
    .receipt-footer {
      padding: 0 24px 32px;
      display: flex;
      gap: 12px;
    }

    .btn {
      flex: 1;
      padding: 14px 20px;
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 1px;
      text-transform: uppercase;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-primary {
      background: #ff8400;
      color: #fff;
    }

    .btn-primary:hover {
      background: #e67700;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 132, 0, 0.3);
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #666;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
      color: #333;
    }

    .btn-whatsapp {
      background: #25D366;
      color: #fff;
      display: none;
    }

    .btn-whatsapp:hover {
      background: #1ea952;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
    }

    .btn-download {
      background: #667eea;
      color: #fff;
      display: none;
    }

    .btn-download:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    /* Receipt Number */
    .receipt-number {
      text-align: center;
      padding: 16px 24px 0;
      font-family: 'Courier Prime', monospace;
      font-size: 11px;
      color: #999;
      letter-spacing: 2px;
    }

    /* Responsive */
    @media (max-width: 480px) {
      .receipt-modal {
        max-width: 100%;
      }

      .receipt-body {
        padding: 24px 20px 20px;
      }
    }

    /* Animation */
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .receipt-modal {
      animation: slideIn 0.3s ease;
    }
  </style>
</head>
<body>
  <div class="modal-overlay">
    <div class="capture-wrapper">
    <div class="receipt-modal">
      <!-- Receipt Header -->
      <div class="receipt-header">
        <div class="logo-container">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 503.03 451.17">
            <defs>
              <style>.cls-1{fill:#1a1a1a;stroke:#1a1a1a;stroke-width:12px;}.cls-1,.cls-2{stroke-miterlimit:10;}.cls-2{fill:#ff8400;stroke:#ff8400;stroke-width:14px;}</style>
            </defs>
            <g>
              <path class="cls-1" d="M32.38,445.17V257.46H58.57V426.4h48v18.77Z"/>
              <path class="cls-1" d="M268.71,445.17V257.46h17.84l53.3,124.68V257.46h21.78V445.17H344.95L291,317V445.17Z"/>
              <path class="cls-1" d="M400.37,445.17V257.46h40.79q20.86,0,33,6.37a36.59,36.59,0,0,1,17.38,19.12q5.21,12.75,5.21,31.75v69.06q0,19.93-5.21,33.6a40.05,40.05,0,0,1-16.92,20.74q-11.71,7.07-31.4,7.07Zm26.19-18.77h14.83q14.37,0,20.39-5.56t7.3-16.22a221.45,221.45,0,0,0,1.28-25.72V317.94q0-14.6-1.85-23.64t-8.11-13.21q-6.26-4.17-19.7-4.17H426.56Z"/>
              <path class="cls-1" d="M32.38,219V31.25H58.56V200.19h48V219Z"/>
              <path class="cls-1" d="M114.18,219,154,31.25H179.3L219.39,219h-24.8l-4.65-25.65H145L138.74,219Zm30.35-41.61h42.25l-14.59-84.6a5.44,5.44,0,0,0-10.73,0Z"/>
              <path class="cls-1" d="M240.86,161V142.25h34V161Z"/>
              <path class="cls-1" d="M308.6,219V31.25h26.19V200.19h48V219Z"/>
              <path class="cls-1" d="M390.4,219,430.26,31.25h25.26L495.61,219h-24.8l-4.65-25.65H421.25L415,219Zm30.35-41.61H463l-14.59-84.6a5.44,5.44,0,0,0-10.73,0Z"/>
              <path class="cls-1" d="M133.49,445.17l39.86-187.71h25.26L238.7,445.17H213.9l-4.65-25.65H164.33l-6.28,25.65Zm30.35-41.61h42.25L191.5,319a5.44,5.44,0,0,0-10.73,0Z"/>
              <path class="cls-2" d="M7,420.92V233.21H33.19V402.15h48v18.77Z"/>
              <path class="cls-2" d="M243.33,420.92V233.21h17.84l53.3,124.68V233.21h21.78V420.92H319.57l-54-128.15V420.92Z"/>
              <path class="cls-2" d="M375,420.92V233.21h40.79q20.86,0,33,6.37a36.59,36.59,0,0,1,17.38,19.12q5.21,12.75,5.21,31.75v69.06q0,19.93-5.21,33.6a40.05,40.05,0,0,1-16.92,20.74q-11.71,7.07-31.4,7.07Zm26.19-18.77H416q14.37,0,20.39-5.56t7.3-16.22A221.45,221.45,0,0,0,445,354.64V293.69q0-14.6-1.85-23.64T435,256.85q-6.26-4.17-19.7-4.17H401.18Z"/>
              <path class="cls-2" d="M7,194.71V7H33.19V175.94h48v18.77Z"/>
              <path class="cls-2" d="M88.8,194.71,128.66,7h25.26L194,194.71h-24.8l-4.65-25.65H119.65l-6.28,25.65Zm30.35-41.61H161.4L146.81,68.5a5.44,5.44,0,0,0-10.73,0Z"/>
              <path class="cls-2" d="M215.48,136.77V118h34v18.77Z"/>
              <path class="cls-2" d="M283.22,194.71V7h26.19V175.94h48v18.77Z"/>
              <path class="cls-2" d="M365,194.71,404.88,7h25.26l40.09,187.71h-24.8l-4.65-25.65H395.87l-6.28,25.65Zm30.35-41.61h42.25L423,68.5a5.44,5.44,0,0,0-10.73,0Z"/>
              <path class="cls-2" d="M108.11,420.92,148,233.21h25.26l40.09,187.71h-24.8l-4.65-25.65H139l-6.28,25.65Zm30.35-41.61H180.7l-14.59-84.6a5.44,5.44,0,0,0-10.73,0Z"/>
            </g>
          </svg>
        </div>
        <div class="receipt-title">Receipt</div>
      </div>

      <!-- Receipt Number -->
      <div class="receipt-number" id="receiptNumber">
        No. <span id="receiptNum">000001</span>
      </div>

      <!-- Receipt Body -->
      <div class="receipt-body">
        <div class="form-group">
          <label class="form-label" for="receiptClient">Client</label>
          <select
            id="receiptClient"
            class="form-input"
          >
            <option value="inverta">Inverta</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label" for="receiptDate">Date</label>
          <div class="date-display" id="dateDisplay" onclick="document.getElementById('receiptDate').showPicker()"></div>
          <input
            type="date"
            id="receiptDate"
            class="date-input-hidden"
          >
        </div>

        <div class="form-group">
          <label class="form-label" for="receiptConcept">Concept</label>
          <input
            type="text"
            id="receiptConcept"
            class="form-input"
            placeholder="Payment description..."
          >
        </div>

        <hr class="receipt-divider">

        <div class="form-group amount-group">
          <label class="form-label" for="receiptAmount">Amount</label>
          <span class="currency-symbol">$</span>
          <input
            type="text"
            id="receiptAmount"
            class="form-input amount-input"
            placeholder="0.00"
            inputmode="decimal"
          >
        </div>
      </div>

      <!-- Receipt Footer -->
      <div class="receipt-footer">
        <button class="btn btn-secondary" id="clearBtn" onclick="clearReceipt()">Clear</button>
        <button class="btn btn-primary" id="generateBtn" onclick="generateReceipt()">Generate</button>
        <button class="btn btn-download" id="downloadBtn" onclick="downloadReceipt()" style="display: none;">Download</button>
        <button class="btn btn-whatsapp" id="whatsappBtn" onclick="shareToWhatsApp()" style="display: none;">WhatsApp</button>
      </div>
    </div>
    </div>
  </div>

  <script>
    let generatedImageBlob = null;
    let currentFilename = '';
    let currentReceiptId = null;

    // Month abbreviations
    const MONTHS = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];

    // Set today's date by default
    document.addEventListener('DOMContentLoaded', async function() {
      const dateInput = document.getElementById('receiptDate');
      const today = new Date().toISOString().split('T')[0];
      dateInput.value = today;
      updateDateDisplay();

      // Fetch next receipt number from database
      await updateReceiptNumber();

      // Listen for date changes
      dateInput.addEventListener('change', updateDateDisplay);
    });

    function updateDateDisplay() {
      const dateInput = document.getElementById('receiptDate');
      const dateDisplay = document.getElementById('dateDisplay');

      if (!dateInput.value) {
        dateDisplay.textContent = 'Select date...';
        return;
      }

      const date = new Date(dateInput.value + 'T00:00:00');
      const day = String(date.getDate()).padStart(2, '0');
      const month = MONTHS[date.getMonth()];
      const year = date.getFullYear();

      dateDisplay.textContent = `${day} ${month} ${year}`;
    }

    async function updateReceiptNumber() {
      const receiptNum = document.getElementById('receiptNum');

      try {
        await window.supabaseReady;

        // Get the next ID by finding the max ID and adding 1
        const { data, error } = await window.supabaseClient
          .from('receipts')
          .select('id')
          .order('id', { ascending: false })
          .limit(1);

        if (error) {
          console.error('Error fetching next receipt number:', error);
          receiptNum.textContent = '------';
          return;
        }

        const nextId = data && data.length > 0 ? data[0].id + 1 : 1;
        receiptNum.textContent = String(nextId).padStart(6, '0');
        currentReceiptId = nextId;

      } catch (error) {
        console.error('Failed to fetch receipt number:', error);
        receiptNum.textContent = '------';
      }
    }

    function clearReceipt() {
      document.getElementById('receiptConcept').value = '';
      document.getElementById('receiptAmount').value = '';
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('receiptDate').value = today;
      updateDateDisplay();
      updateReceiptNumber();

      // Hide download/share buttons
      document.getElementById('downloadBtn').style.display = 'none';
      document.getElementById('whatsappBtn').style.display = 'none';
      document.getElementById('generateBtn').style.display = 'block';
      document.getElementById('clearBtn').style.display = 'block';

      generatedImageBlob = null;
    }

    async function generateReceipt() {
      const clientId = document.getElementById('receiptClient').value;
      const date = document.getElementById('receiptDate').value;
      const concept = document.getElementById('receiptConcept').value;
      const amountRaw = document.getElementById('receiptAmount').value;

      if (!clientId || !date || !concept || !amountRaw) {
        alert('Please fill in all fields');
        return;
      }

      // Parse amount (remove commas)
      const amount = parseFloat(amountRaw.replace(/,/g, ''));
      if (isNaN(amount)) {
        alert('Please enter a valid amount');
        return;
      }

      const generateBtn = document.getElementById('generateBtn');
      const clearBtn = document.getElementById('clearBtn');

      // Show saving state
      generateBtn.textContent = 'Saving...';
      generateBtn.disabled = true;

      try {
        // Save to database first
        await window.supabaseReady;

        const { data, error } = await window.supabaseClient
          .from('receipts')
          .insert([
            {
              client_id: clientId,
              concept: concept,
              amount: amount.toString()
            }
          ])
          .select();

        if (error) {
          throw new Error(`Database error: ${error.message}`);
        }

        if (!data || data.length === 0) {
          throw new Error('Failed to save receipt to database');
        }

        // Update receipt number with actual database ID
        const receiptId = data[0].id;
        const receiptNum = document.getElementById('receiptNum');
        receiptNum.textContent = String(receiptId).padStart(6, '0');
        currentReceiptId = receiptId;

        console.log('✅ Receipt saved to database:', data[0]);

        // Update button text
        generateBtn.textContent = 'Generating Image...';

      } catch (error) {
        console.error('Error saving receipt:', error);
        alert(`Failed to save receipt: ${error.message}`);
        generateBtn.textContent = 'Generate';
        generateBtn.disabled = false;
        return;
      }

      const receiptFooter = document.querySelector('.receipt-footer');
      const receiptModal = document.querySelector('.receipt-modal');

      try {
        // Hide the footer completely before taking screenshot
        receiptFooter.style.display = 'none';

        // Remove hover effects to prevent color issues
        receiptModal.style.pointerEvents = 'none';
        receiptModal.style.transform = 'translateY(0)';

        // Wait for DOM to fully update and settle
        await new Promise(resolve => setTimeout(resolve, 300));

        // Generate image using html2canvas - capture the wrapper to show padding and background
        const captureElement = document.querySelector('.capture-wrapper');
        const tempCanvas = await html2canvas(captureElement, {
          scale: 2,
          backgroundColor: null,
          logging: false,
          useCORS: true,
          allowTaint: true
        });

        // Create a new canvas with opaque background to prevent color washing
        const canvas = document.createElement('canvas');
        canvas.width = tempCanvas.width;
        canvas.height = tempCanvas.height;
        const ctx = canvas.getContext('2d', { alpha: false });

        // Fill with white background first
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Draw the captured content on top
        ctx.drawImage(tempCanvas, 0, 0);

        // Restore original state
        receiptFooter.style.display = 'flex';
        receiptModal.style.pointerEvents = '';

        // Convert to blob with quality setting
        canvas.toBlob(function(blob) {
          generatedImageBlob = blob;

          // Create filename with date prefix: YYYYMMMDD_receipt_number.png
          const dateObj = new Date(date + 'T00:00:00');
          const year = dateObj.getFullYear();
          const month = MONTHS[dateObj.getMonth()];
          const day = String(dateObj.getDate()).padStart(2, '0');
          currentFilename = `${year}${month}${day}_receipt_${receiptNumber}.png`;

          // Hide Generate and Clear buttons, show Download and WhatsApp buttons
          generateBtn.style.display = 'none';
          clearBtn.style.display = 'none';
          document.getElementById('downloadBtn').style.display = 'block';
          document.getElementById('whatsappBtn').style.display = 'block';

          console.log('Receipt generated:', currentFilename);
        }, 'image/png');

      } catch (error) {
        console.error('Error generating receipt:', error);
        alert('Error generating receipt. Please try again.');
        // Make sure footer is visible again if error occurs
        receiptFooter.style.display = 'flex';
        receiptModal.style.pointerEvents = '';
      }
    }

    function downloadReceipt() {
      if (!generatedImageBlob) {
        alert('Please generate the receipt first');
        return;
      }

      // Create download link
      const url = URL.createObjectURL(generatedImageBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = currentFilename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      console.log('Downloaded:', currentFilename);
    }

    async function shareToWhatsApp() {
      if (!generatedImageBlob) {
        alert('Please generate the receipt first');
        return;
      }

      console.log('Share initiated...');
      console.log('Blob size:', generatedImageBlob.size);
      console.log('Navigator.share available:', !!navigator.share);
      console.log('Clipboard.write available:', !!(navigator.clipboard && navigator.clipboard.write));

      try {
        // Try Web Share API first (works great on mobile)
        const file = new File([generatedImageBlob], currentFilename, { type: 'image/png' });

        console.log('File created:', file.name, file.size);

        if (navigator.share) {
          console.log('Web Share API available');
          const canShareFiles = navigator.canShare && navigator.canShare({ files: [file] });
          console.log('Can share files:', canShareFiles);

          if (canShareFiles) {
            console.log('Attempting Web Share API...');
            await navigator.share({
              files: [file],
              title: 'La-La Land Receipt',
              text: 'Receipt from La-La Land'
            });
            console.log('Shared successfully via Web Share API');
            return;
          }
        }

        // Fallback: Try clipboard (desktop)
        if (navigator.clipboard && navigator.clipboard.write) {
          console.log('Attempting clipboard copy...');
          const item = new ClipboardItem({ 'image/png': generatedImageBlob });
          await navigator.clipboard.write([item]);
          console.log('Copied to clipboard successfully');

          // Show success message with option to open WhatsApp
          const openWA = confirm('✓ Image copied to clipboard!\n\nClick OK to open WhatsApp Web, then paste the image.\nClick Cancel to stay here.');

          if (openWA) {
            window.open('https://web.whatsapp.com/', '_blank');
          }
          return;
        }

        // Final fallback: Download
        console.log('Using download fallback');
        downloadReceipt();
        alert('Image downloaded! Please share it manually via WhatsApp.');

      } catch (error) {
        if (error.name !== 'AbortError') {
          console.error('Error sharing:', error);
          console.error('Error name:', error.name);
          console.error('Error message:', error.message);
          // Fallback: Download the file
          downloadReceipt();
          alert('Share failed. Image downloaded! Please share it manually via WhatsApp.\n\nError: ' + error.message);
        } else {
          console.log('User cancelled share');
        }
      }
    }

    // Format amount with commas on blur
    document.getElementById('receiptAmount').addEventListener('blur', function() {
      if (this.value) {
        // Remove existing commas and parse the number
        const numValue = parseFloat(this.value.replace(/,/g, ''));
        if (!isNaN(numValue)) {
          // Format with commas and 2 decimals
          this.value = numValue.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          });
        }
      }
    });

    // Only allow numbers, decimal point, and commas
    document.getElementById('receiptAmount').addEventListener('input', function(e) {
      // Remove any characters that aren't numbers, dots, or commas
      this.value = this.value.replace(/[^\d.,]/g, '');
    });
  </script>
</body>
</html>
