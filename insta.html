<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Mini Street View (hybrid)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Mapbox GL -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.16.1/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.16.1/mapbox-gl.js"></script>

  <!-- Pannellum (simple, lightweight 360 viewer) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum/build/pannellum.css">
  <script src="https://cdn.jsdelivr.net/npm/pannellum/build/pannellum.js"></script>

  <style>
    :root { --bg:#0b0e13; --panel:#111722; --line:#2a81fb; }
    html, body { margin:0; height:100%; background:var(--bg); color:#eaeaea; font-family:system-ui, sans-serif; }
    #app { display:grid; grid-template-columns: 1fr 46%; grid-template-rows: 56px 1fr; height:100%; }
    header { grid-column:1 / span 2; background:#131a26; border-bottom:1px solid #1f2a3d; display:flex; align-items:center; gap:12px; padding:10px 14px; }
    .brand { font-weight:700; }
    .controls { display:flex; gap:8px; margin-left:auto; }
    button { background:#1c2533; color:#fff; border:1px solid #2a364a; padding:8px 12px; border-radius:10px; cursor:pointer; }
    button:hover { background:#253146; }

    #map { width:100%; height:100%; }
    #viewer { width:100%; height:100%; }

    .panel { background:var(--panel); border-left:1px solid #1f2a3d; display:flex; flex-direction:column; }
    .meta { padding:10px 12px; font-size:12px; opacity:.9; border-bottom:1px solid #1f2a3d; display:flex; gap:8px; align-items:center; }

    /* moving marker (dot + arrow) */
    .marker {
      width: 18px; height: 18px; position: relative;
      transform: translate(-50%, -50%) rotate(0deg);
    }
    .marker .dot {
      width: 18px; height: 18px; border-radius: 50%;
      background:#fff; box-shadow: 0 0 0 2px #4ea3ff;
    }
    .marker .arrow {
      position:absolute; left:50%; top:-8px; width:2px; height:10px;
      background:#4ea3ff; transform: translateX(-50%);
      border-radius: 1px;
    }
  </style>
</head>
<body>
<div id="app">
  <header>
    <div class="brand">Blue line + moving marker • 360 drag</div>
    <div class="controls">
      <button id="prevBtn">⟵ Prev</button>
      <button id="nextBtn">Next ⟶</button>
    </div>
  </header>

  <div id="map"></div>

  <div class="panel">
    <div class="meta" id="meta">Loading…</div>
    <div id="viewer"></div>
  </div>
</div>

<script>
  // Your token (from you)
  mapboxgl.accessToken = 'pk.eyJ1IjoiYW5kcmVzbXR6YyIsImEiOiJjbWN4ZWZvc3MwNjNjMnJwd3h6ZXdyOGJoIn0.ahgRYAxpOnGnnqOjQvJZTA';

  const FLY_ZOOM = 17;
  const YAW_OFFSET = 0; // tweak if the camera's "forward" isn't true yaw (try 90/-90/180)

  let map, marker, viewer, nodes = [], idx = 0;

  // Init map
  map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/dark-v11',
    center: [-100.29, 25.66],
    zoom: 14
  });
  map.addControl(new mapboxgl.NavigationControl({ visualizePitch: true }), 'top-right');

  // Load manifest, build line, init viewer
  (async () => {
    const manifest = await fetch('manifest.json').then(r => r.json());
    nodes = manifest.nodes || [];
    if (!nodes.length) { alert('No nodes in manifest.json'); return; }

    // Build the blue route line from nodes (no per-frame dots)
    const line = {
      type: 'Feature',
      geometry: {
        type: 'LineString',
        coordinates: nodes.map(n => [n.lon, n.lat])
      }
    };

    map.on('load', () => {
      map.addSource('route', { type: 'geojson', data: line });
      map.addLayer({
        id: 'route-line',
        type: 'line',
        source: 'route',
        paint: { 'line-color': '#2a81fb', 'line-width': 4, 'line-opacity': 0.9 }
      });

      // Fit to route
      const b = new mapboxgl.LngLatBounds();
      line.geometry.coordinates.forEach(c => b.extend(c));
      map.fitBounds(b, { padding: 50, duration: 800 });

      // Add a single moving marker
      const el = document.createElement('div');
      el.className = 'marker';
      el.innerHTML = '<div class="dot"></div><div class="arrow"></div>';
      marker = new mapboxgl.Marker({ element: el, rotationAlignment: 'map' })
        .setLngLat([nodes[0].lon, nodes[0].lat])
        .addTo(map);

      // Hook up buttons / keys
      document.getElementById('prevBtn').onclick = () => loadNode(idx - 1, true);
      document.getElementById('nextBtn').onclick = () => loadNode(idx + 1, true);
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') loadNode(idx - 1, true);
        if (e.key === 'ArrowRight') loadNode(idx + 1, true);
      });

      // Start viewer after map is ready
      initViewer();
      loadNode(0, true);
    });
  })();

  function initViewer() {
    // Simple pannellum viewer
    viewer = pannellum.viewer('viewer', {
      type: 'equirectangular',
      panorama: nodes[0].src,
      autoLoad: true,
      hfov: nodes[0].fov || 80,
      pitch: nodes[0].pitch || 0,
      yaw: (nodes[0].yaw || 0) + YAW_OFFSET,
      compass: false,
      showFullscreenCtrl: true,
      showZoomCtrl: true
    });
  }

  function loadNode(i, fly=false) {
    idx = (i + nodes.length) % nodes.length;
    const n = nodes[idx];

    // Update viewer
    viewer.loadScene('scene'+idx, {
      type: 'equirectangular',
      panorama: n.src,
      hfov: n.fov || 80,
      pitch: n.pitch || 0,
      yaw: (n.yaw || 0) + YAW_OFFSET,
      autoLoad: true
    });

    // Meta
    const ts = (n.timestamp != null) ? new Date(n.timestamp*1000).toLocaleString() : '—';
    document.getElementById('meta').textContent =
      `Frame ${idx+1}/${nodes.length} • yaw ${(n.yaw||0).toFixed(1)}° • ${ts}`;

    // Move/rotate marker
    if (marker) {
      marker.setLngLat([n.lon, n.lat]);
      const el = marker.getElement();
      el.style.transform = `translate(-50%, -50%) rotate(${(n.yaw||0)+YAW_OFFSET}deg)`;
    }

    // Fly map
    if (fly && map && map.loaded()) {
      map.flyTo({ center: [n.lon, n.lat], zoom: Math.max(map.getZoom(), FLY_ZOOM), speed: 0.8, curve: 1.42 });
    }

    // Preload next image
    const j = (idx + 1) % nodes.length;
    new Image().src = nodes[j].src;
  }
</script>
</body>
</html>
