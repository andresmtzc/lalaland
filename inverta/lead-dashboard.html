<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>INVERTA - Lead Dashboard</title>
  <link rel="icon" href="favicon.ico">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --color-primary: #2ac6f4;
      --color-cream: #fcfaf3;
      --color-dark: #1a1a1a;
      --color-gray: #8a8880;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Barlow Condensed', Arial, sans-serif;
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      min-height: 100vh;
      padding: 20px;
      color: var(--color-dark);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: var(--color-cream);
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 20px;
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo-section img {
      height: 40px;
    }

    h1 {
      font-size: 32px;
      font-weight: 700;
      color: var(--color-dark);
    }

    .auth-section {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .user-email {
      color: var(--color-gray);
      font-size: 14px;
    }

    button {
      padding: 10px 20px;
      background: var(--color-primary);
      color: var(--color-dark);
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      font-family: 'Barlow Condensed', Arial, sans-serif;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background: #1eb5e3;
    }

    .legend {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      border: 2px solid #e0ddd5;
    }

    .legend-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--color-dark);
    }

    .legend-scale {
      display: flex;
      gap: 25px;
      align-items: center;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    .legend-emoji {
      font-size: 20px;
    }

    .stats-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      border: 2px solid #e0ddd5;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--color-primary);
    }

    .stat-label {
      font-size: 14px;
      color: var(--color-gray);
      margin-top: 5px;
    }

    .table-container {
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid #e0ddd5;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: var(--color-dark);
      color: var(--color-cream);
    }

    th {
      padding: 15px;
      text-align: left;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      user-select: none;
      position: relative;
    }

    th:hover {
      background: #2d2d2d;
    }

    th.sortable::after {
      content: ' ‚Üï';
      opacity: 0.5;
      font-size: 12px;
    }

    th.sorted-asc::after {
      content: ' ‚Üë';
      opacity: 1;
    }

    th.sorted-desc::after {
      content: ' ‚Üì';
      opacity: 1;
    }

    tbody tr {
      border-bottom: 1px solid #e0ddd5;
      transition: background 0.2s;
    }

    tbody tr:hover {
      background: #faf8f3;
    }

    td {
      padding: 15px;
      font-size: 14px;
    }

    .score-cell {
      font-size: 24px;
    }

    .check-mark {
      color: #28a745;
      font-weight: bold;
    }

    .x-mark {
      color: #dc3545;
      font-weight: bold;
    }

    .whatsapp-btn {
      background: #25D366;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 13px;
      transition: background 0.2s;
    }

    .whatsapp-btn:hover {
      background: #20BA5A;
    }

    .loading {
      text-align: center;
      padding: 60px;
      font-size: 18px;
      color: var(--color-gray);
    }

    .error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
    }

    .empty-state {
      text-align: center;
      padding: 60px;
      color: var(--color-gray);
    }

    .empty-state h2 {
      font-size: 24px;
      margin-bottom: 10px;
    }

    /* Login Modal */
    .login-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .login-modal.show {
      display: flex;
    }

    .login-box {
      background: var(--color-cream);
      border-radius: 16px;
      padding: 40px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }

    .login-box h2 {
      margin-bottom: 10px;
      font-size: 24px;
    }

    .login-box p {
      color: var(--color-gray);
      margin-bottom: 25px;
    }

    .login-box input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e0ddd5;
      border-radius: 8px;
      font-size: 16px;
      font-family: 'Barlow Condensed', Arial, sans-serif;
      margin-bottom: 15px;
    }

    .login-box input:focus {
      outline: none;
      border-color: var(--color-primary);
    }

    .login-box button {
      width: 100%;
      padding: 16px;
      font-size: 18px;
    }

    .success-message {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
    }
  </style>
</head>
<body>
  <!-- Login Modal -->
  <div class="login-modal" id="loginModal">
    <div class="login-box">
      <h2>Acceso al Dashboard</h2>
      <p>Ingresa tu email para recibir un c√≥digo de acceso</p>
      <div id="loginError" class="error" style="display: none;"></div>
      <div id="loginSuccess" class="success-message" style="display: none;"></div>
      <form id="loginForm">
        <input type="email" id="emailInput" placeholder="tu@email.com" required>
        <button type="submit" id="loginBtn">Enviar C√≥digo</button>
      </form>
      <form id="otpForm" style="display: none;">
        <input type="text" id="otpInput" placeholder="C√≥digo de 6 d√≠gitos" maxlength="6" required>
        <button type="submit" id="otpBtn">Verificar</button>
      </form>
    </div>
  </div>

  <div class="container">
    <div class="header">
      <div class="logo-section">
        <img src="https://la-la.land/inverta/inverta.svg" alt="INVERTA Logo">
        <h1>Lead Dashboard</h1>
      </div>
      <div class="auth-section">
        <span class="user-email" id="userEmail"></span>
        <button onclick="logout()">Cerrar Sesi√≥n</button>
      </div>
    </div>

    <!-- Temperature Legend -->
    <div class="legend">
      <div class="legend-title">Lead Temperature Scale:</div>
      <div class="legend-scale">
        <div class="legend-item">
          <span class="legend-emoji">‚ùÑÔ∏è</span>
          <span>Frozen (1) - No token claimed</span>
        </div>
        <div class="legend-item">
          <span class="legend-emoji">üßä</span>
          <span>Cold (2) - Claimed, no name</span>
        </div>
        <div class="legend-item">
          <span class="legend-emoji">üå°Ô∏è</span>
          <span>Lukewarm (3) - Low activity</span>
        </div>
        <div class="legend-item">
          <span class="legend-emoji">üî•</span>
          <span>Warm (4) - Good activity</span>
        </div>
        <div class="legend-item">
          <span class="legend-emoji">üí•</span>
          <span>Hot (5) - Ready to buy!</span>
        </div>
      </div>
    </div>

    <!-- Stats Summary -->
    <div class="stats-summary">
      <div class="stat-card">
        <div class="stat-value" id="totalLeads">-</div>
        <div class="stat-label">Total Leads</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="hotLeads">-</div>
        <div class="stat-label">Hot Leads (5)</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="warmLeads">-</div>
        <div class="stat-label">Warm Leads (4)</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="avgScore">-</div>
        <div class="stat-label">Avg Score</div>
      </div>
    </div>

    <div id="errorContainer"></div>
    <div id="loadingContainer" class="loading">Cargando leads...</div>

    <!-- Leads Table -->
    <div class="table-container" id="tableContainer" style="display: none;">
      <table>
        <thead>
          <tr>
            <th class="sortable" data-column="phone">Tel√©fono</th>
            <th class="sortable" data-column="name">Nombre</th>
            <th class="sortable" data-column="claimed">Token</th>
            <th class="sortable" data-column="visits">Visitas</th>
            <th class="sortable" data-column="days">D√≠as</th>
            <th class="sortable" data-column="time">Tiempo</th>
            <th class="sortable" data-column="saved">Guardados</th>
            <th class="sortable sorted-desc" data-column="score">Score</th>
            <th>WhatsApp</th>
          </tr>
        </thead>
        <tbody id="leadsTableBody">
        </tbody>
      </table>
    </div>

    <div id="emptyState" class="empty-state" style="display: none;">
      <h2>No hay leads todav√≠a</h2>
      <p>Los leads aparecer√°n aqu√≠ cuando los usuarios se registren.</p>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    const CURRENT_CLIENT = 'inverta';
    let supabaseClient;
    let currentUser = null;
    let allLeads = [];
    let currentSort = { column: 'score', direction: 'desc' };

    // Initialize
    (async function init() {
      try {
        // Load Supabase config
        const cfg = await fetch('https://la-la.land/sb_config.json').then(r => r.json());
        supabaseClient = window.supabase.createClient(cfg.url, cfg.key);
        console.log('‚úÖ Supabase client initialized');

        // Check authentication
        const { data: { session } } = await supabaseClient.auth.getSession();

        if (!session) {
          showLoginModal();
          return;
        }

        // Validate client access
        const hasAccess = await validateClientAccess(session);
        if (!hasAccess) {
          showError('No tienes acceso a este cliente. Contacta al administrador.');
          await supabaseClient.auth.signOut();
          showLoginModal();
          return;
        }

        currentUser = session.user;
        document.getElementById('userEmail').textContent = currentUser.email;

        // Load leads
        await loadLeads();

        // Set up auth state change listener
        supabaseClient.auth.onAuthStateChange((event, session) => {
          if (event === 'SIGNED_OUT') {
            showLoginModal();
          }
        });

      } catch (error) {
        console.error('Initialization error:', error);
        showError('Error al cargar. Por favor recarga la p√°gina.');
      }
    })();

    async function validateClientAccess(session) {
      try {
        const { data: editor } = await supabaseClient
          .from('editors')
          .select('id')
          .eq('email', session.user.email)
          .eq('client_id', CURRENT_CLIENT)
          .single();

        return !!editor;
      } catch (error) {
        console.error('Access validation error:', error);
        return false;
      }
    }

    async function loadLeads() {
      try {
        document.getElementById('loadingContainer').style.display = 'block';
        document.getElementById('tableContainer').style.display = 'none';
        document.getElementById('emptyState').style.display = 'none';

        // Fetch leads with their stats
        const { data: leads, error } = await supabaseClient
          .from('leads')
          .select('*')
          .eq('client_id', CURRENT_CLIENT)
          .order('created_at', { ascending: false });

        if (error) throw error;

        if (!leads || leads.length === 0) {
          document.getElementById('loadingContainer').style.display = 'none';
          document.getElementById('emptyState').style.display = 'block';
          return;
        }

        // Fetch additional data for each lead
        const leadsWithStats = await Promise.all(leads.map(async (lead) => {
          // Check if token is claimed
          const { data: tokens } = await supabaseClient
            .from('lead_tokens')
            .select('claimed')
            .eq('lead_id', lead.id);

          const hasClaimed = tokens?.some(t => t.claimed) || false;

          // Get session stats
          const { data: sessions } = await supabaseClient
            .from('lead_sessions')
            .select('started_at, duration_seconds')
            .eq('lead_id', lead.id)
            .eq('client_id', CURRENT_CLIENT);

          const visits = sessions?.length || 0;
          const uniqueDays = sessions ? new Set(sessions.map(s =>
            new Date(s.started_at).toDateString()
          )).size : 0;
          const totalTime = sessions?.reduce((sum, s) => sum + (s.duration_seconds || 0), 0) || 0;

          // Get saved lots count
          const { data: savedLots } = await supabaseClient
            .from('lead_saved_lots')
            .select('id')
            .eq('lead_id', lead.id)
            .eq('client', CURRENT_CLIENT);

          const savedCount = savedLots?.length || 0;

          // Calculate score
          const score = calculateScore({
            claimed: hasClaimed,
            hasName: !!(lead.name && lead.last_name),
            visits,
            uniqueDays,
            totalTimeMinutes: totalTime / 60,
            savedLots: savedCount
          });

          return {
            ...lead,
            hasClaimed,
            visits,
            uniqueDays,
            totalTime,
            savedCount,
            score
          };
        }));

        allLeads = leadsWithStats;
        renderLeads();
        updateStats();

        document.getElementById('loadingContainer').style.display = 'none';
        document.getElementById('tableContainer').style.display = 'block';

      } catch (error) {
        console.error('Error loading leads:', error);
        showError('Error al cargar leads: ' + error.message);
        document.getElementById('loadingContainer').style.display = 'none';
      }
    }

    function calculateScore({ claimed, hasName, visits, uniqueDays, totalTimeMinutes, savedLots }) {
      // Score 1: Token not claimed
      if (!claimed) return 1;

      // Score 2: Claimed but no name
      if (!hasName) return 2;

      // Score 3-5: Has name, calculate based on activity
      let score = 2; // Base score for having name

      score += savedLots * 0.6;
      score += visits * 0.08;
      score += uniqueDays * 0.2;
      score += Math.min(totalTimeMinutes, 60) * 0.01;

      // Cap at 5 and round
      return Math.min(Math.round(score), 5);
    }

    function getScoreEmoji(score) {
      const emojis = {
        1: '‚ùÑÔ∏è',
        2: 'üßä',
        3: 'üå°Ô∏è',
        4: 'üî•',
        5: 'üí•'
      };
      return emojis[score] || '‚ùì';
    }

    function formatTime(seconds) {
      if (seconds < 60) return `${seconds}s`;
      const minutes = Math.floor(seconds / 60);
      const secs = seconds % 60;
      if (minutes < 60) return `${minutes}m ${secs}s`;
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      return `${hours}h ${mins}m`;
    }

    function formatPhone(phone) {
      // Format 10 digits as XX XXXX XXXX
      if (phone && phone.length === 10) {
        return `${phone.slice(0,2)} ${phone.slice(2,6)} ${phone.slice(6,10)}`;
      }
      return phone || '-';
    }

    function renderLeads() {
      const tbody = document.getElementById('leadsTableBody');

      // Sort leads
      const sorted = [...allLeads].sort((a, b) => {
        const col = currentSort.column;
        let aVal = a[col];
        let bVal = b[col];

        // Special handling for different columns
        if (col === 'name') {
          aVal = (a.name || '') + ' ' + (a.last_name || '');
          bVal = (b.name || '') + ' ' + (b.last_name || '');
        } else if (col === 'claimed') {
          aVal = a.hasClaimed ? 1 : 0;
          bVal = b.hasClaimed ? 1 : 0;
        } else if (col === 'days') {
          aVal = a.uniqueDays;
          bVal = b.uniqueDays;
        } else if (col === 'time') {
          aVal = a.totalTime;
          bVal = b.totalTime;
        } else if (col === 'saved') {
          aVal = a.savedCount;
          bVal = b.savedCount;
        }

        if (currentSort.direction === 'asc') {
          return aVal > bVal ? 1 : -1;
        } else {
          return aVal < bVal ? 1 : -1;
        }
      });

      tbody.innerHTML = sorted.map(lead => {
        const fullName = `${lead.name || ''} ${lead.last_name || ''}`.trim() || '-';
        const waLink = `https://wa.me/521${lead.phone}`;

        return `
          <tr>
            <td>${formatPhone(lead.phone)}</td>
            <td>${fullName}</td>
            <td>${lead.hasClaimed ? '<span class="check-mark">‚úì</span>' : '<span class="x-mark">‚úó</span>'}</td>
            <td>${lead.visits}</td>
            <td>${lead.uniqueDays}</td>
            <td>${formatTime(lead.totalTime)}</td>
            <td>${lead.savedCount}</td>
            <td class="score-cell">${getScoreEmoji(lead.score)}</td>
            <td><a href="${waLink}" target="_blank" class="whatsapp-btn">üí¨ WhatsApp</a></td>
          </tr>
        `;
      }).join('');
    }

    function updateStats() {
      const total = allLeads.length;
      const hot = allLeads.filter(l => l.score === 5).length;
      const warm = allLeads.filter(l => l.score === 4).length;
      const avgScore = total > 0 ? (allLeads.reduce((sum, l) => sum + l.score, 0) / total).toFixed(1) : '0.0';

      document.getElementById('totalLeads').textContent = total;
      document.getElementById('hotLeads').textContent = hot;
      document.getElementById('warmLeads').textContent = warm;
      document.getElementById('avgScore').textContent = avgScore;
    }

    // Column sorting
    document.addEventListener('click', (e) => {
      const th = e.target.closest('th.sortable');
      if (!th) return;

      const column = th.dataset.column;

      if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.column = column;
        currentSort.direction = 'desc';
      }

      // Update UI
      document.querySelectorAll('th.sortable').forEach(h => {
        h.classList.remove('sorted-asc', 'sorted-desc');
      });
      th.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');

      renderLeads();
    });

    // Login functionality
    function showLoginModal() {
      document.getElementById('loginModal').classList.add('show');
      document.querySelector('.container').style.display = 'none';
    }

    function hideLoginModal() {
      document.getElementById('loginModal').classList.remove('show');
      document.querySelector('.container').style.display = 'block';
    }

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('emailInput').value;
      const btn = document.getElementById('loginBtn');

      btn.disabled = true;
      btn.textContent = 'Enviando...';

      try {
        const { error } = await supabaseClient.auth.signInWithOtp({ email });

        if (error) throw error;

        document.getElementById('loginSuccess').textContent = 'C√≥digo enviado! Revisa tu email.';
        document.getElementById('loginSuccess').style.display = 'block';
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('otpForm').style.display = 'block';
      } catch (error) {
        document.getElementById('loginError').textContent = error.message;
        document.getElementById('loginError').style.display = 'block';
      } finally {
        btn.disabled = false;
        btn.textContent = 'Enviar C√≥digo';
      }
    });

    document.getElementById('otpForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('emailInput').value;
      const token = document.getElementById('otpInput').value;
      const btn = document.getElementById('otpBtn');

      btn.disabled = true;
      btn.textContent = 'Verificando...';

      try {
        const { error } = await supabaseClient.auth.verifyOtp({ email, token, type: 'email' });

        if (error) throw error;

        // Reload page to initialize with auth
        window.location.reload();
      } catch (error) {
        document.getElementById('loginError').textContent = error.message;
        document.getElementById('loginError').style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'Verificar';
      }
    });

    async function logout() {
      await supabaseClient.auth.signOut();
      window.location.reload();
    }

    function showError(message) {
      const container = document.getElementById('errorContainer');
      container.innerHTML = `<div class="error">${message}</div>`;
    }
  </script>
</body>
</html>
