<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>INVERTA - La-La Land</title><link rel="icon" href="favicon.ico" type="image/x-icon"><link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700" rel="stylesheet"><script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script><script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script><link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"><script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@tmcw/togeojson@4.5.0/dist/togeojson.umd.js"></script><script src="https://js.stripe.com/v3/"></script><script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script><link rel="stylesheet" href="https://la-la.land/styles.css"><script>const CURRENT_CLIENT="inverta"</script><script>document.fonts.ready.then(()=>{document.body.classList.add("fonts-loaded")}).catch(()=>{document.body.classList.add("fonts-loaded")})</script><style>#canvas,#viewer-container{touch-action:pan-x pan-y;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;-webkit-touch-callout:none}#lotModal.viewer-mode,.modal-content-wrapper.viewer-mode{touch-action:pan-x pan-y}.globe-login-button:hover{color:#ff8400!important}.globe-login-button.logged-in{color:#fff!important}.dashboard-button:hover{color:#fff!important}.dashboard-button:hover svg path{fill:#fff!important}.dashboard-button.active{color:#fff!important}.dashboard-button.active svg path{fill:#fff!important}.gps-button.active svg{stroke:#ff8400!important}#globalDashboardButton.active{text-decoration:underline!important;text-underline-offset:3px}.unit-btn-compare:hover,.unit-btn-sort:hover{background:#cc6900!important}.gps-button.active svg circle[fill]{fill:#ff8400!important}#pinLockButton:hover{background:#d97000!important}#downPaymentCalc:active,#downPaymentCalc:focus,#installmentsCalc:active,#installmentsCalc:focus,select:active,select:focus{outline:0!important;box-shadow:none!important;-webkit-tap-highlight-color:transparent!important}select,select option{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}#communitySearchBtn,#communitySearchBtn:active,#communitySearchBtn:focus{outline:0!important;box-shadow:none!important;-webkit-tap-highlight-color:transparent!important;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}#communitySearchBtn:hover{transform:scale(1.1)!important}@media only screen and (max-width:440px){.detail-data-row div[style*="font-size: 48px"],.detail-data-row>div>div[style*="font-size: 48px"]{font-size:36px!important}.detail-data-row div[style*="font-size: 24px"]{font-size:20px!important}.detail-data-row div[style*="font-size: 28px"]{font-size:20px!important}.detail-data-row div[style*="font-size: 18px"]{font-size:16px!important}.detail-data-row span[style*="font-size: 60%"]{font-size:55%!important}.detail-data-row>div>div[style*="margin-top: 20px"]{margin-top:12px!important}.detail-data-row>div[style*="gap: 8px"]{gap:6px!important}.detail-data-row select{font-size:16px!important;padding:4px 8px!important}.detail-data-row div[style*="font-size: 12px"]{font-size:11px!important}.cta-header-label{white-space:nowrap!important;font-size:11px!important}}@media only screen and (max-width:390px){.detail-data-row div[style*="font-size: 48px"],.detail-data-row>div>div[style*="font-size: 48px"]{font-size:32px!important}.detail-data-row div[style*="font-size: 24px"]{font-size:18px!important}.detail-data-row div[style*="font-size: 28px"]{font-size:16px!important}.detail-data-row div[style*="font-size: 18px"]{font-size:14px!important}.detail-data-row>div>div[style*="margin-top: 12px"],.detail-data-row>div>div[style*="margin-top: 20px"]{margin-top:8px!important}.detail-data-row>div[style*="gap: 6px"],.detail-data-row>div[style*="gap: 8px"]{gap:4px!important}.detail-data-row select{font-size:14px!important;padding:3px 6px!important;width:70px!important}.detail-data-row div[style*="font-size: 11px"],.detail-data-row div[style*="font-size: 12px"]{font-size:10px!important}.detail-data-row .lot-left{transform:scale(.65)!important}.cta-header-label{white-space:nowrap!important;font-size:9px!important;letter-spacing:.3px!important}}#poiButton:hover,#shareButton:hover{background:#e67300!important;transform:scale(1.05);transition:all .2s ease;text-decoration:underline!important}.detail-data-row div[style*="font-size: 18px"]{white-space:nowrap}#lotDetails.payment-mode{padding:0!important}#stripe-payment-element{display:block!important;visibility:visible!important;position:relative}.payment-scroll-wrapper::-webkit-scrollbar{width:6px}.payment-scroll-wrapper::-webkit-scrollbar-track{background:rgba(200,200,200,.2);border-radius:3px}.payment-scroll-wrapper::-webkit-scrollbar-thumb{background:silver;border-radius:3px;transition:background-color .2s}.payment-scroll-wrapper::-webkit-scrollbar-thumb:hover{background:#a0a0a0}</style></head><body><div id="map"></div><div id="toaster" class="hidden">Loaded most recent aerial image (March 2025)</div><a href="https://wa.me/5218185261819" target="_blank" id="ctaToaster" class="hidden" data-utm-source="website" data-utm-medium="toaster" data-utm-campaign="lead_generation">¬øTienes dudas? ¬°Chatea con nosotros por WhatsApp! </a><button id="globe-login-btn" class="globe-login-button" title="Login" style="position:fixed;top:24px;right:24px;bottom:auto;width:auto;height:auto;padding:0;font-size:14px;font-weight:600;color:#fff;background:0 0;border:none;opacity:1;font-family:'Barlow Condensed',Arial,sans-serif;cursor:pointer">Login</button> <button id="dashboard-btn" class="dashboard-button" title="Dashboard" style="display:none;position:fixed;bottom:28px;left:10px;width:auto;height:auto;padding:0;font-size:14px;font-weight:600;color:#fff;background:0 0;border:none;opacity:1;font-family:'Barlow Condensed',Arial,sans-serif;cursor:pointer;align-items:center;gap:6px;z-index:1"><svg id="eye-closed-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display:inline-block"><path d="M12 7C14.76 7 17 9.24 17 12C17 12.65 16.87 13.26 16.64 13.83L19.56 16.75C21.07 15.49 22.26 13.86 22.99 12C21.26 7.61 16.99 4.5 11.99 4.5C10.59 4.5 9.25 4.75 8.01 5.2L10.17 7.36C10.74 7.13 11.35 7 12 7ZM2 4.27L4.28 6.55L4.74 7.01C3.08 8.3 1.78 10.02 1 12C2.73 16.39 7 19.5 12 19.5C13.55 19.5 15.03 19.2 16.38 18.66L16.8 19.08L19.73 22L21 20.73L3.27 3L2 4.27ZM7.53 9.8L9.08 11.35C9.03 11.56 9 11.78 9 12C9 13.66 10.34 15 12 15C12.22 15 12.44 14.97 12.65 14.92L14.2 16.47C13.53 16.8 12.79 17 12 17C9.24 17 7 14.76 7 12C7 11.21 7.2 10.47 7.53 9.8ZM11.84 9.02L14.99 12.17L15.01 12.01C15.01 10.35 13.67 9.01 12.01 9.01L11.84 9.02Z" fill="#fff"/></svg> <svg id="eye-open-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display:none"><path d="M12 5C7 5 2.73 8.11 1 12.5C2.73 16.89 7 20 12 20C17 20 21.27 16.89 23 12.5C21.27 8.11 17 5 12 5ZM12 17C9.24 17 7 14.76 7 12C7 9.24 9.24 7 12 7C14.76 7 17 9.24 17 12C17 14.76 14.76 17 12 17ZM12 9C10.34 9 9 10.34 9 12C9 13.66 10.34 15 12 15C13.66 15 15 13.66 15 12C15 10.34 13.66 9 12 9Z" fill="#fff"/></svg> <span>Dashboard</span></button><div class="lala-wrapper"><a href="#" onclick="event.preventDefault(),window.location.reload(!0)" title="Reload Site"><img src="https://la-la.land/lalaland_bw.svg" alt="Logo"></a></div><div class="logoinv-wrapper"><a href="#" onclick="event.preventDefault(),window.location.reload(!0)" title="Reload Site"><img src="https://la-la.land/inverta/inverta.svg" alt="Logo"></a></div><div id="lotModal"><div class="modal-header"><div class="header-control" id="backButton"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M10 4 L6 8 L10 12" fill="none"/></svg></div><div class="unit-controls" id="unitControls"><button class="unit-btn unit-btn-sort" data-mode="price" title="Sort by Price" translate="no">$$$</button> <button class="unit-btn unit-btn-compare" id="compareBtn" title="Compare Lots" translate="no">COMPARAR</button></div><div class="header-title"><span id="headerFracc">INVERTA</span><span class="header-lot-number" id="headerLotNumber"></span></div><div class="auth-controls" id="authControls" style="display:none"><button id="modal-login-btn" class="header-control auth-btn" title="Login"><svg width="18" height="18" viewBox="0 0 24 24" fill="#888" aria-hidden="true"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V9h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg></button> <button id="modal-logout-btn" class="header-control auth-btn" title="Logout"><svg width="18" height="18" viewBox="0 0 24 24" fill="#888" aria-hidden="true"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg></button></div><button class="unit-btn" id="shareButton" title="Share this lot" translate="no" style="display:none;position:absolute;right:38px;top:50%;transform:translateY(-50%);width:auto;height:auto;padding:4px 8px;font-size:12px;font-weight:600;border-radius:3px;background:#ff8400;color:#fcfaf3;font-family:'Barlow Condensed',Arial,sans-serif"><svg width="12" height="12" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle;margin-right:4px"><path d="M11 6C12.6569 6 14 4.65685 14 3C14 1.34315 12.6569 0 11 0C9.34315 0 8 1.34315 8 3C8 3.22371 8.02449 3.44169 8.07092 3.65143L4.86861 5.65287C4.35599 5.24423 3.70652 5 3 5C1.34315 5 0 6.34315 0 8C0 9.65685 1.34315 11 3 11C3.70652 11 4.35599 10.7558 4.86861 10.3471L8.07092 12.3486C8.02449 12.5583 8 12.7763 8 13C8 14.6569 9.34315 16 11 16C12.6569 16 14 14.6569 14 13C14 11.3431 12.6569 10 11 10C10.2935 10 9.644 10.2442 9.13139 10.6529L5.92908 8.65143C5.97551 8.44169 6 8.22371 6 8C6 7.77629 5.97551 7.55831 5.92908 7.34857L9.13139 5.34713C9.644 5.75577 10.2935 6 11 6Z" fill="#fcfaf3"/></svg>COMPARTIR</button> <button class="unit-btn" id="poiButton" title="Add Point of Interest" translate="no" style="display:none;position:absolute;right:38px;top:50%;transform:translateY(-50%);width:auto;height:auto;padding:4px 8px;font-size:12px;font-weight:600;border-radius:3px;background:#ff8400;color:#fcfaf3;font-family:'Barlow Condensed',Arial,sans-serif">PIN</button> <button class="unit-btn" id="pinLockButton" title="Lock/Unlock Pin" translate="no" style="display:none;position:absolute;left:12px;top:50%;transform:translateY(-50%);width:20px;height:20px;padding:3px;border-radius:3px;background:#ff8400;color:#fcfaf3;font-family:'Barlow Condensed',Arial,sans-serif;border:none;cursor:pointer"><svg id="unlockIcon" width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display:block"><path d="M18 8H17V6C17 3.24 14.76 1 12 1C9.24 1 7 3.24 7 6H9C9 4.34 10.34 3 12 3C13.66 3 15 4.34 15 6V8H6C4.9 8 4 8.9 4 10V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V10C20 8.9 19.1 8 18 8ZM18 20H6V10H18V20ZM12 17C13.1 17 14 16.1 14 15C14 13.9 13.1 13 12 13C10.9 13 10 13.9 10 15C10 16.1 10.9 17 12 17Z" fill="#fcfaf3"/></svg> <svg id="lockIcon" width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display:none"><path d="M18 8H17V6C17 3.24 14.76 1 12 1C9.24 1 7 3.24 7 6V8H6C4.9 8 4 8.9 4 10V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V10C20 8.9 19.1 8 18 8ZM12 17C10.9 17 10 16.1 10 15C14 13.9 10.9 13 12 13C13.1 13 14 13.9 14 15C14 16.1 13.1 17 12 17ZM15.1 8H8.9V6C8.9 4.29 10.29 2.9 12 2.9C13.71 2.9 15.1 4.29 15.1 6V8Z" fill="#fcfaf3"/></svg></button> <button class="unit-btn" id="globalDashboardButton" title="View All Communities" translate="no" style="display:none;position:absolute;right:38px;top:50%;transform:translateY(-50%);width:auto;height:auto;padding:4px 8px;font-size:12px;font-weight:600;border-radius:3px;background:#ff8400;color:#fcfaf3;font-family:'Barlow Condensed',Arial,sans-serif;border:none;cursor:pointer">GLOBAL</button><div class="header-control close-x" onclick='console.log("‚ùå X BUTTON CLICKED"),closeModal()' id="closeModalBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M4 4 L12 12 M12 4 L4 12" fill="none"/></svg></div><div class="header-control plus-button" onclick="handlePlusButton()"><svg viewBox="0 0 16 16"><path class="plus-icon" d="M8 3 L8 13 M3 8 L13 8" fill="none" stroke="#888" stroke-width="1.5" stroke-linecap="round"/><path class="minus-icon" d="M3 8 L13 8" fill="none" stroke="#888" stroke-width="1.5" stroke-linecap="round" style="display:none"/></svg></div></div><div class="modal-divider"></div><div class="modal-content-wrapper"><div class="loading-spinner" id="loadingSpinner"></div><div class="lot-details" id="lotDetails"></div><div id="calendlyEmbed" class="calendly-embed-container" style="display:none"><iframe id="calendly-iframe" src="about:blank" frameborder="0" style="width:100%;height:100%"></iframe></div><div id="viewer-container" class="viewer-mode" style="display:none"><canvas id="canvas"></canvas><div class="viewer-controls"><button id="prevImageBtnTop">‚Üê Prev</button> <span id="viewer-info">No images loaded</span> <button id="nextImageBtnTop">Next ‚Üí</button></div><div class="image-controls"><div class="navigation-ring"><button class="nav-button ring-button" id="nextImageBtn">‚ñ≥</button> <button class="nav-button ring-button" id="prevImageBtn">‚ñΩ</button> <button class="nav-button ring-button" id="branchImageBtn">‚ñ∑</button></div><div id="branch-buttons" style="margin-top:8px;display:flex;gap:6px;pointer-events:auto"></div></div><div class="time" id="time">-/-</div><div class="loading" id="viewer-loading"><div class="spinner"></div><div id="loading-text">Loading 360¬∞ image...</div></div></div><div class="modal-info" id="modalInfo"></div><div class="custom-scrollbar" id="customScrollbar"><div class="custom-scrollthumb" id="customScrollthumb"></div></div></div><div class="bottom-plus-button" onclick="handlePlusButton()"><svg viewBox="0 0 16 16" class="wiggle-arrow"><path d="M4 6 L8 10 L12 6" fill="none" stroke="#fff" stroke-width="1.5" stroke-linecap="round"/></svg></div></div><div id="auth-modal"><div class="auth-box"><h2>Iniciar sesi√≥n</h2><div id="auth-step-email"><label for="auth-email">Correo electr√≥nico</label> <input type="email" id="auth-email" placeholder="tu@correo.com"> <button class="primary" id="request-otp">Enviar c√≥digo</button> <button class="secondary" id="auth-cancel">Cancelar</button></div><div id="auth-step-otp" style="display:none"><label for="auth-otp">C√≥digo enviado a <span id="otp-email-display"></span></label> <input type="text" id="auth-otp" maxlength="6" placeholder="123456"> <button class="primary" id="verify-otp">Verificar</button> <button class="secondary" id="auth-cancel">Cancelar</button></div></div></div><div id="logout-modal" style="display:none;position:fixed;inset:0;z-index:10005"><div class="auth-box"><h2 style="font-size:18px;font-weight:600;margin-bottom:16px;text-align:center;color:#ff8400">Cerrar sesi√≥n</h2><p style="margin:20px 0;color:#ddd;text-align:center">¬øEst√°s seguro de que quieres cerrar sesi√≥n?</p><button class="primary" id="confirm-logout" style="width:100%;padding:10px;border-radius:6px;border:none;cursor:pointer;font-weight:600;background:#ff8400;color:#fcfaf3">Cerrar sesi√≥n</button> <button class="secondary" id="cancel-logout" style="width:100%;padding:10px;border-radius:6px;border:none;cursor:pointer;font-weight:600;background:#333;color:#fcfaf3;margin-top:8px">Cancelar</button></div></div><div class="search-button-container"><button id="communitySearchBtn" class="map-reset-button" title="Search Communities"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" stroke="#333"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-width="2" stroke-linecap="round" fill="none"/></svg></button><div id="communityCircleMenu" class="community-circle-menu"></div><button id="gpsButton" class="gps-button" title="Enable GPS" style="position:fixed;bottom:50px;right:14px;width:auto;height:auto;padding:0;background:0 0;border:none;box-shadow:none"><svg viewBox="0 0 24 24" width="18" height="18" stroke="#fff" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"/><line x1="12" y1="2" x2="12" y2="5"/><line x1="12" y1="19" x2="12" y2="22"/><line x1="2" y1="12" x2="5" y2="12"/><line x1="19" y1="12" x2="22" y2="12"/><circle cx="12" cy="12" r="4.5" fill="#fff" stroke="none"/></svg></button> <button id="cycleAvailabilityBtn" class="gps-button" title="Cycle Availability" style="bottom:320px"><svg viewBox="0 0 24 24" width="24" height="24" stroke="#333" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4L23 10 17 10"></path><path d="M1 20L1 14 7 14"></path><path d="M3.51 9a9 9 0 0114.85-3.36L23 10"></path><path d="M20.49 15a9 9 0 01-14.85 3.36L1 14"></path></svg></button> <button id="compareBtnOld" class="gps-button" title="Compare Lots" style="bottom:440px;display:none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="black" stroke-width="2.3" stroke-linecap="round" stroke-linejoin="round"><path d="M2.5 5c3.2-1.6 6.5-1.6 9.5 0v14c-3.2-1.6-6.5-1.6-9.5 0z"/><path d="M21.5 5c-3.2-1.6-6.5-1.6-9.5 0v14c3.2-1.6 6.5-1.6 9.5 0z"/></svg></button> <button id="editBtn" class="gps-button" title="Edit Button" style="bottom:380px"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 17.25V21H6.75L17.81 9.94L14.06 6.19L3 17.25ZM20.71 7.04C21.1 6.65 21.1 6.02 20.71 5.63L18.37 3.29C17.98 2.9 17.35 2.9 16.96 3.29L15.13 5.12L18.88 8.87L20.71 7.04Z" fill="currentColor"/></svg></button><script>let scene,camera,renderer,sphere,panoGroup,allTracks=new Map,currentTrackId=null,currentYaw=0,currentPitch=0,currentFov=75,viewerInitialized=!1,selectedMarbleId=null;const navGraph=new Map;let lastHopBearingDeg=null,currentImages=[],currentImageIndex=-1,preloadedImages={},viewConeMarker=null,isSwitchingTrack=!1;const FRAMES_BASE="https://la-la.land/inverta/frames/"</script><script>const btn=document.querySelector(".lalaland-button");function bounceButton(){btn&&(btn.style.animation="bounce 1s",btn.addEventListener("animationend",()=>{btn.style.animation=""},{once:!0}))}setTimeout(bounceButton,1e4),setInterval(bounceButton,18e4);const ctaToaster=document.getElementById("ctaToaster"),whatsappBtn=document.querySelector(".lalaland-button"),ctaobserver=new MutationObserver(()=>{ctaToaster.classList.contains("show")&&setTimeout(()=>{whatsappBtn.classList.add("bounce"),setTimeout(()=>{whatsappBtn.classList.remove("bounce")},600)},4e3)});ctaobserver.observe(ctaToaster,{attributes:!0,attributeFilter:["class"]})</script><script>function openInitialLotModal(){const o=window.location.hash;if(o.startsWith("#lot=")){const n=decodeURIComponent(o.slice(5)),t=lotData.find(o=>o.name===n);t&&openModal(t)}}</script><script>window.supabaseReady=new Promise((e,a)=>{const t=document.createElement("script");t.src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2",t.onload=()=>{fetch("https://la-la.land/sb_config.json").then(e=>e.json()).then(a=>{window.supabaseClient=supabase.createClient(a.url,a.key,{auth:{storageKey:`sb-${CURRENT_CLIENT}-auth`}}),console.log(`‚úÖ Supabase client initialized with config.json (storageKey: sb-${CURRENT_CLIENT}-auth)`),e(),window.skipNextRealtimeRender=window.skipNextRealtimeRender||new Set;let t=null;window.supabaseClient.channel("lots-realtime").on("postgres_changes",{event:"*",schema:"public",table:"lots",filter:`client_id=eq.${CURRENT_CLIENT}`},e=>{console.log("üì° Change detected:",e);const a=e.new?.lot_name||e.old?.lot_name,i=extractLotNumber(a),o=window.skipNextRealtimeRender.has(a);o&&console.log("‚è≠Ô∏è Skipping realtime re-render for manually cycled lot");const l=lotData.findIndex(e=>e.name===a);if(-1!==l){const a=lotData[l],t=e.new?.availability??a.availability??"Available",i="sold"!==(a.availability??"").toLowerCase(),o="sold"===t.toLowerCase();if(a.availability=t,a.featured="featured"===t.toLowerCase(),a.rSize=e.new?.rSize??a.rSize,a.millones=e.new?.millones??a.millones,map&&map.getSource("lots-final")){const e=map.getSource("lots-final"),a={type:"FeatureCollection",features:lotData.map((e,a)=>{const t=[...e.coords];return t[0][0]===t[t.length-1][0]&&t[0][1]===t[t.length-1][1]||t.push(t[0]),{type:"Feature",geometry:{type:"Polygon",coordinates:[t]},properties:{name:e.name,availability:e.availability||"Available"},id:a}})};e.setData(a)}i&&o&&"function"==typeof addSoldXs&&addSoldXs(map,[a],300)}if(window.baseLotsAll){const a=window.baseLotsAll.find(e=>e.number===i);a&&(a.availability=e.new?.availability??a.availability,a.rSize=e.new?.rSize??a.rSize,a.price=e.new?.millones??a.price)}if(baseLots){const a=baseLots.find(e=>e.number===i);a&&(a.availability=e.new?.availability??a.availability,a.rSize=e.new?.rSize??a.rSize,a.price=e.new?.millones??a.price)}!o&&document.getElementById("lotModal").classList.contains("show")&&(t&&clearTimeout(t),t=setTimeout(()=>{"undefined"!=typeof animatedFeaturedLots&&animatedFeaturedLots.clear(),render()},150))}).subscribe().catch(e=>console.error("‚ùå Realtime subscription failed:",e))}).catch(e=>{console.error("Failed to load Supabase config:",e),a(new Error("‚ùå Failed to load Supabase config"))})},t.onerror=()=>{console.error("‚ùå Failed to load Supabase script"),a(new Error("‚ùå Failed to load Supabase script"))},document.head.appendChild(t)})</script><script>(()=>{const e=e=>document.querySelector(e),o=e=>{try{window.showToaster?.(e)}catch{}},t=e("#modal-login-btn"),a=e("#modal-logout-btn"),n=e("#auth-modal"),s=e("#auth-step-email"),l=e("#auth-step-otp"),i=e("#auth-email"),r=e("#auth-otp"),d=e("#otp-email-display"),c=e("#request-otp"),u=e("#verify-otp"),p=(g="#auth-cancel",Array.from(document.querySelectorAll(g)));var g;let m="";function y(){n&&(s&&(s.style.display="block"),l&&(l.style.display="none"),i&&(i.value=""),r&&(r.value=""),n.style.display="block",setTimeout(()=>i?.focus(),0))}function w(){n&&(n.style.display="none")}function h(){m="",i&&(i.value=""),r&&(r.value=""),s&&(s.style.display="block"),l&&(l.style.display="none")}function f(o){t&&(t.style.display=o?"none":"flex"),a&&(a.style.display=o?"flex":"none");const n=e("#globe-login-btn");n&&(o?(n.classList.add("logged-in"),n.textContent="Logout",n.title="Logout"):(n.classList.remove("logged-in"),n.textContent="Login",n.title="Login"));const s=e("#dashboard-btn");s&&(s.style.display=o?"flex":"none"),window.isUserAuthenticated=o,"function"==typeof render&&(render(),"function"==typeof highlightCenter&&highlightCenter(),"function"==typeof updateScrollbar&&updateScrollbar())}const b=e("#logout-modal"),L=e("#confirm-logout"),v=e("#cancel-logout");function _(){b&&(b.style.display="none")}L&&L.addEventListener("click",async()=>{try{await(window.supabaseClient?.auth.signOut()),f(!1),_(),o("Sesi√≥n cerrada.")}catch(e){console.error(e),o("Error al cerrar sesi√≥n.")}}),v&&v.addEventListener("click",()=>{_()}),b&&b.addEventListener("click",e=>{e.target===b&&_()}),document.addEventListener("keydown",e=>{"Escape"===e.key&&"block"===b?.style.display&&_()}),t&&t.addEventListener("click",y);const x=e("#globe-login-btn");x&&x.addEventListener("click",async()=>{const e=(await(window.supabaseClient?.auth.getSession()))?.data?.session;!(!e||!e.user)?b&&(b.style.display="block"):y()}),window.isDashboardOpen=!1;const E=e("#dashboard-btn");E&&E.addEventListener("click",async()=>{window.isDashboardOpen;if(window.isDashboardOpen=!window.isDashboardOpen,window.isDashboardOpen&&window.compareMode){const e=document.getElementById("lotModal"),o=document.getElementById("compareBtn");o&&o.classList.remove("active"),window.compareMode=!1,window.selectedLots.clear(),"function"==typeof removeEditOutlines&&removeEditOutlines(),console.log("Compare mode OFF (opening dashboard)"),window.originalBaseLots&&(baseLots=[...window.originalBaseLots],window.originalBaseLots=null),baseLots&&baseLots.length>0&&baseLots[0].fraccionamiento?(e.dataset.fracc=baseLots[0].fraccionamiento,console.log("Reset modal.dataset.fracc to:",baseLots[0].fraccionamiento)):e.dataset.fracc="marsella"}window.isDashboardOpen?await openDashboardModal():closeModal();const o=e("#eye-open-icon"),t=e("#eye-closed-icon");o&&t&&(window.isDashboardOpen?(o.style.display="inline-block",t.style.display="none",E.classList.add("active")):(o.style.display="none",t.style.display="inline-block",E.classList.remove("active")))});const S=e("#globalDashboardButton");async function C(e,t=0){if(!e||!e.user)return!1;try{const{data:a,error:n}=await window.supabaseClient.from("editors").select("id").eq("user_id",e.user.id).eq("client_id",CURRENT_CLIENT).maybeSingle();return n?(console.error("Client access validation failed:",n),!1):!!a||(t<3?(console.log(`No user_id match found (attempt ${t+1}/3). Retrying in 500ms to allow trigger to complete...`),await new Promise(e=>setTimeout(e,500)),C(e,t+1)):(console.warn(`User ${e.user.email} attempted to access unauthorized client: ${CURRENT_CLIENT}`),await window.supabaseClient.auth.signOut(),o("No tienes acceso a este cliente. Has sido desconectado."),!1))}catch(e){return console.error("Client validation error:",e),!1}}if(window.previousDashboardCommunity=null,S&&S.addEventListener("click",async()=>{if(S.classList.contains("active")){if(S.classList.remove("active"),window.previousDashboardCommunity){const e=document.getElementById("lotModal");e&&(e.dataset.fracc=window.previousDashboardCommunity)}await openDashboardModal()}else{const e=document.getElementById("lotModal");e&&e.dataset.fracc&&(window.previousDashboardCommunity=e.dataset.fracc),S.classList.add("active"),await openGlobalDashboard()}}),a&&a.addEventListener("click",async()=>{try{await(window.supabaseClient?.auth.signOut()),f(!1),o("Sesi√≥n cerrada.")}catch(e){console.error(e),o("Error al cerrar sesi√≥n.")}}),p.forEach(e=>{e.type="button",e.addEventListener("click",()=>{h(),w()})}),document.addEventListener("keydown",e=>{"Escape"===e.key&&"block"===n?.style.display&&(h(),w())}),n&&n.addEventListener("click",e=>{e.target===n&&(h(),w())}),c&&!window.__otpListenerSetup){window.__otpListenerSetup=!0;let e=0;const t=6e4;c.type="button",c.addEventListener("click",async()=>{const a=(i?.value||"").trim().toLowerCase();if(!a)return void o("Escribe tu email.");if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a))return void o("Ingresa un correo v√°lido.");const n=Date.now(),u=n-e;if(e>0&&u<t){const e=Math.ceil((t-u)/1e3);return void o(`Por favor espera ${e} segundos antes de solicitar otro c√≥digo.`)}const p=await async function(e){const{data:o,error:t}=await window.supabaseClient.from("editors").select("id").eq("email",e.trim().toLowerCase()).eq("client_id",CURRENT_CLIENT).maybeSingle();return t?(console.error("Allowlist check failed:",t),!1):!!o}(a);if(!p)return void o("Este correo no est√° autorizado.");const g=c.textContent;c.disabled=!0,c.textContent="Enviando...";try{const{error:t}=await window.supabaseClient.auth.signInWithOtp({email:a,options:{emailRedirectTo:window.location.origin}});if(t)throw t;e=n,m=a,d&&(d.textContent=a),s&&(s.style.display="none"),l&&(l.style.display="block"),setTimeout(()=>r?.focus(),0),o("C√≥digo enviado. Revisa tu correo.")}catch(t){console.error("OTP Error:",t),console.error("Error message:",t.message),console.error("Error details:",t.error_description||t.msg);const a=t.message||t.error_description||"No pudimos enviar el c√≥digo.";t.message&&t.message.includes("rate limit")?(o("Se han enviado demasiados c√≥digos. Por favor espera unos minutos e intenta de nuevo."),e=n):o(`Error: ${a}`)}finally{c.disabled=!1,c.textContent=g}})}u&&!window.__verifyOtpListenerSetup&&(window.__verifyOtpListenerSetup=!0,u.type="button",u.addEventListener("click",async()=>{const e=(r?.value||"").trim();if(6!==e.length)return void o("El c√≥digo debe tener 6 d√≠gitos.");const t=u.textContent;u.disabled=!0,u.textContent="Verificando...";try{const{data:t,error:a}=await window.supabaseClient.auth.verifyOtp({email:m,token:e,type:"email"});if(a)throw a;if(!await C(t.session))return h(),void w();h(),w(),o("Has iniciado sesi√≥n.")}catch(e){console.error(e),o("C√≥digo inv√°lido o vencido.")}finally{u.disabled=!1,u.textContent=t}}));const D=async()=>{try{const{data:{session:e}={session:null}}=await window.supabaseClient.auth.getSession();if(e&&e.user){f(await C(e))}else f(!1)}catch(e){console.warn("getSession failed:",e)}window.supabaseClient.auth.onAuthStateChange(async(e,o)=>{if(o&&o.user){f(await C(o))}else f(!1)})};if(window.supabaseReady&&"function"==typeof window.supabaseReady.then)window.supabaseReady.then(D);else{const e=setInterval(()=>{window.supabaseClient&&(clearInterval(e),D())},200)}function O(e,o){const t=o.totalLots>0?(o.availableLots/o.totalLots*100).toFixed(1):0,a=.01*o.projectedIncome,n=o.percentageChange||0,s=n>0,l=n<0,i=s?"#43bea9":l?"#f44336":"#8a8880",r=0!==n?`${s?"‚Üë":l?"‚Üì":""} ${Math.abs(n).toFixed(1)}%`:"",d=`\n      <div style="padding: 16px; display: flex; flex-direction: column; gap: 12px; height: 100%; box-sizing: border-box;">\n        \x3c!-- Lotes Disponibles --\x3e\n        <div style="background: rgba(255, 132, 0, 0.05); border-left: 4px solid #ff8400; padding: 16px; border-radius: 6px; flex: 1; display: flex; flex-direction: column; justify-content: center; min-height: 0;">\n          <div style="font-size: 12px; color: #8a8880; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">\n            Lotes Disponibles\n          </div>\n          <div style="font-size: clamp(24px, 5vw, 32px); font-weight: 700; color: #1a1a1a; line-height: 1.2; display: flex; justify-content: space-between; align-items: baseline;">\n            <div>\n              ${o.availableLots} <span style="font-size: clamp(18px, 3.5vw, 22px); color: #8a8880;">/ ${o.totalLots}</span>\n            </div>\n            <span style="font-size: clamp(14px, 3vw, 16px); color: #ff8400;">${t}%</span>\n          </div>\n        </div>\n\n        \x3c!-- Vendidos en los √∫ltimos 30 d√≠as --\x3e\n        <div style="background: rgba(67, 190, 169, 0.05); border-left: 4px solid #43bea9; padding: 16px; border-radius: 6px; flex: 1; display: flex; flex-direction: column; justify-content: center; min-height: 0;">\n          <div style="font-size: 12px; color: #8a8880; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">\n            Vendidos en los √∫ltimos 30 d√≠as\n          </div>\n          <div style="font-size: clamp(24px, 5vw, 32px); font-weight: 700; color: #43bea9; line-height: 1.2;">\n            ${o.soldLast30Days}\n            ${r?`<span style="font-size: clamp(14px, 3vw, 16px); color: ${i}; margin-left: 8px;">${r}</span>`:""}\n          </div>\n        </div>\n\n        \x3c!-- Ingresos Proyectados --\x3e\n        <div style="background: rgba(82, 82, 82, 0.05); border-left: 4px solid #525252; padding: 16px; border-radius: 6px; flex: 1; display: flex; flex-direction: column; justify-content: center; min-height: 0;">\n          <div style="font-size: 12px; color: #8a8880; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">\n            Ingresos Proyectados\n          </div>\n          <div style="font-size: clamp(24px, 5vw, 30px); font-weight: 700; color: #525252; line-height: 1.2; display: flex; justify-content: space-between; align-items: baseline;">\n            <div>\n              $${o.projectedIncome.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}\n              <span style="font-size: clamp(12px, 2.5vw, 16px); vertical-align: super; font-weight: 600; color: #8a8880;">MXN</span>\n            </div>\n            <span style="font-size: clamp(14px, 3vw, 16px); color: #525252;">$${a.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}</span>\n          </div>\n          <div style="font-size: 10px; color: #8a8880; margin-top: 4px; display: flex; justify-content: space-between; align-items: center;">\n            <span>Basado en ${o.availableLots} lotes disponibles</span>\n            <span>Comisiones disponibles</span>\n          </div>\n        </div>\n      </div>\n    `;e.innerHTML=d,e.classList.add("active")}window.openDashboardModal=async function(){await window.supabaseReady;const e=document.getElementById("lotModal"),o=document.getElementById("lotDetails"),t=document.getElementById("modalInfo"),a=document.getElementById("headerFracc"),n=document.getElementById("headerLotNumber"),s=document.querySelector(".modal-content-wrapper"),l=document.getElementById("backButton"),i=document.getElementById("customScrollbar");if(window.compareMode){const o=document.getElementById("compareBtn");o&&o.classList.remove("active"),window.compareMode=!1,window.selectedLots.clear(),"function"==typeof removeEditOutlines&&removeEditOutlines(),console.log("Compare mode OFF (opening dashboard modal)"),window.originalBaseLots&&(baseLots=[...window.originalBaseLots],window.originalBaseLots=null),baseLots&&baseLots.length>0&&baseLots[0].fraccionamiento?(e.dataset.fracc=baseLots[0].fraccionamiento,console.log("openDashboardModal: Reset modal.dataset.fracc to:",baseLots[0].fraccionamiento)):e.dataset.fracc="marsella"}const r=e?.dataset?.fracc||"marsella",d=(r||"marsella").toUpperCase();e.classList.contains("show")||(e.classList.add("show"),e.style.display="block","function"==typeof adjustMapForModal&&adjustMapForModal()),e.classList.add("info-mode"),e.classList.remove("lot-mode","pin-mode"),t&&(t.style.display="none",t.innerHTML=""),i&&(i.style.display="none"),a&&(a.textContent=d,a.contentEditable="false"),n&&(n.style.display="none"),l&&(l.style.display="none");const c=document.getElementById("poiButton");c&&(c.style.display="none");const u=document.getElementById("globalDashboardButton");u&&(u.style.display="block",u.classList.remove("active")),o&&(o.classList.remove("active"),o.innerHTML="",o.style.display="block"),s&&s.classList.add("show-details"),o.innerHTML='<div style="padding: 40px; text-align: center; color: #8a8880;">Cargando datos...</div>';try{const e=await async function(e){await window.supabaseReady,console.log("üîÑ Fetching dashboard data for",e);const o=window.supabaseClient.from("lots").select("*").eq("client_id",CURRENT_CLIENT).eq("fraccionamiento",e),t=new Promise((e,o)=>setTimeout(()=>o(new Error("Query timeout - RLS policy may be too slow or blocking")),1e4)),{data:a,error:n}=await Promise.race([o,t]);if(n){console.error("‚ùå ERROR fetching lots for dashboard:",n),console.error("‚ùå This may be an RLS (Row Level Security) policy issue."),console.error("‚ùå Error details:",{message:n.message,code:n.code,details:n.details,hint:n.hint});const{data:{session:e}}=await window.supabaseClient.auth.getSession();throw e&&e.user?(console.log("‚úÖ User IS authenticated:",e.user.email),console.error("‚ùå Query failed despite authentication - check RLS policies on lots table")):console.error("‚ùå User is NOT authenticated - this may be why the query failed"),n}console.log("‚úÖ Successfully fetched",a?.length||0,"lots for dashboard"),console.log("Fetched lots for",e,":",a?.length,"lots"),console.log("Sample lot:",a?.[0]);const s=a?.filter(e=>"sold"!==e.availability?.toLowerCase()).length||0,l=a?.length||0;let i=0,r=0;console.log("=== INGRESOS CALCULATION DEBUG ==="),console.log("Checking",a?.length,"total lots for",e),a?.forEach((e,o)=>{if("sold"!==e.availability?.toLowerCase()){const t=String(e.price||"0").replace(/[$,\s]/g,""),a=parseFloat(t)||0;a>0?(i+=a,r++,r<=5&&console.log(`Lot ${e.name||o}: $${a.toLocaleString()} (raw: "${e.price}" ‚Üí cleaned: "${t}")`)):o<3&&console.log(`‚ö†Ô∏è Lot ${e.name||o}: price is 0 or invalid (raw: "${e.price}" ‚Üí cleaned: "${t}")`)}}),console.log(`Total: ${r} lots counted, Income: $${i.toLocaleString()}`),console.log("=== END DEBUG ===");const d=new Date;d.setDate(d.getDate()-30);const c=new Date;c.setDate(c.getDate()-60),console.log("=== AUDIT DATA DEBUG FOR",e,"==="),console.log("Date range: Last 60 days from",c.toISOString()),console.log("30 days ago:",d.toISOString()),console.log("üîÑ Fetching lot_updates_audit for",e);const u=window.supabaseClient.from("lot_updates_audit").select("*").eq("fraccionamiento",e).gte("updated_at",c.toISOString()).order("updated_at",{ascending:!1}),p=new Promise((e,o)=>setTimeout(()=>o(new Error("Audit query timeout - RLS policy may be too slow or blocking")),1e4)),{data:g,error:m}=await Promise.race([u,p]);if(m){console.error("‚ùå ERROR fetching lot_updates_audit:",m),console.error("‚ùå This may be an RLS (Row Level Security) policy issue."),console.error("‚ùå Error details:",{message:m.message,code:m.code,details:m.details,hint:m.hint});const{data:{session:e}}=await window.supabaseClient.auth.getSession();e&&e.user?(console.log("‚úÖ User IS authenticated:",e.user.email),console.error("‚ùå Query failed despite authentication - check RLS policies on lot_updates_audit table")):(console.error("‚ùå User is NOT authenticated - this may be why the query failed"),console.error("‚ùå If lot_updates_audit table has RLS enabled, you need to be logged in"))}else console.log("‚úÖ Successfully fetched",g?.length||0,"audit records for",e);console.log("Total audit records fetched for",e,":",g?.length||0),console.log("Sample audit records:",g?.slice(0,3));const y=g?.filter(e=>"sold"===e.new_availability?.toLowerCase()&&"sold"!==e.old_availability?.toLowerCase()&&new Date(e.updated_at)>=d)||[],w=y.filter(e=>{const o=g?.filter(o=>o.lot_name===e.lot_name&&new Date(o.updated_at)>new Date(e.updated_at)&&"available"===o.new_availability?.toLowerCase())||[],t=0===o.length;return!t&&o.length>0&&console.log(`  ‚ùå Sale fell through for ${e.lot_name}: sold at ${e.updated_at}, became available again at ${o[0].updated_at}`),t}),h=w.length;console.log("Lots sold in LAST 30 days (initial):",y.length),console.log("Sales that fell through:",y.length-w.length),console.log("Valid sales (final count):",h),console.log("Sample sold records (last 30):",w.slice(0,3).map(e=>({lot:e.lot_name,updated:e.updated_at,old:e.old_availability,new:e.new_availability})));const f=g?.filter(e=>"sold"===e.new_availability?.toLowerCase()&&"sold"!==e.old_availability?.toLowerCase()&&new Date(e.updated_at)>=c&&new Date(e.updated_at)<d)||[],b=f.filter(e=>0===(g?.filter(o=>o.lot_name===e.lot_name&&new Date(o.updated_at)>new Date(e.updated_at)&&"available"===o.new_availability?.toLowerCase())||[]).length),L=b.length;console.log("Lots sold in PREVIOUS 30 days (initial):",f.length),console.log("Sales that fell through (prev):",f.length-b.length),console.log("Valid sales in previous period (final count):",L),console.log("Sample sold records (previous 30):",b.slice(0,3).map(e=>({lot:e.lot_name,updated:e.updated_at,old:e.old_availability,new:e.new_availability})));let v=0;L>0?v=(h-L)/L*100:h>0&&(v=100);return console.log("Percentage change calculation:"),console.log(`  Last 30 days: ${h} lots`),console.log(`  Previous 30 days: ${L} lots`),console.log(`  Change: ${v.toFixed(1)}%`),console.log("=== END AUDIT DEBUG ==="),{availableLots:s,totalLots:l,projectedIncome:i,soldLast30Days:h,percentageChange:v}}(r);console.log("Dashboard data for",r,":",e),O(o,e)}catch(e){console.error("Error loading dashboard:",e),o.innerHTML='<div style="padding: 40px; text-align: center; color: #f44336;">Error al cargar el dashboard</div>'}},window.openGlobalDashboard=async function(){const e=document.getElementById("headerFracc"),o=document.getElementById("lotDetails");e&&(e.textContent="GLOBAL"),o&&(o.innerHTML='<div style="padding: 40px; text-align: center; color: #8a8880;">Cargando datos globales...</div>');try{const e=await async function(){await window.supabaseReady,console.log("üîÑ Fetching GLOBAL dashboard data");const e=window.supabaseClient.from("lots").select("*").eq("client_id",CURRENT_CLIENT),o=new Promise((e,o)=>setTimeout(()=>o(new Error("Query timeout - RLS policy may be too slow or blocking")),1e4)),{data:t,error:a}=await Promise.race([e,o]);if(a){console.error("‚ùå ERROR fetching lots for GLOBAL dashboard:",a),console.error("‚ùå This may be an RLS (Row Level Security) policy issue."),console.error("‚ùå Error details:",{message:a.message,code:a.code,details:a.details,hint:a.hint});const{data:{session:e}}=await window.supabaseClient.auth.getSession();throw e&&e.user?(console.log("‚úÖ User IS authenticated:",e.user.email),console.error("‚ùå Query failed despite authentication - check RLS policies on lots table")):console.error("‚ùå User is NOT authenticated - this may be why the query failed"),a}console.log("‚úÖ Successfully fetched",t?.length||0,"lots for GLOBAL dashboard"),console.log("Fetched ALL lots:",t?.length,"lots");const n=t?.filter(e=>"sold"!==e.availability?.toLowerCase()).length||0,s=t?.length||0;let l=0;t?.forEach(e=>{if("sold"!==e.availability?.toLowerCase()){const o=String(e.price||"0").replace(/[$,\s]/g,""),t=parseFloat(o)||0;l+=t}}),console.log("Global projected income:",l);const i=new Date;i.setDate(i.getDate()-30);const r=new Date;r.setDate(r.getDate()-60),console.log("=== GLOBAL AUDIT DATA DEBUG ==="),console.log("Date range: Last 60 days from",r.toISOString()),console.log("30 days ago:",i.toISOString()),console.log("üîÑ Fetching GLOBAL lot_updates_audit");const d=window.supabaseClient.from("lot_updates_audit").select("*").eq("client_id",CURRENT_CLIENT).gte("updated_at",r.toISOString()).order("updated_at",{ascending:!1}),c=new Promise((e,o)=>setTimeout(()=>o(new Error("Audit query timeout - RLS policy may be too slow or blocking")),1e4)),{data:u,error:p}=await Promise.race([d,c]);if(p){console.error("‚ùå ERROR fetching GLOBAL lot_updates_audit:",p),console.error("‚ùå This may be an RLS (Row Level Security) policy issue."),console.error("‚ùå Error details:",{message:p.message,code:p.code,details:p.details,hint:p.hint});const{data:{session:e}}=await window.supabaseClient.auth.getSession();e&&e.user?(console.log("‚úÖ User IS authenticated:",e.user.email),console.error("‚ùå Query failed despite authentication - check RLS policies on lot_updates_audit table")):(console.error("‚ùå User is NOT authenticated - this may be why the query failed"),console.error("‚ùå If lot_updates_audit table has RLS enabled, you need to be logged in"))}else console.log("‚úÖ Successfully fetched",u?.length||0,"GLOBAL audit records");console.log("Total GLOBAL audit records fetched:",u?.length||0),console.log("Sample audit records:",u?.slice(0,3));const g=u?.filter(e=>"sold"===e.new_availability?.toLowerCase()&&"sold"!==e.old_availability?.toLowerCase()&&new Date(e.updated_at)>=i)||[],m=g.filter(e=>{const o=u?.filter(o=>o.lot_name===e.lot_name&&new Date(o.updated_at)>new Date(e.updated_at)&&"available"===o.new_availability?.toLowerCase())||[],t=0===o.length;return!t&&o.length>0&&console.log(`  ‚ùå Sale fell through for ${e.lot_name}: sold at ${e.updated_at}, became available again at ${o[0].updated_at}`),t}),y=m.length;console.log("GLOBAL lots sold in LAST 30 days (initial):",g.length),console.log("GLOBAL sales that fell through:",g.length-m.length),console.log("GLOBAL valid sales (final count):",y),console.log("Sample sold records (last 30):",m.slice(0,3).map(e=>({lot:e.lot_name,fracc:e.fraccionamiento,updated:e.updated_at,old:e.old_availability,new:e.new_availability})));const w=u?.filter(e=>"sold"===e.new_availability?.toLowerCase()&&"sold"!==e.old_availability?.toLowerCase()&&new Date(e.updated_at)>=r&&new Date(e.updated_at)<i)||[],h=w.filter(e=>0===(u?.filter(o=>o.lot_name===e.lot_name&&new Date(o.updated_at)>new Date(e.updated_at)&&"available"===o.new_availability?.toLowerCase())||[]).length),f=h.length;console.log("GLOBAL lots sold in PREVIOUS 30 days (initial):",w.length),console.log("GLOBAL sales that fell through (prev):",w.length-h.length),console.log("GLOBAL valid sales in previous period (final count):",f),console.log("Sample sold records (previous 30):",h.slice(0,3).map(e=>({lot:e.lot_name,fracc:e.fraccionamiento,updated:e.updated_at,old:e.old_availability,new:e.new_availability})));let b=0;return f>0?b=(y-f)/f*100:y>0&&(b=100),console.log("GLOBAL percentage change calculation:"),console.log(`  Last 30 days: ${y} lots`),console.log(`  Previous 30 days: ${f} lots`),console.log(`  Change: ${b.toFixed(1)}%`),console.log("=== END GLOBAL AUDIT DEBUG ==="),{availableLots:n,totalLots:s,projectedIncome:l,soldLast30Days:y,percentageChange:b}}();console.log("Global dashboard data:",e),O(o,e)}catch(e){console.error("Error loading global dashboard:",e),o.innerHTML='<div style="padding: 40px; text-align: center; color: #f44336;">Error al cargar el dashboard global</div>'}}})()</script><script>let map,lotData=[];window.hoveredId=null;let currentLotIndex=-1,sideLengthLabels=[],currentLabeledLot=null,isDetailOpen=!1,lastOpenedBaseIndex=null;function addSideLengthLabels(e){removeSideLengthLabels(),currentLabeledLot=e;const t=[...e.coords];t.length<3||(t[0][0]===t[t.length-1][0]&&t[0][1]===t[t.length-1][1]||t.push(t[0]),t.forEach((e,o)=>{o>=t.length-1||setTimeout(()=>{const e=t[o],a=t[o+1],n=[(e[0]+a[0])/2,(e[1]+a[1])/2],l=turf.distance(turf.point(e),turf.point(a),{units:"meters"}),i=Math.round(2*l)/2,s=document.createElement("div");s.className="side-length-label",s.innerHTML=`${i}<span translate="no">m</span>`,s.style.position="absolute";const d=map.project(n);s.style.left=`${d.x}px`,s.style.top=`${d.y}px`,s.style.transform="translate(-50%, -50%) scale(0.4)",s.style.opacity="0",s.style.transform="scale(0.4)",s.style.animation="pop-in 0.35s cubic-bezier(0.25, 1.25, 0.5, 1) forwards",document.getElementById("map").appendChild(s),requestAnimationFrame(()=>s.style.opacity="1"),sideLengthLabels.push(s)},200*o)}),map.on("move",updateSideLengthPositions))}function updateSideLengthPositions(){if(!currentLabeledLot||0===sideLengthLabels.length)return;const e=[...currentLabeledLot.coords];if(e[0][0]===e[e.length-1][0]&&e[0][1]===e[e.length-1][1]||e.push(e[0]),sideLengthLabels.length!==e.length-1)return removeSideLengthLabels(),void addSideLengthLabels(currentLabeledLot);for(let t=0;t<e.length-1;t++){const o=e[t],a=e[t+1],n=[(o[0]+a[0])/2,(o[1]+a[1])/2],l=map.project(n);sideLengthLabels[t].style.left=`${l.x}px`,sideLengthLabels[t].style.top=`${l.y}px`}}function removeSideLengthLabels(){sideLengthLabels.forEach(e=>{e&&e.parentNode&&e.parentNode.removeChild(e)}),sideLengthLabels=[],currentLabeledLot=null,map.off("move",updateSideLengthPositions);document.querySelectorAll(".side-length-label").forEach(e=>{e.parentNode&&e.parentNode.removeChild(e)})}window.isUserAuthenticated=!1,fetch("https://la-la.land/mapbox.txt").then(e=>e.text()).then(e=>{mapboxgl.accessToken=e.trim();const t=new mapboxgl.LngLatBounds;t.extend([-100.16483,25.457155]),t.extend([-100.154874,25.467111]),t.extend([-100.183685,25.433407]),t.extend([-100.173731,25.443361]);const o=new mapboxgl.Map({container:"map",style:"mapbox://styles/mapbox/satellite-streets-v12",center:[-96.038183,19.047528],zoom:16.4});window.map=o,map=o,map.doubleClickZoom.disable(),map.on("load",async()=>{await loadRoad(map,async()=>{await loadLotsAsync(map),await window.supabaseReady,await enrichLotsWithAvailability(),animateLots(map,()=>{["drone","agora"].forEach(e=>addCustomImage(map,e)),addFeaturedLotsLayer(map,()=>{!function(){const e=document.getElementById("communitySearchBtn"),t=document.getElementById("communityCircleMenu"),o={barcelona:{center:[-96.035272,19.046439],zoom:16.2,fracc:"barcelona",name:"Barcelona"},marsella:{center:[-96.038183,19.047528],zoom:16.4,fracc:"marsella",name:"Marsella"}};let a=!1;e.addEventListener("click",function(e){e.stopPropagation(),a=!a,t.classList.toggle("active",a)}),document.querySelectorAll(".community-option").forEach(e=>{e.addEventListener("click",function(e){e.stopPropagation();const n=this.dataset.community;if(o[n]){const e=o[n];map.flyTo({center:e.center,zoom:e.zoom,speed:1.2,curve:1.5});const t=document.getElementById("lotModal");t&&t.classList.contains("show")&&(t.dataset.fracc=e.fracc,"function"==typeof window.resetUnitButtons&&window.resetUnitButtons()),showToaster(`Navegando a ${e.name}`)}a=!1,t.classList.remove("active")})}),document.addEventListener("click",function(){a=!1,t.classList.remove("active")}),t.addEventListener("click",function(e){e.stopPropagation()})}(),map.addSource("marbles",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),map.addLayer({id:"marbles-layer",type:"circle",source:"marbles",paint:{"circle-radius":["case",["==",["get","isSelected"],!0],6,["==",["get","hasImage"],!0],2,3],"circle-color":["case",["==",["get","isSelected"],!0],"#ff8400",["==",["get","hasImage"],!0],"rgba(52, 168, 83, 0)","#8B4513"],"circle-stroke-width":["case",["==",["get","isSelected"],!0],0,["==",["get","hasImage"],!0],1,0],"circle-stroke-color":"#FFFFFF"}}),map.addLayer({id:"marbles-click-layer",type:"circle",source:"marbles",paint:{"circle-radius":8,"circle-opacity":0,"circle-stroke-width":0}}),initConeSystem(),console.log("Initializing 360 viewer system..."),initializeViewer(),setupMapInteractions();let e=!1;map.on("dragstart",()=>{e=!0}),map.on("dragend",()=>{e=!1;map.getZoom()<18.8&&currentLabeledLot&&removeSideLengthLabels()}),map.on("moveend",()=>{if(!e){map.getZoom()<18.8&&currentLabeledLot&&removeSideLengthLabels()}}),map.on("click","lots-final-click",e=>{if(e.features.length>0){const t=lotData.find(t=>t.name===e.features[0].properties.name);currentLabeledLot&&removeSideLengthLabels();map.getZoom()>=18.8&&t&&addSideLengthLabels(t)}}),map.on("click",e=>{if(e.originalEvent?.target.closest("#lotModal"))return;const t=map.queryRenderedFeatures(e.point,{layers:["lots-final-click"]}),o=map.queryRenderedFeatures(e.point,{layers:["marbles-click-layer"]});if(t.length>0&&document.getElementById("lotModal").classList.contains("pin-mode")){const e=t[0].properties.name,o=lotData.find(t=>t.name===e);if(o)return document.getElementById("lotModal").classList.remove("pin-mode"),void openModal(o)}const a=document.getElementById("lotModal");if(t.length>0&&a.classList.contains("info-mode")&&window.isDashboardOpen){const e=t[0].properties.name,o=lotData.find(t=>t.name===e);if(o){window.skipNextMapPan=!0;const e=document.getElementById("dashboard-btn"),t=document.getElementById("eye-open-icon"),n=document.getElementById("eye-closed-icon");e&&(e.classList.remove("active"),t&&(t.style.display="none"),n&&(n.style.display="inline-block")),window.isDashboardOpen=!1;const l=document.getElementById("globalDashboardButton");l&&(console.log("  Removing GLOBAL button active state"),l.classList.remove("active"));const i=document.getElementById("lotDetails");i&&(console.log("  Clearing dashboard content"),i.classList.remove("active"),i.innerHTML="");const s=document.getElementById("modalInfo");return s&&(console.log("  Clearing modalInfo"),s.innerHTML="",s.style.display="",s.style.opacity="1"),console.log("  Removing info-mode and opening lot modal"),a.classList.remove("info-mode"),a.classList.remove("show"),console.log("  Temporarily hiding modal to force reset"),void setTimeout(()=>{console.log("  Now opening lot list modal (skipping pan - already positioned)"),openModal(o,0,!0)},10)}}0!==t.length||0!==o.length||window.poiModeActive||closeModal()}),map.addLayer({id:"lots-hover-outline",type:"line",source:"lots-final",paint:{"line-color":"#fff","line-width":3,"line-opacity":["case",["boolean",["feature-state","hover"],!1],1,0]}}),console.log("Ready to open initial modal, lotData:",lotData),openInitialLotModal(),map.on("mousemove","lots-final-click",e=>{document.getElementById("lotModal").classList.contains("show")||(null!==window.hoveredId&&map.setFeatureState({source:"lots-final",id:window.hoveredId},{hover:!1}),e.features.length>0&&(window.hoveredId=e.features[0].id,map.setFeatureState({source:"lots-final",id:window.hoveredId},{hover:!0})))}),map.on("mouseleave","lots-final-click",()=>{document.getElementById("lotModal").classList.contains("show")||(null!==window.hoveredId&&map.setFeatureState({source:"lots-final",id:window.hoveredId},{hover:!1}),window.hoveredId=null)}),map.on("click","lots-final-click",e=>{if(0===e.features.length)return;const t=document.getElementById("lotModal");if(t.classList.contains("viewer-mode")){const t=e.features[0].properties.name,o=lotData.find(e=>e.name===t);let a=null;return o&&(a=baseLots.findIndex(e=>e.number===extractLotNumber(o.name)),-1!==a||isDataLoaded||(a=extractLotNumber(o.name))),close360ViewerInModal(a),e.preventDefault(),void e.originalEvent.stopPropagation()}if(handleEditClick(e))return;const o=e.features[0].properties.name,a=lotData.find(e=>e.name===o);if(!a)return;const n=t.classList.contains("info-mode")&&window.isDetailOpen;lotData.forEach((e,t)=>{map.removeFeatureState({source:"lots-final",id:t},"hover")}),window.hoveredId=null;const l=lotData.findIndex(e=>e.name===a.name);if(-1!==l&&(map.setFeatureState({source:"lots-final",id:l},{hover:!0}),window.hoveredId=l,currentLotIndex=l,map.triggerRepaint()),removeSideLengthLabels(),n){const e=baseLots.findIndex(e=>e.number===extractLotNumber(a.name));-1!==e&&showDetailViewForLot(e+cloneCount,!0)}else openModal(a);map.getZoom()>=18.8&&addSideLengthLabels(a),e.preventDefault(),e.originalEvent.stopPropagation()}),window.__LL_PINS__?._revealMarkers&&(console.log("Revealing photo pins LAST after everything else"),window.__LL_PINS__._revealMarkers())})}),map.addLayer({id:"lots-hover-outline",type:"line",source:"lots-final",paint:{"line-color":"#ff8400","line-width":3,"line-opacity":["case",["boolean",["feature-state","hover"],!1],1,0]}}),console.log("Ready to open initial modal, lotData:",lotData),openInitialLotModal(),map.on("mousemove","lots-final-click",e=>{document.getElementById("lotModal").classList.contains("show")||(null!==window.hoveredId&&map.setFeatureState({source:"lots-final",id:window.hoveredId},{hover:!1}),e.features.length>0&&(window.hoveredId=e.features[0].id,map.setFeatureState({source:"lots-final",id:window.hoveredId},{hover:!0})))}),map.on("mouseleave","lots-final-click",()=>{document.getElementById("lotModal").classList.contains("show")||(null!==window.hoveredId&&map.setFeatureState({source:"lots-final",id:window.hoveredId},{hover:!1}),window.hoveredId=null)})})})})</script><script>const roadGeojson={type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"LineString",coordinates:[[-100.157757,25.45803],[-100.157888,25.458456],[-100.158984,25.45995],[-100.15855,25.460763],[-100.158634,25.461454],[-100.158488,25.462755],[-100.15872,25.463296],[-100.16009,25.465042],[-100.161556,25.464865],[-100.163154,25.465748],[-100.164051,25.465707],[-100.165586,25.466227],[-100.165558,25.466294],[-100.164039,25.46578],[-100.163133,25.465821],[-100.161538,25.46494],[-100.160053,25.465119],[-100.158649,25.463331],[-100.158407,25.462765],[-100.158554,25.461455],[-100.158468,25.46075],[-100.158893,25.459956],[-100.157814,25.458486],[-100.15768,25.458049]]}}]};function loadRoad(e,o){e.addSource("road",{type:"geojson",data:roadGeojson}),e.addLayer({id:"road",type:"line",source:"road",paint:{"line-color":"#fff","line-width":1,"line-opacity":0}});let t=null;requestAnimationFrame(function a(n){t||(t=n);let i=Math.min((n-t)/500,1);e.setPaintProperty("road","line-opacity",i),i<1?requestAnimationFrame(a):o()})}</script><script>function loadLotsAsync(t){return fetch("https://la-la.land/inverta/lots.txt").then(t=>t.text()).then(t=>{lotData=parseLots(t)})}function parseLots(t){const o=t.trim().split("\n"),e=[];let n=null;return o.forEach(t=>{if(t=t.trim())if(t.startsWith("{")){const o=t.match(/lat:\s*([0-9.\-]+),\s*lng:\s*([0-9.\-]+)/);o&&n&&n.coords.push([+o[2],+o[1]])}else n&&e.push(n),n={name:t,coords:[]}}),n&&e.push(n),e.forEach(t=>{try{const o=turf.polygon([[...t.coords,t.coords[0]]]),e=turf.centroid(o).geometry.coordinates;t.center=e}catch(o){console.warn("Failed to calculate center for",t.name,o),t.center=[0,0]}}),e}</script><script>async function enrichLotsWithAvailability(){if(!lotData||0===lotData.length)return void console.warn("lotData is empty, cannot enrich availability");if(!window.supabaseClient)return void console.error("Supabase client not initialized yet.");const e=lotData.map(e=>e.name);console.log("üîÑ Fetching lot availability from Supabase for",e.length,"lots");const o=window.supabaseClient.from("lots").select("lot_name, availability, rSize, millones, fraccionamiento, price_m2").in("lot_name",e).eq("client_id",CURRENT_CLIENT),a=new Promise((e,o)=>setTimeout(()=>o(new Error("Query timeout - RLS policy may be too slow or blocking")),1e4)),{data:i,error:t}=await Promise.race([o,a]);if(t){console.error("‚ùå ERROR fetching lot availability from Supabase:",t),console.error("‚ùå This may be an RLS (Row Level Security) policy issue."),console.error("‚ùå Error details:",{message:t.message,code:t.code,details:t.details,hint:t.hint});const{data:{session:e}}=await window.supabaseClient.auth.getSession();return void(e&&e.user?(console.log("‚úÖ User IS authenticated:",e.user.email),console.error("‚ùå Query failed despite authentication - check RLS policies on lots table")):(console.error("‚ùå User is NOT authenticated - this may be why the query failed"),console.error("‚ùå If lots table has RLS enabled, you need to be logged in to view data")))}console.log("‚úÖ Successfully fetched",i?.length||0,"lots from Supabase"),i&&i.length>0?(i.forEach(e=>{const o=lotData.find(o=>o.name===e.lot_name);if(o){const a=e.availability??"Available";o.availability=a,o.featured="featured"===a.toLowerCase(),o.rSize=e.rSize,o.millones=e.millones,o.fraccionamiento=e.fraccionamiento,o.price_m2=e.price_m2,o.priceM2=e.price_m2}}),console.log("Lot data enriched with availability and fraccionamiento:",lotData)):console.warn("No availability data returned for lots")}</script><script>function addSoldXs(e,t,o=500){e.getSource("sold-x")||(e.addSource("sold-x",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),e.addLayer({id:"sold-x-layer",type:"line",source:"sold-x",layout:{},paint:{"line-color":"white","line-width":1,"line-opacity":0,"line-opacity-transition":{duration:o}}}));const n=t.flatMap(makeXFeatures),r=e.getSource("sold-x"),a=[...r._data?.features||[],...n];r.setData({type:"FeatureCollection",features:a}),setTimeout(()=>{e.setPaintProperty("sold-x-layer","line-opacity",.49)},10)}function makeXFeatures(e){const t=e.coords;if(!t||t.length<3)return[];t[0][0]===t[t.length-1][0]&&t[0][1]===t[t.length-1][1]&&t.pop();if(4===t.length)return[{type:"Feature",properties:{lotName:e.name},geometry:{type:"LineString",coordinates:[t[0],t[2]]}},{type:"Feature",properties:{lotName:e.name},geometry:{type:"LineString",coordinates:[t[1],t[3]]}}];function o(e,t){const o=t[0]-e[0],n=t[1]-e[1];return Math.sqrt(o*o+n*n)}let n=0,r=[],a=0,i=[];for(let e=0;e<t.length;e++)for(let l=e+1;l<t.length;l++){const s=o(t[e],t[l]);s>n?(a=n,i=[...r],n=s,r=[t[e],t[l]]):s>a&&(a=s,i=[t[e],t[l]])}const l=38e-6;function s(e,t,n){return o(e,t)<l||o(e,n)<l}let u=0,p=[];for(let e=0;e<t.length;e++)for(let n=e+1;n<t.length;n++){if(t[e]===r[0]||t[e]===r[1]||t[n]===r[0]||t[n]===r[1])continue;if(s(t[e],r[0],r[1])||s(t[n],r[0],r[1]))continue;const a=o(t[e],t[n]);a>u&&(u=a,p=[t[e],t[n]])}const c=[{type:"Feature",properties:{lotName:e.name},geometry:{type:"LineString",coordinates:r}}];return 2===p.length&&c.push({type:"Feature",properties:{lotName:e.name},geometry:{type:"LineString",coordinates:p}}),c}</script><script>function animateLots(t,i){const o=500,e=[...Array(lotData.length).keys()];shuffle(e);const l=Array.from({length:20},()=>[]);e.forEach((t,i)=>l[i%20].push(t)),l.forEach((i,e)=>{const l={type:"FeatureCollection",features:i.map(t=>lotFeature(lotData[t],t))};t.addSource(`lot-group-${e}`,{type:"geojson",data:l}),t.addLayer({id:`lot-group-${e}-available`,type:"line",source:`lot-group-${e}`,paint:{"line-color":"#fff","line-width":1,"line-opacity":0,"line-opacity-transition":{duration:o}},filter:["!=",["get","availability"],"Sold"]}),t.addLayer({id:`lot-group-${e}-sold`,type:"line",source:`lot-group-${e}`,paint:{"line-color":"#fff","line-width":1,"line-opacity":0,"line-opacity-transition":{duration:o}},filter:["==",["get","availability"],"Sold"]}),setTimeout(()=>{t.setPaintProperty(`lot-group-${e}-available`,"line-opacity",1),t.setPaintProperty(`lot-group-${e}-sold`,"line-opacity",.24);const o=i.map(t=>lotData[t]).filter(t=>"sold"===(t.availability??"").toLowerCase());o.length>0&&addSoldXs(t,o,1500)},80*e)});const a={type:"FeatureCollection",features:lotData.map((t,i)=>lotFeature(t,i))};t.addSource("lots-final",{type:"geojson",data:a}),t.addLayer({id:"lots-final-available",type:"line",source:"lots-final",layout:{visibility:"visible"},paint:{"line-color":"#fff","line-width":1.5,"line-opacity":0,"line-opacity-transition":{duration:o}},filter:["!=",["get","availability"],"Sold"]}),t.addLayer({id:"lots-final-sold",type:"line",source:"lots-final",layout:{visibility:"visible"},paint:{"line-color":"#fff","line-width":1,"line-opacity":0,"line-opacity-transition":{duration:o}},filter:["==",["get","availability"],"Sold"]}),t.addLayer({id:"lots-final-click",type:"fill",source:"lots-final",layout:{visibility:"visible"},paint:{"fill-color":"#000","fill-opacity":0}}),setTimeout(()=>{t.setPaintProperty("lots-final-available","line-opacity",1),t.setPaintProperty("lots-final-sold","line-opacity",.25),setTimeout(()=>{l.forEach((i,o)=>{const e=`lot-group-${o}-available`,l=`lot-group-${o}-sold`;t.getLayer(e)&&t.setPaintProperty(e,"line-opacity",0),t.getLayer(l)&&t.setPaintProperty(l,"line-opacity",0)}),setTimeout(()=>{t.setPaintProperty("lots-final-sold","line-opacity",.49),l.forEach((i,o)=>{const e=`lot-group-${o}-available`,l=`lot-group-${o}-sold`,a=`lot-group-${o}`;t.getLayer(e)&&t.removeLayer(e),t.getLayer(l)&&t.removeLayer(l),t.getSource(a)&&t.removeSource(a)}),i&&i()},o)},700)},1850)}function lotFeature(t,i){const o=[...t.coords];return o[0][0]===o[o.length-1][0]&&o[0][1]===o[o.length-1][1]||o.push(o[0]),{type:"Feature",geometry:{type:"Polygon",coordinates:[o]},properties:{name:t.name,availability:t.availability||"Available"},id:i}}function shuffle(t){for(let i=t.length-1;i>0;i--){const o=Math.floor(Math.random()*(i+1));[t[i],t[o]]=[t[o],t[i]]}}</script><script>function addCustomImage(e){const t={url:"https://la-la.land/inverta/invertaearth.png",layerId:"drone-satellite-layer",sourceId:"drone-satellite",message:"Cargamos la im√°gen a√©rea m√°s actual ‚Äî (noviembre 2025)",bounds:[[-96.041238,19.0556],[-96.031988,19.055425],[-96.032264,19.042404],[-96.041515,19.04258]]};e.getLayer(t.layerId)&&e.removeLayer(t.layerId),e.getSource(t.sourceId)&&e.removeSource(t.sourceId),e.addSource(t.sourceId,{type:"image",url:t.url,coordinates:t.bounds}),e.addLayer({id:t.layerId,type:"raster",source:t.sourceId,paint:{"raster-opacity":0}},"road"),fadeInImage(e,t.layerId),showToaster(t.message)}function showCta(e="Want more info about this lot?",t=5e3){const a=document.getElementById("ctaToaster");a.classList.remove("hidden"),a.textContent=e,a.classList.add("show"),setTimeout(()=>{a.classList.remove("show"),setTimeout(()=>a.classList.add("hidden"),400)},t)}function fadeInImage(e,t){let a=0;const s=setInterval(()=>{a+=.05,a>=1&&(a=1,clearInterval(s)),e.setPaintProperty(t,"raster-opacity",a)},50)}function showToaster(e,t=3e3){const a=document.getElementById("toaster");a.textContent=e,a.classList.add("show"),setTimeout(()=>{a.classList.remove("show")},t)}</script><script>function featuredPolygonFeature(e){const t=[...e.coords];return(t.length<3||t[0][0]!==t[t.length-1][0]||t[0][1]!==t[t.length-1][1])&&t.push(t[0]),{type:"Feature",geometry:{type:"Polygon",coordinates:[t]},properties:{name:e.name,phase:Math.random()*Math.PI*2,opacity:.5}}}function addFeaturedLotsLayer(e,t){const a=lotData.filter(e=>e.featured);if(0===a.length)return void(t&&t());const o=a.map(featuredPolygonFeature);e.addSource("featured-lots",{type:"geojson",data:{type:"FeatureCollection",features:o}}),e.addLayer({id:"featured-lots-layer",type:"fill",source:"featured-lots",paint:{"fill-color":"#ff8400","fill-opacity":["get","opacity"]}},"lots-final-available");const r=e.getStyle().layers;let l=null;for(let e=0;e<r.length;e++)if("sold-x-layer"===r[e].id){l=r[e+1]?.id||null;break}e.addLayer({id:"featured-lots-outline",type:"line",source:"featured-lots",paint:{"line-color":"#ff8400","line-width":2,"line-opacity":1}},"lots-final-click"),startPolygonPulse(e,t)}function startPolygonPulse(e,t){let a=0,o=!1;requestAnimationFrame(function r(){a+=.05;const l=e.getSource("featured-lots");if(!l||!l._data)return;const n={...l._data,features:l._data.features.map(e=>{const t=e.properties?.phase??0,o=.3+.2*Math.sin(a+t);return{...e,properties:{...e.properties,opacity:o}}})};l.setData(n),!o&&a>=2&&(o=!0,t&&"function"==typeof t&&t()),requestAnimationFrame(r)})}</script><script>let lastOffset=[0,0];function adjustMapForModal(){if(!map)return void console.error("Map not initialized");if(window.skipNextMapPan)return console.log("‚è≠Ô∏è Skipping map pan (skipNextMapPan flag set)"),void(window.skipNextMapPan=!1);const e=window.innerWidth<768?[0,.23*-window.innerHeight]:[-240,0];lastOffset=e,console.log("üîÑ map.panBy:",e),map.panBy(e,{duration:400})}const modal=document.getElementById("lotModal"),modalInfo=document.getElementById("modalInfo"),customScrollbar=document.getElementById("customScrollbar"),customScrollthumb=document.getElementById("customScrollthumb"),loadingSpinner=document.getElementById("loadingSpinner"),lotDetails=document.getElementById("lotDetails"),backButton=document.getElementById("backButton"),detailNumber=document.getElementById("detailNumber"),detailSize=document.getElementById("detailSize"),detailPrice=document.getElementById("detailPrice"),detailAvailability=document.getElementById("detailAvailability"),headerLotNumber=document.getElementById("headerLotNumber");let infiniteScrollUpdater=null,infoScrollUpdater=null;function enableInfiniteScrollbar(){console.log("Enabling INFINITE scrollbar");const e=document.getElementById("modalInfo"),t=document.getElementById("customScrollbar"),n=document.getElementById("customScrollthumb");disableInfoScrollbar(),infiniteScrollUpdater&&disableInfiniteScrollbar();const o=()=>{if(!e||0===baseLots.length)return;const t=e.clientHeight,o=e.scrollHeight,a=e.scrollTop;if(0===o)return n.style.height="0px",void(n.style.transform="translateY(0)");const l=o/lots.length,i=l*cloneCount,s=l*baseLots.length,r=Math.max(20,t/o*t);n.style.height=`${r}px`;let d=(a-i)%s;d<0&&(d+=s),d=Math.min(d,s-t);const c=d/(s-t)*(t-r);n.style.transform=`translateY(${c}px)`};infiniteScrollUpdater=o,t.style.display="",o(),e.removeEventListener("scroll",handleScroll),e.addEventListener("scroll",handleScroll),window.addEventListener("resize",o)}function disableInfiniteScrollbar(){console.log("Disabling INFINITE scrollbar");const e=document.getElementById("modalInfo");infiniteScrollUpdater&&(e.removeEventListener("scroll",handleScroll),window.removeEventListener("resize",infiniteScrollUpdater),infiniteScrollUpdater=null)}function enableInfoScrollbar(){console.log("Enabling INFO scrollbar");const e=document.getElementById("modalInfo"),t=document.getElementById("customScrollbar"),n=document.getElementById("customScrollthumb");disableInfiniteScrollbar(),infoScrollUpdater&&disableInfoScrollbar();const o=()=>{if(!e)return;const t=e.scrollHeight,o=e.clientHeight,a=e.scrollTop;if(t<=o)return n.style.height="0px",void(n.style.transform="translateY(0)");const l=Math.max(20,o/t*o),i=a/(t-o)*(o-l);n.style.height=`${l}px`,n.style.transform=`translateY(${i}px)`};infoScrollUpdater=o,t.style.display="",o(),e.removeEventListener("scroll",o),e.addEventListener("scroll",o),window.addEventListener("resize",o)}function disableInfoScrollbar(){console.log("Disabling INFO scrollbar");const e=document.getElementById("modalInfo");infoScrollUpdater&&(e.removeEventListener("scroll",infoScrollUpdater),window.removeEventListener("resize",infoScrollUpdater),infoScrollUpdater=null)}let scrollTimeout,cloneCount=5,baseLots=[],lots=[],isDataLoaded=!1,previousMapView=null,preModalView=null,isDragging=!1,isScrollbarDragging=!1,dragStartY=0,dragStartScroll=0,scrollHandlerAttached=!0,clampCooldown=!1,infoMode=!1;function extractLotNumber(e){return e.replace(/^lotinverta/i,"").replace(/^lot/i,"").replace(/^inverta/i,"")}async function fetchLots(){try{loadingSpinner.style.display="block",modalInfo.style.opacity="0.5",await window.supabaseReady,console.log("üîÑ Fetching lots data for modal from Supabase...");const e=window.supabaseClient.from("lots").select("lot_name, rSize, millones, availability, fraccionamiento, nickname, subtitle, image, price_m2").eq("client_id",CURRENT_CLIENT).order("lot_name",{ascending:!0}),t=new Promise((e,t)=>setTimeout(()=>t(new Error("Query timeout - RLS policy may be too slow or blocking")),1e4)),{data:n,error:o}=await Promise.race([e,t]);if(o){console.error("‚ùå ERROR fetching lots for modal:",o),console.error("‚ùå This may be an RLS (Row Level Security) policy issue."),console.error("‚ùå Error details:",{message:o.message,code:o.code,details:o.details,hint:o.hint});const{data:{session:e}}=await window.supabaseClient.auth.getSession();throw e&&e.user?(console.log("‚úÖ User IS authenticated:",e.user.email),console.error("‚ùå Query failed despite authentication - check RLS policies on lots table")):(console.error("‚ùå User is NOT authenticated - this may be why the query failed"),console.error("‚ùå If lots table has RLS enabled, you need to be logged in to view data")),o}console.log("‚úÖ Successfully fetched",n?.length||0,"lots for modal"),baseLots=n.map(e=>({number:extractLotNumber(e.lot_name),size:e.rSize,price:e.millones,availability:e.availability,fraccionamiento:e.fraccionamiento,priceM2:e.price_m2,detailData:{nickname:e.nickname,subtitle:e.subtitle,image:e.image}})),window.baseLotsAll=baseLots.slice(),updateLotsArray(),isDataLoaded=!0,console.log("‚úÖ Pre-loaded all lots + images")}catch(e){console.error("Error fetching lots:",e),baseLots=Array.from({length:10},(e,t)=>({number:100+t,size:"150",price:"1.5",availability:"available",detailData:{nickname:`Lot ${100+t}`,image:"https://via.placeholder.com/800x400?text=No+Image"}})),updateLotsArray()}finally{loadingSpinner.style.display="none",modalInfo.style.opacity="1"}}function updateLotsArray(){lots=[...baseLots.slice(-cloneCount).map(e=>({...e,clone:!0})),...baseLots,...baseLots.slice(0,cloneCount).map(e=>({...e,clone:!0}))]}function setupLotClickHandlers(){document.querySelectorAll(".info-row").forEach(e=>{e.addEventListener("click",async t=>{if(t.target.closest(".row-action-btn"))return;const n=document.querySelector('[contenteditable="true"]');if(n)return n.blur(),void await new Promise(e=>setTimeout(e,50));const o=e.dataset.index,a=lots[o],l=(a.availability??"").toLowerCase();if("sold"!==l){if(isDetailOpen){map&&map.getCenter&&(previousMapView={center:map.getCenter().toArray(),zoom:map.getZoom(),bearing:map.getBearing(),pitch:map.getPitch()});const e=a.number,n=lotData.findIndex(t=>extractLotNumber(t.name)===e);if(-1!==n&&lotData[n].center&&map){const[e,t]=lotData[n].center;currentLotIndex=n,await new Promise(n=>{map.once("moveend",n);const o=window.innerWidth>=768,a=o?310:0,l=o?0:180;map.easeTo({center:[e,t],zoom:18.8,speed:1.2,curve:1.5,offset:[a,l]})}),showDetailViewForLot(o,!0)}else showDetailViewForLot(o,!0);return void t.stopPropagation()}if("featured"===l||"available"===l){map&&map.getCenter&&(preModalView={center:map.getCenter().toArray(),zoom:map.getZoom(),bearing:map.getBearing(),pitch:map.getPitch()});const e=a.number,t=lotData.findIndex(t=>extractLotNumber(t.name)===e);if(-1!==t&&lotData[t].center&&map){previousMapView={center:map.getCenter().toArray(),zoom:map.getZoom(),bearing:map.getBearing(),pitch:map.getPitch()};const[e,n]=lotData[t].center;currentLotIndex=t,await new Promise(t=>{map.once("moveend",t);const o=window.innerWidth>=768,a=o?310:0,l=o?0:180;map.easeTo({center:[e,n],zoom:18.8,speed:1.2,curve:1.5,offset:[a,l]})}),showDetailViewForLot(o)}else showDetailViewForLot(o)}t.stopPropagation()}})})}async function showDetailViewForLot(e,t=!1){window.skipNextRealtimeRender&&window.skipNextRealtimeRender.clear();const n=document.getElementById("dashboard-btn"),o=document.getElementById("eye-open-icon"),a=document.getElementById("eye-closed-icon");n&&(n.classList.remove("active"),o&&(o.style.display="none"),a&&(a.style.display="inline-block")),window.isDashboardOpen=!1;const l=document.getElementById("lotModal"),i=document.getElementById("lotDetails"),s=document.getElementById("calendlyEmbed"),r=document.querySelector(".modal-content-wrapper"),d=document.querySelector(".bottom-plus-button"),c=document.querySelector(".plus-button"),m=document.getElementById("backButton"),u=document.querySelector(".plus-button");u&&(u.style.display="none"),document.getElementById("authControls").classList.add("hide-in-detail");const p=lots?.[e];if(!p)return;const g=String(p.availability||"").toLowerCase();if("sold"===g)return;const y=Array.isArray(lotData)?lotData.find(e=>extractLotNumber(e.name)===p.number):null,f=p.detailData||{};window.isDetailOpen=!0,s&&(s.style.display="none");const h=document.getElementById("shareButton");h&&(h.style.display="block");const w=document.getElementById("poiButton");w&&(w.style.display="none",window.poiModeActive&&"undefined"!=typeof PS&&"function"==typeof PS.toggleAddMode&&PS.toggleAddMode());const b=document.getElementById("globalDashboardButton");b&&(b.style.display="none"),i.classList.remove("active"),i.innerHTML="",t&&"function"==typeof removeSideLengthLabels&&currentLabeledLot&&removeSideLengthLabels(),l.classList.remove("pin-mode","lot-mode"),l.classList.add("info-mode"),d&&(d.style.display=""),c&&(c.style.display=""),m&&(m.style.display="flex");const v=document.createElement("div");v.className="detail-container";const L=document.createElement("div");L.className="detail-header";const I=f.nickname||"",S=f.subtitle||y?.subtitle||"",E="featured"===g;L.innerHTML=`\n    <div class="tag-row">\n      ${E?'<div class="featured-tag">SELECCI√ìN LA-LA LAND</div>':""}\n      <div class="nickname">${I}</div>\n    </div>\n    ${S?`<div class="subtitle-row">${S}</div>`:""}\n  `,v.appendChild(L);const B=document.createElement("div");B.className="detail-data-row";const x=parseFloat(p.size),M=parseFloat(p.priceM2),D=x*M,C=x.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","),T=M.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","),k=D.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2});B.innerHTML=`\n  <div style="display: flex; flex-direction: column; align-items: center; gap: 8px; width: 100%;">\n    \x3c!-- Top row: Lot name on left, calculation centered --\x3e\n    <div style="display: flex; align-items: center; justify-content: center; width: 100%; position: relative;">\n      \x3c!-- Lot name on left (smaller, two rows) --\x3e\n      <div class="lot-left" style="position: absolute; left: 0; align-items: flex-end !important; text-align: right !important; transform: scale(0.75); transform-origin: left center;">\n        <div class="lote-label">MZ-L</div>\n        <div class="lote-number" style="text-align: right !important; margin-left: 0 !important;">${p.number.replace(/^[a-z]+/i,"")}</div>\n      </div>\n\n      \x3c!-- Centered calculation --\x3e\n      <div style="font-size: 24px; color: #8a8880;">\n        ${C}<span style="font-size: 60%; vertical-align: super; color: #b18d69;">M2</span>\n        <span style="margin: 0 8px;">√ó</span>\n        $${T}<span style="font-size: 60%; vertical-align: super; color: #b18d69;">/M2</span>\n      </div>\n    </div>\n\n    \x3c!-- Big total price with more space above --\x3e\n    <div style="margin-top: 20px; font-size: 48px; font-weight: 700; color: #1a1a1a;">\n      $${k}<span style="font-size: 60%; vertical-align: super; font-weight: 600; color: #b18d69;">MXN</span>\n    </div>\n    <div style="font-size: 11px; color: #8a8880; text-align: right; width: 100%; margin-top: -8px;">\n      Precio de contado\n    </div>\n    <div style="width: 100%; height: 1px; background: #e0e0e0; margin: 0px;"></div>\n\n    \x3c!-- Financing Calculator --\x3e\n    <div style="margin-top: 6px; width: 100%; display: flex; flex-direction: column; align-items: flex-start; gap: 6px; position: relative;">\n      \x3c!-- Row 1: Down payment % + Enganche amount --\x3e\n      <div style="display: flex; align-items: center; gap: 12px;">\n        <div style="width: 80px;">\n          <select id="downPaymentCalc" style="width: 80px; padding: 6px 10px; border: 2px solid #ff8400; border-radius: 6px; font-size: 18px; font-weight: 600; color: #8a8880; background: white; cursor: pointer; outline: none; font-family: 'Barlow Condensed', Arial, sans-serif;">\n            <option value="20">20%</option>\n            <option value="25">25%</option>\n            <option value="30">30%</option>\n            <option value="35">35%</option>\n            <option value="40">40%</option>\n            <option value="45">45%</option>\n            <option value="50">50%</option>\n          </select>\n        </div>\n        <div style="font-size: 18px; color: #8a8880;">\n          Enganche: <span id="downPaymentAmount" style="color: #8a8880;">$${(.2*D).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}</span>\n        </div>\n      </div>\n\n      \x3c!-- Row 2: Months + Monthly payment --\x3e\n      <div style="display: flex; align-items: center; gap: 12px;">\n        <div style="width: 80px;">\n          <select id="installmentsCalc" style="width: 80px; padding: 6px 10px; border: 2px solid #ff8400; border-radius: 6px; font-size: 18px; font-weight: 600; color: #8a8880; background: white; cursor: pointer; outline: none; font-family: 'Barlow Condensed', Arial, sans-serif;">\n            <option value="24">24</option>\n            <option value="36">36</option>\n            <option value="48">48</option>\n            <option value="60">60</option>\n            <option value="72" selected>72</option>\n          </select>\n        </div>\n        <div style="font-size: 18px; color: #8a8880;">\n          Mensualidades: <span style="color: #1a1a1a; font-weight: 600; font-size: 28px;"><span id="monthlyPayment" style="text-decoration: underline;">$10,315.50</span><span style="font-size: 60%; vertical-align: super; font-weight: 600; color: #b18d69;">/MES</span></span>\n        </div>\n      </div>\n\n      \x3c!-- Tasa and Precio financiado on same line --\x3e\n      <div style="width: 100%; display: flex; justify-content: space-between; margin-top: -4px; font-size: 11px; color: #8a8880;">\n        <div style="width: 80px; text-align: center;">\n          <span>Tasa <span id="financingRate">17</span>%</span>\n        </div>\n        <div style="text-align: right;">\n          <span>Precio financiado: <span id="financingTotalPrice">$742,716.00</span></span>\n        </div>\n      </div>\n    </div>\n  </div>\n`,v.appendChild(B);const A=D,F={24:.13,36:.14,48:.15,60:.16,72:.17};function N(){const e=parseFloat(document.getElementById("downPaymentCalc").value)/100,t=parseInt(document.getElementById("installmentsCalc").value),n=F[t]||.17,o=A*e,a=function(e,t,n){const o=t/12;return 0===o?e/n:e*o*Math.pow(1+o,n)/(Math.pow(1+o,n)-1)}(A-o,n,t),l="$"+a.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}),i=o+a*t;document.getElementById("downPaymentAmount").textContent="$"+o.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}),document.getElementById("monthlyPayment").textContent=l,document.getElementById("financingRate").textContent=(100*n).toFixed(0),document.getElementById("financingTotalPrice").textContent="$"+i.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}setTimeout(()=>{const e=new URLSearchParams(window.location.search),t=e.get("downpayment"),n=e.get("months"),o=document.getElementById("downPaymentCalc"),a=document.getElementById("installmentsCalc");t&&o&&(o.value=t),n&&a&&(a.value=n),o?.addEventListener("change",N),a?.addEventListener("change",N),N()},100);const P=document.createElement("div");P.className="detail-cta-section";const _=document.createElement("div");_.className="cta-header",_.innerHTML='\n    <div class="cta-header-label" translate="no"></div>\n    <div class="cta-header-label" translate="no"></div>\n    <div class="cta-header-label" translate="no"></div>\n  ';const $=document.createElement("div");$.className="cta-buttons-row",$.style.position="relative",$.innerHTML='\n    <button class="cta-button first" id="separarBtn" translate="no">APARTAR</button>\n    <button class="cta-button first" id="visitarBtn" translate="no">C√ìMO LLEGAR</button>\n    <button class="cta-button second" id="chatearBtn" translate="no">CHATEAR</button>\n  ';const R=document.createElement("div");if(R.className="cta-watch-availability",R.innerHTML='\n    <div class="cta-header-label" translate="no" style="color:#ff8400; display:flex; align-items:center; justify-content:center; position: absolute; bottom: -12px; left: calc(100% / 6 * 5 - 8px); transform: translateX(-50%); white-space: nowrap; font-size: 11px;">\n      \x3c!-- This will be dynamically filled by updateChatHeaderVisibility() --\x3e\n      DISPONIBLE AHORA\n    </div>\n  ',P.appendChild(_),P.appendChild($),P.appendChild(R),v.appendChild(P),v.addEventListener("click",function(e){if("separarBtn"===e.target.id)e.stopPropagation(),window.showPaymentViewInModal&&p?window.showPaymentViewInModal(p):console.error("Payment view not available or lot data missing");else if("visitarBtn"===e.target.id)if(e.stopPropagation(),y&&y.center){const[e,t]=y.center,n=/iPad|iPhone|Macintosh/.test(navigator.userAgent)?`https://maps.apple.com/?daddr=${t},${e}&dirflg=d`:`https://www.google.com/maps/dir/?api=1&destination=${t},${e}&travelmode=driving&dir_action=navigate`;window.open(n,"_blank")}else window.showToaster?.("No se pudo obtener la ubicaci√≥n del lote"),console.error("lotMapData:",y);else"chatearBtn"===e.target.id&&(console.log("Chatear button clicked"),e.stopPropagation())}),v.appendChild(P),setTimeout(()=>{initChatAvailability()},100),i.appendChild(v),r?.classList.add("show-details"),i.classList.add("active"),y){map.getZoom()>=18.8&&(currentLabeledLot&&currentLabeledLot.name!==y.name&&removeSideLengthLabels(),addSideLengthLabels(y),currentLabeledLot=y)}const U=baseLots.findIndex(e=>e.number===p.number);lastOpenedBaseIndex=U;const q=document.getElementById("scheduleButton");q&&q.addEventListener("click",function(){i.style.display="none",s&&(s.style.display="block");try{loadCalendlyWidget?.({lot:p,detailData:{nickname:I,subtitle:S}})}catch(e){}},{once:!0})}function render(){modalInfo.innerHTML="",lots.forEach((e,t)=>{const n=document.createElement("div");n.classList.add("info-row"),n.dataset.index=t,n.dataset.baseIndex=e.clone?-1:baseLots.findIndex(t=>t.number===e.number);const o=(e.availability??"").toString().toLowerCase(),a="featured"===o,l="available"===o,i="sold"===o;let s=e.price;if(!i&&e.priceM2&&e.size){const t=parseFloat(e.priceM2)*parseFloat(e.size);s=(1e3*Math.round(t/1e3)/1e3).toString()}const r=s.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","),d=i?"":e.priceM2?`$${e.priceM2.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}`:"";if(a&&n.classList.add("info-row--featured"),n.innerHTML=`\n  <div class="lot-left">\n    <div class="lote-label">MZ-L</div>\n    <div class="lote-number">${e.number.replace(/^[a-z]+/i,"")}</div>\n  </div>\n\n      <div class="lot-middle ${i?"lot-middle--sold":""}">\n        ${i?'<div style="font-size:48px; font-weight:700; color:#ff8400;">VENDIDO</div>':`${e.size}<span class="sup">M2</span>`}\n      </div>\n\n      <div class="lot-price ${i?"lot-price--hidden":""}">\n        <div class="price-wrapper">\n          <span class="price">$${r}</span>\n          <span class="mdp">MIL</span>\n        </div>\n      </div>\n\n      <div class="price-per-m2-column ${i?"lot-price--hidden":""}"\n           contenteditable="false"\n           data-price-m2="${e.priceM2||""}"\n           data-lot-name="${e.name}">\n        ${d}<span class="sup">/M2</span>\n      </div>\n\n      <div class="row-actions">\n        ${window.isUserAuthenticated?`\n          ${i?"":`\n          <button class="row-action-btn edit-btn" title="Edit Price" data-lot-name="${e.name}">\n            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">\n              <path d="M3 17.25V21H6.75L17.81 9.94L14.06 6.19L3 17.25ZM20.71 7.04C21.1 6.65 21.1 6.02 20.71 5.63L18.37 3.29C17.98 2.9 17.35 2.9 16.96 3.29L15.13 5.12L18.88 8.87L20.71 7.04Z" fill="currentColor"/>\n            </svg>\n          </button>\n          `}\n          <button class="row-action-btn cycle-btn" title="Cycle Availability" data-lot-name="${e.name}">\n            <svg width="16" height="16" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2">\n              <path d="M23 4L23 10 17 10M1 20L1 14 7 14M3.51 9a9 9 0 0114.85-3.36L23 10M20.49 15a9 9 0 01-14.85 3.36L1 14"/>\n            </svg>\n          </button>\n        `:""}\n      </div>\n\n<div class="arrow ${i?"arrow-hidden":""}">\n  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 12"\n       class="${a||l?"wiggle-arrow":""}">\n    <path d="M4 3 L7 6 L4 9" stroke="#888" stroke-width="1" fill="none"\n          stroke-linecap="round" stroke-linejoin="round"/>\n  </svg>\n</div>\n    `,a){const e=document.createElement("div");e.classList.add("border-left"),n.appendChild(e);const t=document.createElement("div");t.classList.add("border-top"),n.appendChild(t);const o=document.createElement("div");o.classList.add("featured-label"),o.textContent="SELECCI√ìN LA-LA LAND",n.appendChild(o)}modalInfo.appendChild(n)}),setupLotClickHandlers(),setupRowActionButtons()}function setupRowActionButtons(){const e=document.getElementById("modalInfo");e&&(window.__rowActionListenersSetup||(window.__rowActionListenersSetup=!0,e.addEventListener("click",async e=>{const t=e.target.closest(".row-action-btn.edit-btn");if(t){e.stopPropagation();t.dataset.lotName;const n=t.closest(".info-row").querySelector(".price-per-m2-column");if(!n)return;if("true"===n.contentEditable)return n.contentEditable="false",n.classList.remove("editing"),void render();const o=n.dataset.priceM2;if(!o)return void showToaster("No price/m¬≤ to edit");n.contentEditable="true",n.classList.add("editing"),n.focus();const a=window.getSelection(),l=document.createRange();l.selectNodeContents(n.childNodes[0]),a.removeAllRanges(),a.addRange(l);const i=async()=>{let e=n.textContent.trim();e=e.replace(/\/M2$/i,""),e=e.replace(/[^0-9.]/g,"");const t=parseFloat(e),a=parseFloat(o.replace(/,/g,""));if(n.contentEditable="false",n.classList.remove("editing"),isNaN(t)||t<=0)return showToaster("Invalid price"),void render();t!==a?(showToaster("Saving..."),await updateBulkPriceM2(o,t)):render()};return n.addEventListener("keydown",e=>{"Enter"===e.key?(e.preventDefault(),i()):"Escape"===e.key&&(e.preventDefault(),n.contentEditable="false",n.classList.remove("editing"),render())},{once:!0}),void n.addEventListener("blur",i,{once:!0})}const n=e.target.closest(".row-action-btn.cycle-btn");if(n){e.stopPropagation();const t=n.dataset.lotName;console.log("Cycle availability clicked for:",t),"function"==typeof window.cycleSelectedLotAvailability&&window.cycleSelectedLotAvailability()}})))}async function updateBulkPriceM2(e,t){if(!window.supabaseClient)return void showToaster("Database not ready");const n=(await(window.supabaseClient?.auth.getSession()))?.data?.session;if(!!(!n||!n.user))return showToaster("Please login to edit prices"),void document.getElementById("globe-login-btn")?.click();const o=parseFloat(e.toString().replace(/,/g,"")),a=parseFloat(t);console.log("updateBulkPriceM2 - oldPriceM2:",e,"oldValue:",o,"newValue:",a);const l=lotData.filter(e=>{if(!e.priceM2&&0!==e.priceM2)return!1;return parseFloat(e.priceM2.toString().replace(/,/g,""))===o});if(console.log("Found",l.length,"affected lots"),0!==l.length){console.log(`Updating ${l.length} lots from ${o} to ${a}`);try{const e=l.map(e=>e.name);console.log("Lot names to update:",e),console.log("Update query:",{price_m2:a,lot_names:e,client_id:CURRENT_CLIENT});const{data:t,error:n,count:i}=await window.supabaseClient.from("lots").update({price_m2:a}).in("lot_name",e).eq("client_id",CURRENT_CLIENT).select();if(console.log("Supabase response:",{data:t,error:n,count:i,rowsAffected:t?.length}),n)throw console.error("Supabase error details:",n),showToaster(`DB Error: ${n.message||n.code||"Unknown"}`),n;if(!t||0===t.length)return showToaster("‚ö†Ô∏è No rows updated. Check RLS policies?"),void console.warn("Update returned 0 rows - possible RLS issue");const{data:{user:s}}=await window.supabaseClient.auth.getUser(),r=s?.email||s?.id||"unknown";try{const e=t.map(async e=>{const{data:t}=await window.supabaseClient.from("lot_prices_audit").select("updated_at").eq("lot_name",e.lot_name).order("updated_at",{ascending:!1}).limit(1).single();let n=null;if(t?.updated_at){const e=new Date(t.updated_at),o=new Date;n=Math.floor((o-e)/864e5)}return window.supabaseClient.from("lot_prices_audit").insert({lot_name:e.lot_name,old_price:o,new_price:a,days_since_change:n,updated_by:r})});await Promise.all(e),console.log(`‚úì Logged ${t.length} price changes to audit table`)}catch(e){console.warn("Failed to log price audit:",e)}showToaster(`‚úì Updated ${t.length} lot${t.length>1?"s":""} in DB`),lotData.forEach(e=>{parseFloat(e.priceM2?.toString().replace(/,/g,"")||"0")===o&&(e.priceM2=a.toString(),e.price_m2=a)}),baseLots.forEach(e=>{parseFloat(e.priceM2?.toString().replace(/,/g,"")||"0")===o&&(e.priceM2=a.toString())}),lots.forEach(e=>{parseFloat(e.priceM2?.toString().replace(/,/g,"")||"0")===o&&(e.priceM2=a.toString())}),render(),highlightCenter(),updateScrollbar()}catch(e){console.error("Error updating price_m2:",e),showToaster(`Failed: ${e.message||"Unknown error"}`),render()}}else showToaster("No lots found with this price/m¬≤")}function updateScrollbar(){document.getElementById("lotModal").classList.contains("info-mode")?infoScrollUpdater?infoScrollUpdater():enableInfoScrollbar():infiniteScrollUpdater?infiniteScrollUpdater():enableInfiniteScrollbar()}function scrollToBaseIndex(e,t=!0){if(0===baseLots.length)return;const n=e+cloneCount,o=modalInfo.querySelector(`.info-row[data-index="${n}"]`);o&&(o.offsetWidth,o.scrollIntoView({behavior:t?"smooth":"auto",block:"center"}),t||setTimeout(()=>{highlightCenter(),updateScrollbar()},0))}backButton.addEventListener("click",()=>{const e=document.getElementById("lotModal"),t=document.querySelector(".plus-button .plus-icon"),n=document.querySelector(".plus-button .minus-icon"),o=document.getElementById("calendlyEmbed");if(e.classList.contains("viewer-mode"))return void close360ViewerInModal();window.isDetailOpen=!1,removeSideLengthLabels();const a=document.getElementById("shareButton");a&&(a.style.display="none");const l=document.getElementById("pinLockButton");if(l&&(l.style.display="none"),o&&"block"===o.style.display)return o.style.display="none",void(document.getElementById("lotDetails").style.display="block");e.classList.contains("expanded")&&(e.classList.remove("expanded"),t.style.display="block",n.style.display="none"),headerLotNumber.style.display="none",document.querySelector(".modal-content-wrapper").classList.remove("show-details"),lotDetails.classList.remove("active"),backButton.style.display="none",document.querySelector(".plus-button").style.display="none",e.classList.add("lot-mode"),e.classList.remove("info-mode"),"number"==typeof lastOpenedBaseIndex&&requestAnimationFrame(()=>{scrollToBaseIndex(lastOpenedBaseIndex,!1)});try{enableInfiniteScrollbar()}catch{}try{highlightCenter(),updateScrollbar()}catch{}try{if(!isSwitchingLots){null!==window.hoveredId&&map?.getSource("lots-final")&&(map.setFeatureState({source:"lots-final",id:window.hoveredId},{hover:!1}),window.hoveredId=null);const e=document.getElementById("lotModal");if(e&&e.classList.contains("show")){const e="function"==typeof getSelectedLot?getSelectedLot():null,t=e?.lotName||window.selectedLotName;if(t&&map?.getSource("lots-final")){const e=lotData.findIndex(e=>e.name===t);-1!==e&&(map.setFeatureState({source:"lots-final",id:e},{hover:!0}),window.hoveredId=e)}}}}catch{}scrollHandlerAttached=!0,previousMapView&&map&&(map.flyTo({center:previousMapView.center,zoom:previousMapView.zoom,bearing:previousMapView.bearing,pitch:previousMapView.pitch,speed:1.2,curve:1.5}),previousMapView=null)});const animatedFeaturedLots=new Set;function highlightCenter(e=!1){if(!document.getElementById("lotModal").classList.contains("show"))return;const t=document.querySelector(".modal-content-wrapper");if(t&&t.classList.contains("show-details"))return;const n=[...modalInfo.querySelectorAll(".info-row")],o=modalInfo.scrollTop,a=modalInfo.scrollHeight/n.length,l=o+modalInfo.clientHeight/2,i=Math.floor(l/a);let s=!1,r=-1;n.forEach((e,t)=>{if(e.classList.remove("active","center"),t===i){if(e.classList.add("active","center"),e.classList.contains("info-row--featured")){const t=e.dataset.index;animatedFeaturedLots.has(t)?e.classList.add("animate-featured"):(e.offsetWidth,e.classList.add("animate-featured"),animatedFeaturedLots.add(t))}const t=parseInt(e.dataset.baseIndex,10);if(!isNaN(t)){const e=baseLots[t];if(e&&window.map&&lotData&&(r=lotData.findIndex(t=>extractLotNumber(t.name)===e.number),-1!==r&&(null!==window.hoveredId&&window.hoveredId!==r&&(map.setFeatureState({source:"lots-final",id:window.hoveredId},{hover:!1}),s=!0),map.setFeatureState({source:"lots-final",id:r},{hover:!0}),window.hoveredId=r,s&&currentLabeledLot))){const e=lotData[r];e&&currentLabeledLot.name!==e.name&&removeSideLengthLabels()}}}})}function clampScroll(){if(document.getElementById("lotModal").classList.contains("info-mode"))return;if(0===baseLots.length||0===lots.length||clampCooldown)return;const{scrollTop:e,scrollHeight:t,clientHeight:n}=modalInfo,o=t/lots.length,a=o*cloneCount,l=o*baseLots.length;let i=e;e<a?(clampCooldown=!0,i=e+l):e+n>=t-a&&(clampCooldown=!0,i=e-l),clampCooldown&&(modalInfo.removeEventListener("scroll",handleScroll),modalInfo.scrollTop=i,requestAnimationFrame(()=>{highlightCenter(!0),updateScrollbar(),setTimeout(()=>{highlightCenter(!0)},10),setTimeout(()=>{modalInfo.addEventListener("scroll",handleScroll),clampCooldown=!1},50)}))}function stopDragging(){if(document.getElementById("lotModal").classList.contains("info-mode"))return isDragging=!1,isScrollbarDragging=!1,customScrollthumb.classList.remove("active"),void modalInfo.classList.remove("dragging");if(!isDragging&&!isScrollbarDragging)return;isDragging=!1,isScrollbarDragging=!1,customScrollthumb.classList.remove("active"),modalInfo.classList.remove("dragging");const e=[...modalInfo.querySelectorAll(".info-row")],t=modalInfo.getBoundingClientRect(),n=t.top+t.height/2;let o=0,a=1/0;e.forEach(e=>{if("-1"===e.dataset.baseIndex)return;const t=e.getBoundingClientRect(),l=(t.top+t.bottom)/2,i=Math.abs(l-n);i<a&&(a=i,o=parseInt(e.dataset.baseIndex,10))}),scrollToBaseIndex(o,!0)}function handleScrollDrag(e){if(isScrollbarDragging){const t=(e.clientY-dragStartY)/modalInfo.clientHeight;modalInfo.scrollTop=dragStartScroll+t*modalInfo.scrollHeight}e.preventDefault()}function stopScrollDrag(){isScrollbarDragging&&(isScrollbarDragging=!1,customScrollthumb.classList.remove("active"),document.removeEventListener("pointermove",handleScrollDrag),document.removeEventListener("pointerup",stopScrollDrag),stopDragging())}function handleContentDrag(e){if(!document.getElementById("lotModal").classList.contains("info-mode")){if(isDragging){const t=dragStartY-e.clientY;modalInfo.scrollTop=dragStartScroll+t;const n=modalInfo.scrollTop,o=modalInfo.scrollHeight,a=modalInfo.clientHeight,l=o/lots.length,i=l*cloneCount,s=l*baseLots.length;n<i?(modalInfo.scrollTop=n+s,dragStartScroll=modalInfo.scrollTop,dragStartY=e.clientY):n+a>=o-i&&(modalInfo.scrollTop=n-s,dragStartScroll=modalInfo.scrollTop,dragStartY=e.clientY)}e.preventDefault()}}function stopContentDrag(){isDragging&&(isDragging=!1,modalInfo.classList.remove("dragging"),document.removeEventListener("pointermove",handleContentDrag),document.removeEventListener("pointerup",stopContentDrag),stopDragging())}function handleScroll(){const e=document.getElementById("lotModal");updateScrollbar(),e.classList.contains("lot-mode")&&scrollHandlerAttached&&requestAnimationFrame(()=>{highlightCenter(),isDragging||isScrollbarDragging||(clearTimeout(scrollTimeout),scrollTimeout=setTimeout(()=>{clampScroll()},100))})}function openModal(e=null,t=0,n=!1){const o=document.getElementById("lotModal"),a=!o.classList.contains("show");if(a||!e){o.classList.remove("pin-mode","info-mode","lot-mode","expanded");const e=document.getElementById("lotDetails"),t=document.getElementById("modalInfo"),n=document.getElementById("calendlyEmbed"),a=document.getElementById("viewer-container"),l=document.getElementById("customScrollbar"),i=document.getElementById("loadingSpinner");e&&(e.classList.remove("active"),e.style.display="block",e.innerHTML=""),t&&(t.style.display="",t.style.opacity="1",t.innerHTML=""),n&&(n.style.display="none"),a&&(a.style.display="none"),l&&(l.style.display="",l.style.visibility="");const s=document.getElementById("customScrollthumb");s&&(s.style.display="",s.style.visibility=""),i&&(i.style.display="block");const r=document.getElementById("backButton"),d=document.querySelector(".plus-button"),c=document.querySelector(".bottom-plus-button"),m=document.getElementById("headerLotNumber");r&&(r.style.display="none"),d&&(d.style.display="none"),c&&(c.style.display="none"),m&&(m.style.display="none");const u=document.getElementById("pinLockButton");u&&(u.style.display="none");const p=document.getElementById("globalDashboardButton");p&&(p.style.display="none");const g=document.querySelector(".modal-content-wrapper");g&&g.classList.remove("show-details"),window.isDetailOpen=!1,scrollHandlerAttached=!0,document.getElementById("authControls")?.classList.remove("hide-in-detail")}const l=!1===a&&e&&!infoMode&&!o.classList.contains("pin-mode"),i=o.classList.contains("pin-mode");if(i&&!infoMode)return;function s(t=!0){try{const n=e&&(e.fraccionamiento||"").toString().trim()||"marsella",o=document.getElementById("lotModal"),a=o?.dataset.fracc||"";if(n!==a){o&&(o.dataset.fracc=n);const e=document.getElementById("headerFracc");e&&(e.textContent=n?n.toUpperCase():"INVERTA"),Array.isArray(window.baseLotsAll)&&window.baseLotsAll.length&&(baseLots=window.baseLotsAll.filter(e=>(e.fraccionamiento||"").toString().trim()===n),updateLotsArray(),t&&render())}window.resetUnitButtons&&window.resetUnitButtons()}catch(e){console.warn("Fraccionamiento filter failed:",e)}}if(i&&infoMode&&o.classList.remove("pin-mode"),l){s(!0);const t=baseLots.findIndex(t=>t.number===extractLotNumber(e.name));if(-1!==t){scrollToBaseIndex(t,!0);const n=lotData.findIndex(t=>t.name===e.name);-1!==n&&map&&(null!==window.hoveredId&&map.setFeatureState({source:"lots-final",id:window.hoveredId},{hover:!1}),map.setFeatureState({source:"lots-final",id:n},{hover:!0}),window.hoveredId=n,currentLotIndex=n);map.getZoom()>=18.8&&(removeSideLengthLabels(),addSideLengthLabels(e))}return}if(document.getElementById("communitySearchBtn")?.classList.add("hide"),document.getElementById("lalalandInfoBtn")?.classList.add("hide"),o.classList.add("show"),o.style.display="block",a){o.classList.add("initial-load"),n?console.log("‚è≠Ô∏è Skipping map pan (already positioned from dashboard)"):adjustMapForModal();const e=()=>{o.classList.remove("initial-load"),o.classList.add("animations-ready"),modalInfo.removeEventListener("wheel",e),modalInfo.removeEventListener("touchstart",e),modalInfo.removeEventListener("mousedown",e)};modalInfo.addEventListener("wheel",e,{once:!0}),modalInfo.addEventListener("touchstart",e,{once:!0}),modalInfo.addEventListener("mousedown",e,{once:!0})}if(infoMode){o.classList.add("expanded","info-mode");const e=document.getElementById("modalInfo"),t=document.getElementById("customScrollbar"),n=document.getElementById("loadingSpinner");return e.innerHTML='\n      <div style="padding:20px; color:#8a8880; height:2000px;">\n        <h2 style="color:#a17345; margin-bottom:10px;">Sobre Barcelona</h2>\n        <p>Bienvenido a Barcelona. Aqu√≠ puedes poner descripci√≥n, ubicaci√≥n, beneficios, etc.</p>\n        <p>Para m√°s informaci√≥n cont√°ctanos por WhatsApp o visita nuestras oficinas.</p>\n        <div style="height:1000px; background:linear-gradient(#f0f0f0, #e0e0e0);"></div>\n      </div>\n    ',t.style.display="",n.style.display="none",scrollHandlerAttached=!1,infoMode=!1,document.getElementById("authControls").classList.remove("hide-in-detail"),void setTimeout(()=>{enableInfoScrollbar(),e.scrollTop=0},100)}o.classList.add("lot-mode"),o.classList.remove("info-mode");const r=document.getElementById("headerFracc"),d=o?.dataset?.fracc||e&&(e.fraccionamiento||"").toString().trim()||"marsella";r&&(r.textContent=d?d.toUpperCase():"INVERTA",r.contentEditable="false",r.style.cursor="default",r.style.outline="",r.style.borderRadius="",r.style.padding="",r.onblur=null,r.onkeydown=null);const c=document.getElementById("modalInfo"),m=(document.getElementById("customScrollbar"),document.getElementById("loadingSpinner")),u=()=>{scrollToBaseIndex(e?baseLots.findIndex(t=>t.number===extractLotNumber(e.name)):t,!1),m.style.display="none",c.style.opacity="1"};if(isDataLoaded)if(a||!e)s(!1),render(),u(),setTimeout(()=>{render(),requestAnimationFrame(()=>{requestAnimationFrame(u)})},400);else{s(!1);const t=baseLots.findIndex(t=>t.number===extractLotNumber(e.name));if(-1!==t){scrollToBaseIndex(t,!0);const n=lotData.findIndex(t=>t.name===e.name);-1!==n&&map&&(null!==window.hoveredId&&map.setFeatureState({source:"lots-final",id:window.hoveredId},{hover:!1}),map.setFeatureState({source:"lots-final",id:n},{hover:!0}),window.hoveredId=n,currentLotIndex=n),m.style.display="none",c.style.opacity="1",highlightCenter(),updateScrollbar()}}else fetchLots().then(()=>{s(!1),render(),u(),setTimeout(()=>{render(),requestAnimationFrame(()=>{requestAnimationFrame(u)})},400)})}function closeModal(){if(console.log("üöÄ closeModal CALLED - isDashboardOpen:",window.isDashboardOpen),window.poiModeActive)return void console.log("‚ùå closeModal BLOCKED - POI mode is active");window.skipNextRealtimeRender&&window.skipNextRealtimeRender.clear(),document.getElementById("authControls").classList.remove("hide-in-detail"),document.getElementById("communitySearchBtn")?.classList.remove("hide"),document.getElementById("lalalandInfoBtn")?.classList.remove("hide"),window.resetUnitButtons&&window.resetUnitButtons();const e=document.getElementById("lotModal");if(!e)return;const t=document.querySelector(".modal-content-wrapper"),n=document.getElementById("modalInfo"),o=document.getElementById("customScrollbar"),a=document.getElementById("lotDetails"),l=document.getElementById("backButton"),i=document.getElementById("headerLotNumber"),s=document.querySelector(".plus-button .plus-icon"),r=document.querySelector(".plus-button .minus-icon"),d=document.querySelector(".plus-button"),c=document.querySelector(".bottom-plus-button");e.classList.remove("info-mode","pin-mode","expanded","lot-mode"),hideCalendlyEmbed(),window.isDetailOpen=!1;const m=document.getElementById("shareButton");m&&(m.style.display="none");const u=document.getElementById("pinLockButton");u&&(u.style.display="none");const p=document.getElementById("globalDashboardButton");p&&(p.classList.remove("active"),p.style.display="none");const g=document.getElementById("dashboard-btn"),y=document.getElementById("eye-open-icon"),f=document.getElementById("eye-closed-icon");if(g&&(console.log("closeModal: Resetting dashboard button state"),g.classList.remove("active"),y&&(y.style.display="none",console.log("closeModal: Set eye-open to none")),f&&(f.style.display="inline-block",console.log("closeModal: Set eye-closed to inline-block"))),window.isDashboardOpen=!1,console.log("closeModal: Set isDashboardOpen to false"),window.compareMode){const e=document.getElementById("compareBtn");e&&e.classList.remove("active"),window.compareMode=!1,window.selectedLots.clear(),"function"==typeof removeEditOutlines&&removeEditOutlines(),console.log("Compare mode OFF (modal closed)"),window.originalBaseLots&&(baseLots=[...window.originalBaseLots],window.originalBaseLots=null)}removeSideLengthLabels(),t&&t.classList.remove("show-details"),a&&(a.classList.remove("active"),a.style.display="block",a.innerHTML=""),n&&(n.style.display="",n.style.opacity="1"),o&&(o.style.display="",o.style.visibility="");const h=document.getElementById("customScrollthumb");h&&(h.style.display="",h.style.visibility=""),l&&(l.style.display="none"),i&&(i.style.display="none"),d&&(d.style.display="none"),c&&(c.style.display="none"),s&&(s.style.display="block"),r&&(r.style.display="none");const w=document.getElementById("headerFracc");w&&(w.contentEditable="false",w.style.cursor="default",w.style.outline="",w.style.borderRadius="",w.style.padding="",w.onblur=null,w.onkeydown=null);try{scrollHandlerAttached=!0}catch{}try{clampCooldown=!1}catch{}try{animatedFeaturedLots?.clear?.()}catch{}if(preModalView&&map?(map.flyTo({center:preModalView.center,zoom:preModalView.zoom,bearing:preModalView.bearing,pitch:preModalView.pitch,speed:1.2,curve:1.5}),map.once("moveend",()=>{lastOffset&&(map.panBy([-lastOffset[0],-lastOffset[1]],{duration:800}),lastOffset=[0,0])}),preModalView=null):map&&lastOffset&&(map.panBy([-lastOffset[0],-lastOffset[1]],{duration:800}),lastOffset=[0,0]),e.classList.remove("show"),map&&map.getSource("lots-final")&&null!==window.hoveredId)try{map.setFeatureState({source:"lots-final",id:window.hoveredId},{hover:!1})}catch{}setTimeout(()=>{if(e.style.display="none",map&&map.getSource("lots-final"))try{null!==window.hoveredId&&map.setFeatureState({source:"lots-final",id:window.hoveredId},{hover:!1}),lotData.forEach((e,t)=>{try{map.setFeatureState({source:"lots-final",id:t},{hover:!1})}catch{}}),window.hoveredId=null}catch{}requestAnimationFrame(()=>{map&&map.getSource("lots-final")&&lotData.forEach((e,t)=>{try{map.setFeatureState({source:"lots-final",id:t},{hover:!1})}catch{}})})},50),disableInfiniteScrollbar(),disableInfoScrollbar()}function handlePlusButton(){const e=document.getElementById("lotModal"),t=document.querySelector(".plus-button .plus-icon"),n=document.querySelector(".plus-button .minus-icon");e.classList.toggle("expanded"),e.classList.contains("expanded")?(t.style.display="none",n.style.display="block"):(t.style.display="block",n.style.display="none")}function loadCalendlyWidget({lot:e,detailData:t}){const n=document.getElementById("calendlyEmbed"),o=document.getElementById("calendly-iframe"),a=new URL("https://calendly.com/lalaland_/santte2");a.searchParams.set("hide_gdpr_banner","1"),a.searchParams.set("background_color","fcfaf3"),a.searchParams.set("text_color","1a1a1a"),a.searchParams.set("primary_color","ff8400"),o.src=a.toString(),n.style.display="block"}customScrollthumb.addEventListener("pointerdown",e=>{e.stopPropagation(),isScrollbarDragging=!0,dragStartY=e.clientY,dragStartScroll=modalInfo.scrollTop,customScrollthumb.classList.add("active"),document.addEventListener("pointermove",handleScrollDrag),document.addEventListener("pointerup",stopScrollDrag),e.preventDefault()}),modalInfo.addEventListener("pointerdown",e=>{e.target.closest(".custom-scrollbar")||(isDragging=!0,dragStartY=e.clientY,dragStartScroll=modalInfo.scrollTop,modalInfo.classList.add("dragging"),document.addEventListener("pointermove",handleContentDrag),document.addEventListener("pointerup",stopContentDrag),e.preventDefault())}),modalInfo.addEventListener("scroll",handleScroll),modalInfo.addEventListener("wheel",e=>{if(document.getElementById("lotModal").classList.contains("info-mode"))return;if(e.preventDefault(),isDragging||isScrollbarDragging)return;const t=[...modalInfo.querySelectorAll(".info-row")],n=modalInfo.getBoundingClientRect(),o=n.top+n.height/2;let a=null,l=1/0;if(t.forEach(e=>{const t=e.getBoundingClientRect(),n=Math.abs((t.top+t.bottom)/2-o);n<l&&(l=n,a=e)}),!a)return;let i=parseInt(a.dataset.index)+Math.sign(e.deltaY);i<0?i=lots.length-1:i>=lots.length&&(i=0),modalInfo.querySelector(`.info-row[data-index="${i}"]`)?.scrollIntoView({behavior:"auto",block:"center"})}),(()=>{let e=0;const t=setInterval(()=>{(window.__LL_PINS__||e++>50)&&(clearInterval(t),(()=>{const e=document.getElementById("poiButton");if(!e)return;e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();const t=window.__LL_PINS__;t&&"function"==typeof t.toggleAddMode&&t.toggleAddMode()});const t=()=>{const t=document.getElementById("lotModal");if(!t)return;const n=t.classList.contains("show"),o=!0===window.isDetailOpen,a=!0===window.isUserAuthenticated;if(n&&!o&&a)e.style.display="block";else{e.style.display="none";const t=window.__LL_PINS__;window.poiModeActive&&t&&"function"==typeof t.toggleAddMode&&t.toggleAddMode()}},n=new MutationObserver(t),o=document.getElementById("lotModal");o&&n.observe(o,{attributes:!0,attributeFilter:["class"]}),t()})())},100)})()</script><script>function hideCalendlyEmbed(){const e=document.getElementById("calendlyEmbed");e&&(e.style.display="none");const n=document.getElementById("calendly-iframe");if(n&&(n.src="about:blank"),window.Calendly&&"function"==typeof window.Calendly.closePopupWidget)try{window.Calendly.closePopupWidget()}catch{}}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("lotModal"),n=document.getElementById("resetViewBtn"),s=document.getElementById("lalalandInfoBtn");document.getElementById("infoBtn"),document.getElementById("gpsButton");document.getElementById("lalalandInfoBtn")?.addEventListener("click",()=>{infoMode=!0,document.getElementById("lotModal")?.classList.remove("pin-mode"),openModal();const e=document.getElementById("lotModal");e.classList.add("info-mode"),e.classList.remove("lot-mode"),e.classList.add("expanded");const n=document.getElementById("modalInfo"),s=document.getElementById("customScrollbar");document.getElementById("headerFracc").textContent="LA-LA LAND",n.innerHTML='\n  \n<div class="faq-section">\n\n  <h3><span class="emoji">üí®</span> ¬øQu√© tan r√°pido puedo vender con La-La Land?</h3>\n\n <ul>\n  <li><span class="emoji">üöÄ</span> Vende <strong>hasta 30‚Äì50% m√°s r√°pido</strong> al reemplazar PDFs por experiencias interactivas.<sup>1</sup></li>\n  <li><span class="emoji">üè°</span> Los desarrollos con <strong>recorridos 360¬∞</strong> y <strong>disponibilidad en tiempo real</strong> generan <strong>2√ó m√°s inter√©s</strong> de compradores.<sup>2</sup></li>\n  <li><span class="emoji">üí¨</span> El <strong>77% de los compradores</strong> afirma que un tour virtual los ayud√≥ a decidirse a visitar ‚Äî decisiones m√°s r√°pidas, menos visitas desperdiciadas.<sup>3</sup></li>\n  <li><span class="emoji">üìà</span> Los proyectos que usan <strong>herramientas digitales</strong> reportan <strong>cierres 4‚Äì9% m√°s altos</strong> en precio.<sup>4</sup></li>\n  <li><span class="emoji">‚è±Ô∏è</span> Los asesores ahorran <strong>40‚Äì60% de tiempo</strong> por cliente, ya que los compradores se informan por s√≠ mismos.<sup>5</sup></li>\n  <li><span class="emoji">‚ùå</span> Adi√≥s a los <strong>PDFs anticuados</strong> ‚Äî la disponibilidad se actualiza <strong>en tiempo real</strong>, manteniendo alineadas las ventas con los clientes.</li>\n</ul>\n\n\n  <div class="faq-sources" style="font-size: 0.85em; color: #777; margin-top: 10px;">\n    <p><strong>Fuentes:</strong></p>\n    <ol>\n      <li>REACH PropTech Report (2022): ‚ÄúDigital Sales Tools Reduce Time on Market by 30‚Äì50%.‚Äù</li>\n      <li>Zillow & NAR Research (2023): ‚ÄúVirtual Tours Double Buyer Engagement.‚Äù</li>\n      <li>National Association of Realtors (2024): ‚Äú77% of Buyers Say Virtual Tours Influence Visit Decisions.‚Äù</li>\n      <li>Matterport + Redfin Study (2023): ‚Äú3D Listings Sell 31% Faster and for 4‚Äì9% Higher Prices.‚Äù</li>\n      <li>HubSpot / DemandGen Report (2023): ‚ÄúInteractive Content Yields 65% Higher Lead-to-Sale Conversion.‚Äù</li>\n    </ol>\n  </div>\n\n\n<div class="cta-section">\n  <a href="https://arquidromo.com/colmena" class="cta-link" target="_blank">\n    <span class="emoji">üêù</span> Ver proyecto ‚Üí <strong>Colmena</strong><br>\n  </a>\n</div>\n\n<div class="cta-section">\n  <a href="https://arquidromo.com/vivecolmena/departamentos" class="cta-link" target="_blank">\n    <span class="emoji">üåø</span> Explorar ‚Üí <strong>Vive Colmena</strong><br>\n  </a>\n</div>\n\n</div>\n\n\n  ',s.style.display="",enableInfoScrollbar()});new MutationObserver(()=>{document.getElementById("addPinBtn");const n=()=>{communitySearchBtn?.classList.remove("hide"),s?.classList.remove("hide")};window.innerWidth<768&&e.classList.contains("expanded")?(()=>{if(communitySearchBtn?.classList.add("hide"),s?.classList.add("hide"),window.__LL_PINS__?.addMode)try{window.__LL_PINS__.toggleAddMode()}catch{}})():n()}).observe(e,{attributes:!0,attributeFilter:["class"]});const o=getCurrentFraccZoom();n.addEventListener("click",()=>{window.map&&map.flyTo({center:[-100.15994,25.461823],zoom:o,bearing:0,pitch:0,speed:1.2,curve:1.5})})})</script><script>(()=>{"use strict";const e=window.__LL_PINS__=window.__LL_PINS__||{};e.markers=new Map,e.addMode=!1,e._mapClickHandler=null,e._isVisible=!1,e.pinLocks=new Map,e._pinsAwaitingCone=new Set;const t=(e,t=2500)=>{try{window.showToaster?.(e,t)}catch{}};e.addAddPinButton=function(){},e.toggleAddMode=function(){if(!window.map)return void t("Map is still loading‚Ä¶");e.addMode=!e.addMode;const n=document.getElementById("poiButton");n&&(n.style.textDecoration=e.addMode?"underline":"none"),window.poiModeActive=e.addMode,map.getCanvas().style.cursor=e.addMode?"crosshair":"",e.addMode&&!e._mapClickHandler?(e._mapClickHandler=t=>{const n=t.originalEvent?.target;n&&(n.closest("#lotModal")||n.closest(".mapboxgl-ctrl")||n.closest("button")||n.closest("a"))||e.createPinAt(t.lngLat).finally(()=>{e.addMode=!1,window.poiModeActive=!1;const t=document.getElementById("poiButton");t&&(t.style.textDecoration="none"),map.getCanvas().style.cursor="",map.off("click",e._mapClickHandler),e._mapClickHandler=null})},map.on("click",e._mapClickHandler),t("POI mode: Click map to add point")):!e.addMode&&e._mapClickHandler&&(map.off("click",e._mapClickHandler),e._mapClickHandler=null,t("POI mode deactivated"))},e.createPinAt=async function(n){await window.supabaseReady;const{data:{user:o}}=await window.supabaseClient.auth.getUser();if(!o)return console.error("User not authenticated"),void t("Please log in to add pins");const{data:i,error:a}=await window.supabaseClient.from("pins").insert({lng:n.lng,lat:n.lat,heading:0,title:"PIN",client_id:CURRENT_CLIENT,user_id:o.id}).select().single();if(a)return console.error("Pin creation failed:",a),void t(`Could not create pin: ${a.message}`);e.addMarker(i),t("Pin added")},e.deletePin=async function(n){try{await window.supabaseReady;const{error:o}=await window.supabaseClient.from("pins").delete().eq("id",n);if(o)return console.error(o),t("Failed to delete pin"),!1;const i=e.markers.get(n);return i&&(i.marker.remove(),e.markers.delete(n)),t("Pin deleted"),!0}catch(e){return console.error(e),t("Delete failed"),!1}},e.markerElement=function(){const e=document.createElement("div");return e.style.width="10px",e.style.height="10px",e.style.borderRadius="50%",e.style.background="transparent",e.style.border="none",e.style.boxShadow="none",e.style.cursor="pointer",e.style.border="2px solid #ff8400",e},e.addMarker=function(n){if(e.markers.has(n.id))return e.markers.get(n.id).marker.setLngLat([n.lng,n.lat]),void(e.markers.get(n.id).pin=n);const o=e.markerElement(),i=new mapboxgl.Marker({element:o,draggable:!1}).setLngLat([n.lng,n.lat]);e.markers.set(n.id,{pin:n,marker:i}),e._isVisible&&window.map?i.addTo(map):e._pinsAwaitingCone.add(n.id),i.on("dragend",async()=>{const o=i.getLngLat(),{error:a}=await window.supabaseClient.from("pins").update({lng:o.lng,lat:o.lat}).eq("id",n.id);t(a?"Failed to save position":"Position saved");const s=e.markers.get(n.id);s&&(s.pin.lng=o.lng,s.pin.lat=o.lat)}),o.addEventListener("click",t=>{t.stopPropagation(),e.openPinInModal(n)})},e.setPinHeading=async function(t,n,{persist:o=!0}={}){const i=e.markers.get(t);if(!i)return;const a=(Math.round(n)%360+360)%360;if(i.pin.heading=a,o){await window.supabaseReady;const{error:e}=await window.supabaseClient.from("pins").update({heading:a}).eq("id",t);e&&console.warn("Failed to save heading",e)}},e.togglePinLock=function(n){const o=e.markers.get(n);if(!o)return;const i=!(!e.pinLocks.has(n)||e.pinLocks.get(n));e.pinLocks.set(n,i),o.marker.setDraggable(!i);const a=document.getElementById("unlockIcon"),s=document.getElementById("lockIcon");return a&&s&&(i?(a.style.display="none",s.style.display="block"):(a.style.display="block",s.style.display="none")),t(i?"Pin locked":"Pin unlocked"),i},e._revealMarkers=function(){if(e._isVisible)return;e._isVisible=!0;const t=new Set(e._pinsAwaitingCone);let n=0;const o=t.size;e.markers.forEach(({marker:i,pin:a})=>{const s=i.getElement();s.parentNode||i.addTo(map),s.style.display="block",s.style.opacity="0",s.style.transition="opacity 600ms ease";const d=()=>{s.removeEventListener("transitionend",d),t.has(a.id)&&t.delete(a.id),n++,n===o&&e._pinsAwaitingCone.clear()};s.addEventListener("transitionend",d,{once:!0}),setTimeout(()=>{t.has(a.id)&&d()},1e3),requestAnimationFrame(()=>{s.style.opacity="1"})})},e.openPinInModal=async function(t){await window.supabaseReady;const{data:{session:n}}=await window.supabaseClient.auth.getSession(),o=!(!n||!n.user);document.getElementById("lotModal").classList.add("pin-mode");const i=document.getElementById("lotModal"),a=document.querySelector(".modal-content-wrapper"),s=document.getElementById("lotDetails"),d=document.getElementById("backButton");if(!i.classList.contains("show"))try{window.map&&(window.preModalView={center:map.getCenter().toArray(),zoom:map.getZoom(),bearing:map.getBearing(),pitch:map.getPitch()}),i.classList.add("show"),i.style.display="block","function"==typeof window.adjustMapForModal&&adjustMapForModal()}catch(e){console.warn("Could not open modal:",e)}i.classList.add("pin-mode"),i.classList.remove("lot-mode");const r=document.getElementById("headerFracc"),l=document.getElementById("headerLotNumber");r&&(r.textContent=t.title||"PIN",l.style.display="none",o?(r.contentEditable="true",r.style.cursor="text",r.style.outline="2px solid #ff8400",r.style.borderRadius="4px",r.style.padding="4px 8px",r.onblur=async function(){const e=this.textContent.trim()||"PIN";if(e!==t.title){t.title=e;const{error:n}=await window.supabaseClient.from("pins").update({title:e}).eq("id",t.id);n?console.warn("Failed to save pin title",n):console.log("Pin title saved:",e)}},r.onkeydown=function(e){"Enter"===e.key&&(e.preventDefault(),this.blur())}):(r.contentEditable="false",r.style.cursor="default"));const c=document.getElementById("pinLockButton");if(c)if(o){c.style.display="block";const n=!e.pinLocks.has(t.id)||e.pinLocks.get(t.id),o=document.getElementById("unlockIcon"),i=document.getElementById("lockIcon");o&&i&&(n?(o.style.display="none",i.style.display="block"):(o.style.display="block",i.style.display="none")),c.onclick=()=>e.togglePinLock(t.id)}else c.style.display="none";const p=document.getElementById("globalDashboardButton");p&&(p.style.display="none"),d&&(d.style.display="none"),document.querySelector(".plus-button")?.style&&(document.querySelector(".plus-button").style.display="none"),document.querySelector(".bottom-plus-button")?.style&&(document.querySelector(".bottom-plus-button").style.display="none"),s.style.padding="0",a.style.padding="0",s.innerHTML="",a.classList.add("show-details"),s.classList.add("active");try{window.isDetailOpen=!0}catch{}console.log("üîÑ Fetching photos for pin",t.id);const{data:u,error:g}=await window.supabaseClient.from("pin_photos").select("id,url,created_at").eq("pin_id",t.id).eq("client_id",CURRENT_CLIENT).order("created_at",{ascending:!0});if(g){console.error("‚ùå ERROR fetching pin photos:",g),console.error("‚ùå This may be an RLS (Row Level Security) policy issue."),console.error("‚ùå Error details:",{message:g.message,code:g.code,details:g.details,hint:g.hint});const{data:{session:e}}=await window.supabaseClient.auth.getSession();e&&e.user?(console.log("‚úÖ User IS authenticated:",e.user.email),console.error("‚ùå Query failed despite authentication - check RLS policies on pin_photos table")):console.error("‚ùå User is NOT authenticated - this may be why the query failed")}else console.log("‚úÖ Successfully fetched",u?.length||0,"photos for pin",t.id);const m=u&&u.length?u[u.length-1]:null,y=("number"==typeof t.heading&&t.heading,document.createElement("div"));y.style.padding="0";const w=o?`\n    \x3c!-- Actions (Upload / Delete) --\x3e\n    <div style="display:flex; gap:10px; align-items:center;">\n      <label style="display:inline-block; background:#ff8400; color:#fff; padding:8px 12px; border-radius:6px; cursor:pointer; font-weight:600; font-family: 'Barlow Condensed', Arial, sans-serif;">\n        Upload photo\n        <input type="file" accept="image/*" style="display:none" id="ps-upload-${t.id}">\n      </label>\n      <button id="ps-delete-${t.id}" type="button"\n        style="background:#f44336;color:#fff;padding:8px 12px;border:none;border-radius:6px;cursor:pointer;font-weight:700;font-family: 'Barlow Condensed', Arial, sans-serif;">\n        Delete pin\n      </button>\n    </div>\n  `:"";y.innerHTML=`\n    <div id="ps-photo-wrap-${t.id}" style="\n      position:relative;\n      width:100%;\n      margin:0;\n      border-radius:0 !important;\n      overflow:hidden;\n      background:none;">\n      ${m?`<img id="ps-photo-${t.id}" src="${m.url}" alt=""\n                 style="display:block;width:100%;height:auto;border-radius:0;cursor:pointer;">`:o?`<div id="ps-photo-empty-${t.id}" style="padding:48px 0;text-align:center;color:#8a8880;">No photo yet.</div>`:`<div id="ps-photo-empty-${t.id}" style="padding:48px 0;text-align:center;color:#8a8880;">No photo available.</div>`}\n\n      \x3c!-- Only show overlay with controls if authenticated --\x3e\n      ${o?`\n      <div class="ps-overlay" style="\n        position:absolute;\n        left:0; right:0; top:0;\n        z-index:2;                 \n        padding:12px;\n        pointer-events:none;       \n        background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.35) 40%, rgba(0,0,0,.45) 100%);\n      ">\n        <div class="ps-overlay-card" style="\n          display:flex; flex-direction:column; gap:10px;\n          pointer-events:auto;     \n          background: rgba(0,0,0,0.40);\n          backdrop-filter: blur(4px);\n          -webkit-backdrop-filter: blur(4px);\n          border-radius:10px;\n          padding:10px;\n        ">\n          ${w}\n        </div>\n      </div>\n      `:""}\n    </div>\n  `,s.appendChild(y);const h=y.querySelector(`#ps-photo-${t.id}`);if(h?.addEventListener("click",()=>e.showViewer(h.src)),o){y.querySelector(`#ps-delete-${t.id}`).addEventListener("click",async()=>{if(!confirm("Delete this pin?"))return;if(await e.deletePin(t.id))try{closeModal()}catch{}});y.querySelector(`#ps-upload-${t.id}`).addEventListener("change",async n=>{if(n.target.files&&n.target.files[0])try{const o=await async function(e,t=1e3){const n=await new Promise(t=>{const n=new FileReader;n.onload=()=>t(n.result),n.readAsDataURL(e)}),o=await new Promise(e=>{const t=new Image;t.onload=()=>e(t),t.src=n});let{width:i,height:a}=o;i>a&&i>t?(a=Math.round(a*(t/i)),i=t):a>i&&a>t&&(i=Math.round(i*(t/a)),a=t);const s=document.createElement("canvas");return s.width=i,s.height=a,s.getContext("2d").drawImage(o,0,0,i,a),await new Promise(e=>s.toBlob(t=>e(t),"image/jpeg",.85))}(n.target.files[0],1200),i=`${t.id}/${Date.now()}.jpg`,a=await window.supabaseClient.storage.from("pin-photos").upload(i,o,{contentType:"image/jpeg",upsert:!1});if(a.error)throw a.error;const s=window.supabaseClient.storage.from("pin-photos").getPublicUrl(i),d=s?.data?.publicUrl;if(!d)throw new Error("No public URL");const{data:{user:r}}=await window.supabaseClient.auth.getUser();if(!r)throw new Error("User not authenticated");const{error:l}=await window.supabaseClient.from("pin_photos").insert({pin_id:t.id,url:d,client_id:CURRENT_CLIENT,user_id:r.id});if(l)throw l;const c=y.querySelector(`#ps-photo-wrap-${t.id}`);let p=y.querySelector(`#ps-photo-${t.id}`);p?p.src=d:(c.insertAdjacentHTML("afterbegin",`<img id="ps-photo-${t.id}" src="${d}" alt="" style="display:block;width:100%;height:auto;border-radius:0;cursor:pointer;">`),p=y.querySelector(`#ps-photo-${t.id}`),p.addEventListener("click",()=>e.showViewer(p.src)),document.getElementById(`ps-photo-empty-${t.id}`)?.remove());try{window.showToaster?.("Photo uploaded")}catch{}}catch(e){console.error(e);try{window.showToaster?.("Upload failed")}catch{}}finally{n.target.value=""}})}},e.ensureViewer=function(){document.getElementById("pinViewer")||(document.body.insertAdjacentHTML("beforeend",'\n      <div id="pinViewer" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:10000;">\n        <img id="pinViewerImg" style="max-width:90%;max-height:90%;position:absolute;top:50%;left:50%;transform:translate(-50%, -50%);" />\n        <button id="pinViewerClose" style="position:absolute;top:20px;right:20px;background:#f44336;color:#fff;border:none;border-radius:50%;width:40px;height:40px;font-size:20px;cursor:pointer;">√ó</button>\n      </div>'),document.getElementById("pinViewerClose").addEventListener("click",()=>{document.getElementById("pinViewer").style.display="none"}))},e.showViewer=function(t){e.ensureViewer(),document.getElementById("pinViewerImg").src=t,document.getElementById("pinViewer").style.display="block"},e.loadPins=async function(){await window.supabaseReady,console.log("üîÑ Loading pins from Supabase...");const{data:t,error:n}=await window.supabaseClient.from("pins").select("id,lng,lat,heading,title").eq("client_id",CURRENT_CLIENT).order("created_at",{ascending:!0});if(n){console.error("‚ùå ERROR loading pins:",n),console.error("‚ùå This may be an RLS (Row Level Security) policy issue."),console.error("‚ùå Error details:",{message:n.message,code:n.code,details:n.details,hint:n.hint});const{data:{session:e}}=await window.supabaseClient.auth.getSession();return void(e&&e.user?(console.log("‚úÖ User IS authenticated:",e.user.email),console.error("‚ùå Query failed despite authentication - check RLS policies on pins table")):(console.error("‚ùå User is NOT authenticated - this may be why the query failed"),console.error("‚ùå If pins table has RLS enabled, you need to be logged in to view pins")))}console.log("‚úÖ Successfully loaded",t?.length||0,"pins"),(t||[]).forEach(t=>{e.addMarker(t)})},e.subscribe=function(){window.supabaseClient.channel("pins-rt").on("postgres_changes",{event:"INSERT",schema:"public",table:"pins",filter:`client_id=eq.${CURRENT_CLIENT}`},t=>{e.addMarker(t.new)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"pins",filter:`client_id=eq.${CURRENT_CLIENT}`},t=>{const n=e.markers.get(t.new.id);if(!n)return;const{lng:o,lat:i,heading:a}=t.new;"number"==typeof o&&"number"==typeof i&&(n.marker.setLngLat([o,i]),n.pin.lng=o,n.pin.lat=i),"number"==typeof a&&(n.pin.heading=(a%360+360)%360)}).on("postgres_changes",{event:"DELETE",schema:"public",table:"pins",filter:`client_id=eq.${CURRENT_CLIENT}`},t=>{const n=e.markers.get(t.old.id);n&&(n.marker.remove(),e.markers.delete(t.old.id))}).subscribe()};const n=async()=>{if(await window.supabaseReady,window.map)e.addAddPinButton(),e.loadPins(),e.subscribe();else{const t=setInterval(()=>{window.map&&(clearInterval(t),e.addAddPinButton(),e.loadPins(),e.subscribe())},200)}};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",n):n()})()</script><script>(()=>{const e=document.getElementById("cycleAvailabilityBtn");if(!e)return;const t=["Available","Sold","Featured"];let a=null;const o=document.getElementById("modalInfo"),n=document.getElementById("lotModal"),i=e=>(e||"").toString().trim().toLowerCase();function l(){if(window.isDetailOpen&&"number"==typeof window.currentLotIndex&&window.currentLotIndex>=0){const e=lotData[window.currentLotIndex];if(!e)return null;const t=extractLotNumber(e.name),a=baseLots.findIndex(e=>e.number===t);return{lotName:e.name,number:t,baseIndex:a}}const e=document.querySelector(".info-row.center");if(!e)return null;const t=parseInt(e.dataset.baseIndex,10);if(isNaN(t)||t<0)return null;const a=baseLots[t];if(!a)return null;const o=lotData.findIndex(e=>extractLotNumber(e.name)===a.number);return-1===o?null:{lotName:lotData[o].name,number:a.number,baseIndex:t}}function s(t,{scroll:o=!1}={}){if(!t)return;a=t;const n=lotData.findIndex(e=>e.name===t);if(-1!==n&&map?.getSource("lots-final")){if(null!==window.hoveredId&&window.hoveredId!==n)try{map.setFeatureState({source:"lots-final",id:window.hoveredId},{hover:!1})}catch{}try{map.setFeatureState({source:"lots-final",id:n},{hover:!0})}catch{}window.hoveredId=n}const l=extractLotNumber(t),s=baseLots.findIndex(e=>e.number===l);if(-1!==s)if(o)"function"==typeof scrollToBaseIndex&&scrollToBaseIndex(s,!0);else{const e=s+(window.cloneCount??5),t=document.querySelector(`.info-row[data-index="${e}"]`);t&&(document.querySelectorAll(".info-row").forEach(e=>e.classList.remove("active","center")),t.classList.add("active","center"))}const r=lotData[n],d=i(r?.availability||"available");e.classList.remove("sold","featured"),"sold"===d&&e.classList.add("sold"),"featured"===d&&e.classList.add("featured")}function r(){const t=l(),o=t?.lotName??a;o?s(o,{scroll:!1}):e.classList.remove("sold","featured")}function d(e,t){const a=(t??"").toString().toLowerCase(),o=lotData.findIndex(t=>t.name===e);-1!==o&&(lotData[o].availability=t,lotData[o].featured="featured"===a);const n=extractLotNumber(e),i=baseLots.findIndex(e=>e.number===n);-1!==i&&(baseLots[i].availability=t),lots.forEach(e=>{e.number===n&&(e.availability=t)})}function c(){!function(){const e=map.getSource("featured-lots"),t=lotData.filter(e=>!0===e.featured||"featured"===(e.availability??"").toString().toLowerCase()).map(featuredPolygonFeature);e?e.setData({type:"FeatureCollection",features:t}):addFeaturedLotsLayer(map)}(),function(){const e="sold-x",t=lotData.filter(e=>"sold"===i(e.availability)).flatMap(makeXFeatures);map.getSource(e)?map.getSource(e).setData({type:"FeatureCollection",features:t}):(map.addSource(e,{type:"geojson",data:{type:"FeatureCollection",features:t}}),map.addLayer({id:"sold-x-layer",type:"line",source:e,paint:{"line-color":"white","line-width":1,"line-opacity":1}}))}(),"function"==typeof render&&render()}async function u(){if(!window.supabaseClient)return void window.showToaster?.("Supabase no est√° listo.");if(!await async function(){const e=(await(window.supabaseClient?.auth.getSession()))?.data?.session;return!(!e||!e.user)}())return void document.getElementById("globe-login-btn")?.click();const o=l();if(!o)return void window.showToaster?.("Selecciona un lote primero.");const n=lotData.findIndex(e=>e.name===o.lotName);if(-1===n)return;const r=i(lotData[n].availability||"available"),u=(e=>{const a=t.findIndex(t=>t.toLowerCase()===i(e));return t[(a+1)%t.length]})(r);a=o.lotName,d(o.lotName,u),e.classList.remove("sold","featured"),"sold"===u&&e.classList.add("sold"),"featured"===u&&e.classList.add("featured");window.showToaster?.(`Estado actualizado a "${{available:"disponible",sold:"vendido",featured:"destacado"}[u]||u}".`),c(),s(a,{scroll:!1}),(async()=>{try{window.skipNextRealtimeRender||(window.skipNextRealtimeRender=new Set),window.skipNextRealtimeRender.add(o.lotName);const{data:{user:e}}=await window.supabaseClient.auth.getUser(),t=e?.email||e?.id||"unknown",{error:a}=await window.supabaseClient.from("lots").update({availability:u}).eq("lot_name",o.lotName).eq("client_id",CURRENT_CLIENT);if(a)throw a;try{const e=lotData.length,a=e-lotData.filter(e=>"sold"===i(e.availability)).length,l=lotData[n]?.fraccionamiento||null;await window.supabaseClient.from("lot_updates_audit").insert({lot_name:o.lotName,fraccionamiento:l,old_availability:r,new_availability:u,updated_by:t,available_lots:a})}catch(e){console.warn("Failed to log audit:",e)}}catch(t){console.error("Background save failed:",t),window.showToaster?.("No se pudo guardar. Revirtiendo‚Ä¶"),d(o.lotName,r),e.classList.remove("sold","featured"),"sold"===r&&e.classList.add("sold"),"featured"===r&&e.classList.add("featured"),c(),s(a,{scroll:!1})}})()}e.addEventListener("click",u),window.cycleSelectedLotAvailability=u;const w=new MutationObserver(()=>r());n&&w.observe(n,{attributes:!0,attributeFilter:["class","style"]}),o?.addEventListener("scroll",()=>{clearTimeout(window.__syncBtnTO),window.__syncBtnTO=setTimeout(r,120)});const f=window.highlightCenter;"function"==typeof f&&(window.highlightCenter=function(...e){const t=f.apply(this,e),o=l();return o?.lotName&&(a=o.lotName),r(),t});const m=window.showDetailViewForLot;"function"==typeof m&&(window.showDetailViewForLot=async function(t,...o){const n=o[0],l=n?window.hoveredId:null,s=await m.apply(this,[t,...o]);try{const o=lots[t],s=lotData.find(e=>extractLotNumber(e.name)===o.number);if(s?.name&&(a=s.name),n){null!==l&&l!==window.hoveredId&&(null!==window.hoveredId&&map?.getSource("lots-final")&&map.setFeatureState({source:"lots-final",id:window.hoveredId},{hover:!1}),map?.getSource("lots-final")&&map.setFeatureState({source:"lots-final",id:l},{hover:!0}),window.hoveredId=l);const t=i(s?.availability||"available");e.classList.remove("sold","featured"),"sold"===t&&e.classList.add("sold"),"featured"===t&&e.classList.add("featured")}else r()}catch{}return s});const b=window.render;"function"==typeof b&&(window.render=function(...e){const t=b.apply(this,e);return a&&s(a,{scroll:!1}),t})})()</script><script>(()=>{"use strict";const e=window.__LL_GPS__=window.__LL_GPS__||{};e._listeners={},e.on=function(t,a){(e._listeners[t]||=[]).push(a)},e.emit=function(t,a){(e._listeners[t]||[]).forEach(e=>{try{e(a)}catch{}})},e.lotCenter=e.lotCenter||[-100.15994,25.461823],e.maxDistanceMeters=e.maxDistanceMeters||1e3,e.gpsWatchId=null,e.lastUserLngLat=null,e.hasInitialFly=!1,e.userHeading=null,e.headingListenerAttached=!1,e.farAwayTimer=null,e.farWarned=!1,e.headingMarker=null,e._onOrientation=null,e.headingSmoothingFactor=.15,e.lastSmoothedHeading=null;const t=(e,t=3e3)=>{try{"function"==typeof window.showToaster&&window.showToaster(e,t)}catch{}},a=t=>{if(null===e.lastSmoothedHeading)e.lastSmoothedHeading=t;else{const a=(t-e.lastSmoothedHeading+540)%360-180;e.lastSmoothedHeading=(e.lastSmoothedHeading+a*e.headingSmoothingFactor)%360}return e.lastSmoothedHeading};function o(){window.map&&(map.getSource("ll-user-location")||map.addSource("ll-user-location",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),map.getLayer("ll-user-accuracy")||map.addLayer({id:"ll-user-accuracy",type:"circle",source:"ll-user-location",paint:{"circle-radius":["interpolate",["linear"],["zoom"],15,["coalesce",["get","accRadiusZ15"],2],22,["coalesce",["get","accRadiusZ22"],500]],"circle-color":"#1a73e826","circle-stroke-color":"#1a73e8","circle-stroke-width":1},filter:["==",["get","role"],"accuracy"]}),map.getLayer("ll-user-dot")||map.addLayer({id:"ll-user-dot",type:"circle",source:"ll-user-location",paint:{"circle-radius":6,"circle-color":"#ff8400","circle-stroke-width":0},filter:["==",["get","role"],"point"]}),function(){if(map.getSource("gps-heading-cone"))return;map.addSource("gps-heading-cone",{type:"geojson",data:{type:"Feature",geometry:{type:"Polygon",coordinates:[[[0,0],[0,0],[0,0]]]}}}),map.addLayer({id:"gps-heading-cone-fill",type:"fill",source:"gps-heading-cone",paint:{"fill-color":"#ff8400","fill-opacity":.5}})}())}function n(e,t,a,o){const n=a*Math.PI/180,i=e*Math.PI/180,r=t*Math.PI/180,s=o/6371e3,c=Math.asin(Math.sin(i)*Math.cos(s)+Math.cos(i)*Math.sin(s)*Math.cos(n));return[180*(r+Math.atan2(Math.sin(n)*Math.sin(s)*Math.cos(i),Math.cos(s)-Math.sin(i)*Math.sin(c)))/Math.PI,180*c/Math.PI]}function i(t,a,o=10){const i=map?.getSource("ll-user-location");i&&(i.setData({type:"FeatureCollection",features:[{type:"Feature",properties:{role:"point"},geometry:{type:"Point",coordinates:[t,a]}},{type:"Feature",properties:{role:"accuracy",accRadiusZ15:Math.min(12,Math.max(2,o/6)),accRadiusZ22:Math.min(600,Math.max(50,6*o))},geometry:{type:"Point",coordinates:[t,a]}}]}),null!==e.userHeading&&void 0!==e.userHeading&&function(e,t,a){if(!map||!map.getSource("gps-heading-cone"))return;if(!a&&0!==a)return void map.getSource("gps-heading-cone").setData({type:"Feature",geometry:{type:"Polygon",coordinates:[[[0,0],[0,0],[0,0]]]}});const o=a-45,i=a+45,r=[[e,t]];for(let a=0;a<=24;a++){const s=o+a/24*(i-o);r.push(n(t,e,s,15))}r.push([e,t]),map.getSource("gps-heading-cone").setData({type:"Feature",geometry:{type:"Polygon",coordinates:[r]}})}(t,a,e.userHeading))}function r(a){e.gpsWatchId&&(navigator.geolocation.clearWatch(e.gpsWatchId),e.gpsWatchId=null),function(){if(e.headingListenerAttached){try{window.removeEventListener("deviceorientation",e._onOrientation,!0),window.removeEventListener("deviceorientationabsolute",e._onOrientation,!0)}catch{}e._onOrientation=null,e.headingListenerAttached=!1}}(),map?.getSource("ll-user-location")&&map.getSource("ll-user-location").setData({type:"FeatureCollection",features:[]}),map?.getSource("gps-heading-cone")&&map.getSource("gps-heading-cone").setData({type:"Feature",geometry:{type:"Polygon",coordinates:[[[0,0],[0,0],[0,0]]]}}),document.getElementById("cameraButton")?.style&&(document.getElementById("cameraButton").style.display="none"),e.lastUserLngLat=null,e.userHeading=null,e.lastSmoothedHeading=null,t(a||"GPS stopped"),e._notifiedStart=!1,e.emit("gps-stop"),document.getElementById("gpsButton")?.classList.remove("active")}document.addEventListener("DOMContentLoaded",()=>{const n=document.getElementById("gpsButton");n&&!n.__llBound&&(n.__llBound=!0,n.addEventListener("click",()=>{null==e.gpsWatchId?function(){if(t("Activating GPS...",2e3),!navigator.geolocation)return void t("Geolocation not supported on this device",5e3);if(!window.map)return void t("Please wait - map is still loading",5e3);o(),async function(){if(!e.headingListenerAttached){e._onOrientation=t=>{let o;if("number"==typeof t?.webkitCompassHeading)o=t.webkitCompassHeading;else{if("number"!=typeof t?.alpha)return;o=(360-t.alpha)%360}e.userHeading=a(o),e.lastUserLngLat&&i(e.lastUserLngLat[0],e.lastUserLngLat[1])};try{if("https:"!==location.protocol&&"localhost"!==location.hostname&&t("Tip: enable HTTPS to access compass on iOS",3500),window.DeviceOrientationEvent&&"function"==typeof DeviceOrientationEvent.requestPermission){if("granted"!==await DeviceOrientationEvent.requestPermission())return void t("Compass permission denied",4e3);window.addEventListener("deviceorientation",e._onOrientation,!0)}else"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",e._onOrientation,!0):window.addEventListener("deviceorientation",e._onOrientation,!0);e.headingListenerAttached=!0}catch(e){console.warn("Heading listener setup failed:",e),t("Unable to access compass data",4e3)}}}(),document.getElementById("cameraButton")?.style&&(document.getElementById("cameraButton").style.display="block"),null!==e.gpsWatchId&&navigator.geolocation.clearWatch(e.gpsWatchId);e.gpsWatchId=navigator.geolocation.watchPosition(o=>{const{latitude:n,longitude:r,accuracy:s,heading:c}=o.coords;e.lastUserLngLat=[r,n],e._notifiedStart||(e._notifiedStart=!0,e.emit("gps-start"),(async(e,t)=>{if(window.supabaseClient)try{const{error:a}=await window.supabaseClient.from("location_logs").insert({lat:t,lng:e,browser:navigator.userAgent,timestamp:(new Date).toISOString(),client_id:CURRENT_CLIENT});a&&console.error("Failed to log location:",a)}catch(e){console.error("Location logging error:",e)}})(r,n)),c&&!e.userHeading&&(e.userHeading=a(c)),i(r,n,s),e.hasInitialFly||(e.hasInitialFly=!0,map.flyTo({center:[r,n],zoom:17,speed:1.2,curve:1.5}),t("GPS active - tracking your location",3e3))},e=>{let t="GPS error";switch(e.code){case e.PERMISSION_DENIED:t="Please enable location permissions";break;case e.POSITION_UNAVAILABLE:t="Location signal lost";break;case e.TIMEOUT:t="GPS timeout - try moving outdoors"}r(t)},{enableHighAccuracy:!0,maximumAge:2e3,timeout:1e4}),null!==e.gpsWatchId&&t("GPS activated successfully",2e3),document.getElementById("gpsButton")?.classList.add("active")}():r()}))})})()</script><script>function toggleAuthButtons(t){document.getElementById("cycleAvailabilityBtn"),document.getElementById("addPinBtn"),document.getElementById("gpsButton"),document.getElementById("driveBtn"),document.getElementById("compareBtn"),document.getElementById("editBtn");console.log("Toggle buttons - Authenticated:",t)}document.addEventListener("DOMContentLoaded",function(){console.log("DOM loaded - showing all buttons for YC demo");const t=setInterval(function(){window.supabaseClient&&"function"==typeof window.supabaseClient.auth.getSession&&(clearInterval(t),window.supabaseClient.auth.getSession().then(({data:{session:t}})=>{const e=!(!t||!t.user);console.log("Initial auth check - Authenticated:",e)}))},100)});const setupAuthListener=setInterval(function(){window.supabaseClient&&"function"==typeof window.supabaseClient.auth.onAuthStateChange&&(clearInterval(setupAuthListener),window.supabaseClient.auth.onAuthStateChange((t,e)=>{const n=!(!e||!e.user);console.log("Auth state changed - Authenticated:",n)}))},100)</script><script>(()=>{const t=[-100.15994,25.461823];function n(n){n&&n.preventDefault&&n.preventDefault(),function([t,n]){const e=/iPad|iPhone|Macintosh/.test(navigator.userAgent)?`https://maps.apple.com/?daddr=${n},${t}&dirflg=d`:`https://www.google.com/maps/dir/?api=1&destination=${n},${t}&travelmode=driving&dir_action=navigate`;window.open(e,"_blank")}(t)}function e(){const t=document.getElementById("driveBtn");t&&!t.dataset.bound&&(t.addEventListener("click",n),t.dataset.bound="1")}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e):e()})()</script><script>(()=>{const e=document.getElementById("lotModal"),t=document.getElementById("unitControls");if(!e||!t)return;let o=null;const r=Array.from(t.querySelectorAll(".unit-btn"));function a(e){if(!0===e.sold)return!0;const t=[e.availability,e.status,e.state,e.availability_status,e.sale_status,e.disponibilidad];for(const e of t)if("string"==typeof e){const t=e.normalize("NFKD").replace(/\p{Diacritic}/gu,"").trim().toLowerCase();if(/(^|[^a-z])(sold|vendido|ocupado)([^a-z]|$)/.test(t))return!0}return!1}function n(t){if(r.forEach(e=>e.classList.remove("active")),o===t)o=null,e.dataset.mode="",i();else{o=t,e.dataset.mode=t;const n=r.find(e=>e.dataset.mode===t);n&&n.classList.add("active"),function(e){if(!Array.isArray(baseLots)||0===baseLots.length)return;let t=[...baseLots];switch("num"===e&&(t=t.filter(e=>!a(e))),"name"!==e&&"alpha"!==e&&"alphabet"!==e||(t=t.filter(e=>!a(e))),"area"===e&&(t=t.filter(e=>!a(e))),"price"===e&&(t=t.filter(e=>!a(e))),e){case"num":t.sort((e,t)=>(e.number||0)-(t.number||0));break;case"name":case"alpha":case"alphabet":t.sort((e,t)=>String(e.name||"").localeCompare(String(t.name||""),void 0,{numeric:!0,sensitivity:"base"}));break;case"area":t.sort((e,t)=>(parseFloat(t.size)||0)-(parseFloat(e.size)||0));break;case"price":t.sort((e,t)=>{const o=e=>{if(!e.priceM2||!e.size)return parseFloat(e.price)||0;const t=parseFloat(e.priceM2)*parseFloat(e.size);return 1e3*Math.round(t/1e3)/1e3};return o(t)-o(e)});break;default:return}baseLots=t,"function"==typeof updateLotsArray&&updateLotsArray(),"function"==typeof render&&render();try{"function"==typeof highlightCenter&&highlightCenter(),"function"==typeof updateScrollbar&&updateScrollbar()}catch{}"function"==typeof scrollToBaseIndex&&baseLots.length&&scrollToBaseIndex(0,!0)}(t)}}function i(){if(window.compareMode){const e=document.getElementById("compareBtn");if(e&&e.classList.remove("active"),window.compareMode=!1,window.selectedLots.clear(),"function"==typeof removeEditOutlines&&removeEditOutlines(),showToaster("Compare mode OFF"),console.log("Compare mode OFF (auto-exited from unsort)"),window.originalBaseLots)return baseLots=[...window.originalBaseLots],window.originalBaseLots=null,updateLotsArray(),"function"==typeof render&&render(),"function"==typeof highlightCenter&&highlightCenter(),void("function"==typeof updateScrollbar&&updateScrollbar())}const t=(e.dataset.fracc||"").toString().trim();Array.isArray(window.baseLotsAll)&&(baseLots=window.baseLotsAll.filter(e=>!t||(e.fraccionamiento||"").toString().trim()===t),updateLotsArray(),"function"==typeof render&&render(),"function"==typeof highlightCenter&&highlightCenter(),"function"==typeof updateScrollbar&&updateScrollbar())}window.resetUnitButtons=function(){o=null,e.dataset.mode="",r.forEach(e=>e.classList.remove("active")),i()},r.forEach(e=>e.addEventListener("click",()=>n(e.dataset.mode)))})()</script><script>(()=>{const s=document.getElementById("lotModal");if(!s)return;const t=()=>{const t=s.classList.contains("show")||s.classList.contains("expanded")||s.classList.contains("pin-mode")||s.classList.contains("info-mode")||s.classList.contains("lot-mode");document.body.classList.toggle("modal-open",t)};t(),new MutationObserver(t).observe(s,{attributes:!0,attributeFilter:["class"]});new ResizeObserver(t).observe(s)})()</script><script>!function(){const t=document.getElementById("communitySearchBtn"),e=document.getElementById("communityCircleMenu");if(!t||!e)return;const o=[{id:"positionFour",label:"Barcelona",center:[-96.035272,19.046439],zoom:16.2,fracc:"barcelona",position:1},{id:"positionTwo",label:"Marsella",center:[-96.038183,19.047528],zoom:16.4,fracc:"marsella",position:7}],n=getComputedStyle(document.documentElement),a=parseFloat(n.getPropertyValue("--btn"))||56,i=(parseFloat(n.getPropertyValue("--orbit-diam"))||160)/2-a/2;e.innerHTML="";for(let t=0;t<8;t++){const n=document.createElement("button");n.className="community-option",n.type="button";const a=o.find(e=>e.position===t);a?(n.dataset.community=a.id,n.textContent=a.label,n.style.display="flex"):n.style.display="none",e.appendChild(n);const s=(0+45*t-90)*Math.PI/180,l=e.clientWidth/2,r=e.clientHeight/2;n.style.left=l+i*Math.cos(s)+"px",n.style.top=r+i*Math.sin(s)+"px",a&&n.addEventListener("click",t=>{t.stopPropagation();const o=a;if(o.center&&window.map){map.flyTo({center:o.center,zoom:o.zoom||16.2,speed:1.2,curve:1.5});const t=document.getElementById("lotModal");t&&t.classList.contains("show")&&(t.dataset.fracc=o.fracc||"","function"==typeof window.resetUnitButtons&&window.resetUnitButtons()),"function"==typeof window.showToaster&&showToaster(`Navegando a ${o.label}`)}e.classList.remove("active"),c=!1})}let c=!1;t.addEventListener("click",t=>{t.stopPropagation(),c=!c,e.classList.toggle("active",c)}),document.addEventListener("click",()=>{c&&(c=!1,e.classList.remove("active"))}),e.addEventListener("click",t=>t.stopPropagation())}()</script><script>function setupShareButton(){const e=document.getElementById("shareButton");e&&e.addEventListener("click",function(){shareCurrentLot()})}function shareCurrentLot(){let e="",t="";const o=document.querySelector(".lot-details.active");if(o){const n=o.querySelector(".lote-number");if(n){t=n.textContent.trim();const a=o.querySelector('div[style*="font-size: 14px"]');if(a&&a.textContent.includes("ID:")){const t=a.textContent.match(/ID:\s*(\S+)/);t&&(e=t[1])}}}if(t&&!e){const o=lotData.find(e=>extractLotNumber(e.name)===t);o&&(e=o.name)}if(!e&&"undefined"!=typeof currentLotIndex&&-1!==currentLotIndex){const o=lotData[currentLotIndex];o&&(e=o.name,t=extractLotNumber(o.name))}if(!e){const o=document.querySelector(".info-row.center .lote-number");if(o){t=o.textContent.trim();const n=lotData.find(e=>extractLotNumber(e.name)===t);n&&(e=n.name)}}if(!e)return console.warn("No lot found to share"),void showToaster("Selecciona un lote para compartir");const n=document.getElementById("downPaymentCalc")?.value||"20",a=document.getElementById("installmentsCalc")?.value||"72",i=`${window.location.origin}/inverta/lot/${t}.html?downpayment=${n}&months=${a}`,s=`Te comparto el Lote ${t} de Inverta`;console.log("üîó Share attempt:",{lotName:e,lotNumber:t,shareUrl:i});if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){const e=`https://wa.me/?text=${encodeURIComponent(s+" "+i)}`;window.open(e,"_blank"),showToaster("Opening WhatsApp... üì±")}else navigator.share?setTimeout(()=>{navigator.share({title:`Lote ${t} - Lalaland`,text:s,url:i}).then(()=>{console.log("‚úÖ Share successful"),showToaster("Shared successfully! üì§")}).catch(e=>{console.log("‚ùå Share failed or cancelled:",e),"AbortError"!==e.name&&fallbackShare(i,t)})},100):fallbackShare(i,t)}function fallbackShare(e,t){navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(e).then(()=>{showToaster(`Link to Lote ${t} copied! üìã`)}).catch(()=>{copyViaPrompt(e,t)}):copyViaPrompt(e,t)}function copyViaPrompt(e,t){const o=document.createElement("input");o.value=e,document.body.appendChild(o),o.select(),o.setSelectionRange(0,99999);try{const n=document.execCommand("copy");document.body.removeChild(o),n?showToaster(`Link to Lote ${t} copied! üìã`):showToaster(`Select and copy this link:\n${e}`)}catch(t){document.body.removeChild(o),showToaster(`Share this link:\n${e}`)}}function isBusinessHours(){const e=(new Date).toLocaleString("en-US",{timeZone:"America/Mexico_City",hour:"2-digit",hour12:!1,weekday:"long"}),[t,o]=e.split(", "),n=parseInt(o);console.log("Mexico City time:",{weekday:t,hour:n});return["Monday","Tuesday","Wednesday","Thursday","Friday"].includes(t)&&(n>=8&&n<20)}function isBusinessHoursSimple(){const e=new Date,t=e.getUTCHours(),o=e.getUTCDay(),n=(t-6+24)%24,a=o>=1&&o<=5,i=n>=8&&n<20;return console.log("Simple check:",{utcHour:t,mexicoCityHour:n,utcDay:o,isWeekday:a,isBusinessHour:i}),a&&i}function isBusinessHours(){return isBusinessHoursSimple()}function updateChatHeaderVisibility(){const e=document.querySelector('.cta-header-label[style*="color:#ff8400"]');if(e){isBusinessHours()?(e.innerHTML='\n<svg width="12" height="12" viewBox="0 0 24 24" fill="#ff8400" style="margin-right:4px; vertical-align:middle;">\n  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>\n</svg>\n        DISPONIBLE AHORA\n      ',e.style.visibility="visible",e.style.opacity="1"):(e.style.visibility="hidden",e.style.opacity="0")}}function setupChatButton(){const e=document.getElementById("chatearBtn");e&&e.addEventListener("click",function(e){e.preventDefault(),e.stopPropagation(),window.open("https://wa.me/5212292233911","_blank")})}function initChatAvailability(){updateChatHeaderVisibility(),setupChatButton(),setInterval(updateChatHeaderVisibility,6e4)}function initChatAvailability(){updateChatHeaderVisibility(),setupChatButton(),setInterval(updateChatHeaderVisibility,6e4)}setTimeout(()=>{function e(){return new URLSearchParams(window.location.search).get("lot")}function t(){const e=window.communities||{barcelona:{center:[-96.035272,19.046439],zoom:16.2},marsella:{center:[-96.038183,19.047528],zoom:16.4}},t=document.getElementById("lotModal");let o=(t?.dataset.fracc||"").trim().toLowerCase();if(e[o])return e[o].center;if(window.selectedLots.size>0){const t=Array.from(window.selectedLots).pop(),o=lotData.find(e=>e.name===t);if(o&&o.fraccionamiento){const t=o.fraccionamiento.toLowerCase();if(e[t])return e[t].center}}return map?function(e,t){let o=null,n=1/0;return Object.keys(t).forEach(a=>{const i=t[a].center,s=turf.distance(turf.point([e.lng,e.lat]),turf.point(i),{units:"kilometers"});s<n&&(n=s,o=a)}),t[o].center}(map.getCenter(),e):e[Object.keys(e)[0]].center}function o(){if(window.poiModeActive)return;const e=document.getElementById("lotModal");if(!e)return;if(window.compareMode){const e=document.getElementById("compareBtn");e&&e.classList.remove("active"),window.compareMode=!1,window.selectedLots.clear(),"function"==typeof removeEditOutlines&&removeEditOutlines(),console.log("Compare mode OFF (modal closed with zoom reset)"),window.originalBaseLots&&(baseLots=[...window.originalBaseLots],window.originalBaseLots=null)}const o=document.getElementById("viewer-container");o&&(o.style.display="none"),function(){const e=new URL(window.location);e.searchParams.delete("lot"),window.history.replaceState(null,"",e)}(),removeSideLengthLabels();const n=t(),a=function(){const e=document.getElementById("lotModal");return{barcelona:16.2,marsella:16.4}[(e?.dataset.fracc||"").trim().toLowerCase()]||(window.innerWidth>=768?17:16.45)}();map&&map.flyTo({center:n,zoom:a,bearing:0,pitch:0,speed:1.2,curve:1.5});const i=document.querySelector(".modal-content-wrapper"),s=document.getElementById("lotDetails"),l=document.getElementById("backButton"),r=document.getElementById("headerLotNumber"),c=document.querySelector(".plus-button"),d=document.querySelector(".bottom-plus-button");i&&i.classList.remove("show-details"),s&&(s.classList.remove("active"),s.style.display="block",s.innerHTML=""),l&&(l.style.display="none"),r&&(r.style.display="none"),c&&(c.style.display="none"),d&&(d.style.display="none");const u=document.getElementById("calendlyEmbed");u&&(u.style.display="none");const m=document.getElementById("shareButton");m&&(m.style.display="none");const p=document.getElementById("globalDashboardButton");p&&(p.classList.remove("active"),p.style.display="none");const h=document.getElementById("dashboard-btn"),y=document.getElementById("eye-open-icon"),f=document.getElementById("eye-closed-icon");if(h&&(console.log("closeModalWithZoomReset: Resetting dashboard button state"),h.classList.remove("active"),y&&(y.style.display="none"),f&&(f.style.display="inline-block")),window.isDashboardOpen=!1,e.classList.remove("show","info-mode","pin-mode","expanded","lot-mode"),map&&map.getSource("lots-final")&&null!==window.hoveredId)try{map.setFeatureState({source:"lots-final",id:window.hoveredId},{hover:!1})}catch{}setTimeout(()=>{if(e.style.display="none",document.getElementById("communitySearchBtn")?.classList.remove("hide"),document.getElementById("lalalandInfoBtn")?.classList.remove("hide"),map&&map.getSource("lots-final"))try{null!==window.hoveredId&&map.setFeatureState({source:"lots-final",id:window.hoveredId},{hover:!1}),lotData.forEach((e,t)=>{try{map.setFeatureState({source:"lots-final",id:t},{hover:!1})}catch{}}),window.hoveredId=null}catch{}requestAnimationFrame(()=>{map&&map.getSource("lots-final")&&lotData.forEach((e,t)=>{try{map.setFeatureState({source:"lots-final",id:t},{hover:!1})}catch{}})})},50),isDetailOpen=!1,scrollHandlerAttached=!0}window.addEventListener("popstate",function(){const t=e();if(t){const e=lotData.find(e=>e.name===t)||lotData.find(e=>extractLotNumber(e.name)===t.replace(/^lot/i,""));if(e&&e.center&&map){const[t,o]=e.center,n=window.innerWidth>=768,a=n?310:0,i=n?0:180;document.getElementById("lotModal").classList.contains("show")?(map.flyTo({center:[t,o],zoom:18.8,speed:1.2,curve:1.5,offset:[a,i]}),map.once("moveend",()=>{if(removeSideLengthLabels(),isDetailOpen){const t=baseLots.findIndex(t=>t.number===extractLotNumber(e.name));if(-1!==t){const o=document.querySelector(".plus-button");o&&(o.style.display="none");const n=lotData.findIndex(t=>t.name===e.name);-1!==n&&(currentLotIndex=n,null!==window.hoveredId&&map.setFeatureState({source:"lots-final",id:window.hoveredId},{hover:!1}),map.setFeatureState({source:"lots-final",id:n},{hover:!0}),window.hoveredId=n),showDetailViewForLot(t+cloneCount,!0)}}})):(openModal(e),setTimeout(()=>{map.flyTo({center:[t,o],zoom:18.8,speed:1.2,curve:1.5,offset:[a,i]}),map.once("moveend",()=>{removeSideLengthLabels(),setTimeout(()=>{const t=baseLots.findIndex(t=>t.number===extractLotNumber(e.name));if(-1!==t){const o=document.querySelector(".plus-button");o&&(o.style.display="none");const n=lotData.findIndex(t=>t.name===e.name);-1!==n&&(currentLotIndex=n,null!==window.hoveredId&&map.setFeatureState({source:"lots-final",id:window.hoveredId},{hover:!1}),map.setFeatureState({source:"lots-final",id:n},{hover:!0}),window.hoveredId=n),showDetailViewForLot(t+cloneCount)}},400)})},100))}}else o()}),window.closeModal=o,function(){const t=e();if(t){console.log("üîó Opening lot from URL:",t);let e=lotData.find(e=>e.name===t);if(!e){const o=t.replace(/^lot/i,"");e=lotData.find(e=>extractLotNumber(e.name)===o)}if(e){console.log("üîó Found lot:",e.name,"Center:",e.center);const t=2300;console.log("üîó Waiting for lot animation to complete:",t+"ms"),setTimeout(()=>{if(console.log("üîó Lot animation complete, opening modal..."),e.center&&map){const[t,o]=e.center,n=window.innerWidth>=768,a=n?310:0,i=n?0:180;openModal(e),setTimeout(()=>{map.flyTo({center:[t,o],zoom:18.8,speed:1.2,curve:1.5,offset:[a,i]}),map.once("moveend",()=>{console.log("üîó Map zoom completed with modal open"),setTimeout(()=>{const t=baseLots.findIndex(t=>t.number===extractLotNumber(e.name));if(-1!==t){const o=document.querySelector(".plus-button");o&&(o.style.display="none"),showDetailViewForLot(t+cloneCount);const n=lotData.findIndex(t=>t.name===e.name);-1!==n&&(currentLotIndex=n,null!==window.hoveredId&&map.setFeatureState({source:"lots-final",id:window.hoveredId},{hover:!1}),map.setFeatureState({source:"lots-final",id:n},{hover:!0}),window.hoveredId=n)}},400)})},100)}},t)}else console.warn("Lot not found:",t)}}(),console.log("üîó Deep linking initialized - fracc-aware close behavior")},2e3),document.addEventListener("DOMContentLoaded",function(){setTimeout(setupShareButton,1e3)})</script><script>function handleEditClick(e){if(!window.compareMode)return!1;if(map.queryRenderedFeatures(e.point,{layers:["marbles-click-layer"]}).length>0)return!1;if(console.log("Compare click detected"),e.features&&e.features.length>0){const o=e.features[0].properties.name,t=extractLotNumber(o);return window.selectedLots.has(o)?(window.selectedLots.delete(o),showToaster(`‚ùå Removed ${t}`)):(window.selectedLots.add(o),showToaster(`‚úÖ Added ${t}`)),console.log("Selected lots:",Array.from(window.selectedLots)),updateEditOutlines(),updateModalList(),e.preventDefault(),e.originalEvent&&e.originalEvent.stopPropagation(),!0}return!1}function updateEditOutlines(){removeEditOutlines(),map&&0!==window.selectedLots.size&&window.selectedLots.forEach(e=>{const o=lotData.find(o=>o.name===e);if(o){const t=`edit-outline-${e}`,d=`edit-outline-layer-${e}`;map.getLayer(d)&&map.removeLayer(d),map.getSource(t)&&map.removeSource(t);const s=[...o.coords];s[0][0]===s[s.length-1][0]&&s[0][1]===s[s.length-1][1]||s.push(s[0]),map.addSource(t,{type:"geojson",data:{type:"Feature",geometry:{type:"Polygon",coordinates:[s]}}}),map.addLayer({id:d,type:"fill",source:t,paint:{"fill-color":"#fcfaf3","fill-opacity":.4}},"lots-final-click")}})}function removeEditOutlines(){if(map)try{const e=map.getStyle();if(!e||!e.layers)return;e.layers.forEach(e=>{if(e.id&&e.id.startsWith("edit-outline-layer-"))try{map.getLayer(e.id)&&map.removeLayer(e.id)}catch(o){console.log("Could not remove layer:",e.id)}}),Object.keys(e.sources||{}).forEach(e=>{if(e.startsWith("edit-outline-"))try{map.getSource(e)&&map.removeSource(e)}catch(o){console.log("Could not remove source:",e)}})}catch(e){console.log("Error removing edit outlines:",e)}}function updateModalList(){const e=document.getElementById("lotModal"),o=document.getElementById("modalInfo");if(0===window.selectedLots.size)return void(e.classList.contains("show")&&(o.innerHTML='<div style="padding:20px; text-align:center; color:#8a8880;">Select lots to compare</div>',window.originalBaseLots&&(baseLots=window.originalBaseLots,updateLotsArray(),window.originalBaseLots=null)));e.classList.contains("show")||(e.classList.add("show","lot-mode"),e.style.display="block",adjustMapForModal(),document.getElementById("communitySearchBtn")?.classList.add("hide"),document.getElementById("lalalandInfoBtn")?.classList.add("hide"));const t=[];let d=new Set;if(window.selectedLots.forEach(e=>{const o=extractLotNumber(e),s=window.baseLotsAll.find(e=>e.number===o);s&&(t.push({...s}),s.fraccionamiento&&d.add(s.fraccionamiento))}),console.log("Selected base lots:",t),console.log("Unique communities:",Array.from(d)),t.length>0){let o;window.originalBaseLots||(window.originalBaseLots=[...baseLots]),baseLots=t,updateLotsArray(),o=1===d.size?Array.from(d)[0].toUpperCase():d.size>1?"MULTIPLE COMMUNITIES":"COMPARING LOTS",document.getElementById("headerFracc").textContent=o,e.dataset.fracc="multiple",render()}}window.window.editMode=!1,window.compareMode=!1,window.window.selectedLots=new Set,document.getElementById("compareBtn").addEventListener("click",function(){if(window.compareMode=!window.compareMode,window.compareMode){this.classList.add("active"),showToaster("üîç Compare mode ON - Click lots to compare"),console.log("Compare mode ON");const e=document.querySelector(".info-row.center, .info-row.active");if(e){const o=parseInt(e.dataset.baseIndex,10);if(!isNaN(o)&&o>=0&&baseLots[o]){const e=`lot${baseLots[o].number}`;window.window.selectedLots.add(e),console.log("Auto-selected centered lot:",e),"function"==typeof updateEditOutlines&&updateEditOutlines()}}isDataLoaded||fetchLots().then(()=>{console.log("Data loaded for compare mode")})}else this.classList.remove("active"),window.window.selectedLots.clear(),removeEditOutlines(),window.originalBaseLots&&(baseLots=window.originalBaseLots,updateLotsArray(),window.originalBaseLots=null),isDataLoaded&&render(),showToaster("Compare mode OFF"),console.log("Compare mode OFF")}),document.getElementById("editBtn").addEventListener("click",function(){window.editMode=!window.editMode,window.editMode?(this.style.boxShadow="0 0 0 3px rgba(255,132,0,1)",this.style.backgroundColor="#ff8400",showToaster("‚úèÔ∏è Edit mode ON - Edit prices in detail view"),console.log("Edit mode ON")):(this.style.boxShadow="",this.style.backgroundColor="#fcfaf3",showToaster("Edit mode OFF"),console.log("Edit mode OFF"))}),map&&map.on("move",function(){window.compareMode&&window.selectedLots.size})</script><script>function calculateDistance(e,t){const n=(t[1]-e[1])*Math.PI/180,o=(t[0]-e[0])*Math.PI/180,a=e[1]*Math.PI/180,r=t[1]*Math.PI/180,i=Math.sin(n/2)**2+Math.cos(a)*Math.cos(r)*Math.sin(o/2)**2;return 12742e3*Math.atan2(Math.sqrt(i),Math.sqrt(1-i))}function bearingDeg(e,t){const n=e=>e*Math.PI/180,o=n(e[1]),a=n(t[1]),r=n(e[0]),i=n(t[0]),s=Math.sin(i-r)*Math.cos(a),l=Math.cos(o)*Math.cos(a)*Math.cos(i-r)-Math.sin(o)*Math.sin(a);return(180*Math.atan2(s,l)/Math.PI+360)%360}function angularDiffDeg(e,t){let n=Math.abs(e-t)%360;return n>180?360-n:n}function findClosestPointOnSegment(e,t,n){const o=t[0],a=t[1],r=n[0],i=n[1],s=e[0],l=e[1],c=r-o,d=i-a,u=c*c+d*d;let m=u?((s-o)*c+(l-a)*d)/u:0;m=Math.max(0,Math.min(1,m));return{point:[o+c*m,a+d*m],distance:Math.sqrt(u)*m}}function findClosestPointOnRoute(e,t){let n=null,o=1/0,a=0;for(let r=1;r<t.length;r++){const i=t[r-1],s=t[r],l=calculateDistance(i,s),c=findClosestPointOnSegment(e,i,s),d=calculateDistance(e,c.point);d<o&&(o=d,n={point:c.point,distance:a+c.distance}),a+=l}return n}function destFromBearingDistance(e,t,n,o){const a=6378137,r=degToRad(n),i=degToRad(e),s=degToRad(t),l=Math.asin(Math.sin(i)*Math.cos(o/a)+Math.cos(i)*Math.sin(o/a)*Math.cos(r));return[radToDeg(s+Math.atan2(Math.sin(r)*Math.sin(o/a)*Math.cos(i),Math.cos(o/a)-Math.sin(i)*Math.sin(l))),radToDeg(l)]}function radToDeg(e){return 180*e/Math.PI}function degToRad(e){return e*Math.PI/180}function initializeViewer(){console.log("360 Viewer system ready"),setupViewerEventListeners(),loadGPXFromManifest()}function initThreeJSViewer(){if(viewerInitialized)return;console.log("üîÑ Initializing Three.js viewer...");const e=document.getElementById("viewer-container"),t=document.getElementById("canvas");if(!e||!t)return void console.error("‚ùå Viewer container or canvas not found");let n=e.clientWidth||t.clientWidth||800,o=e.clientHeight||t.clientHeight||600;t.width=n,t.height=o,scene=new THREE.Scene,panoGroup=new THREE.Group,scene.add(panoGroup),camera=new THREE.PerspectiveCamera(currentFov,n/o,.1,1e3),camera.position.set(0,0,.1),renderer=new THREE.WebGLRenderer({canvas:t,antialias:!0,alpha:!1,powerPreference:"high-performance"});const a=Math.min(window.devicePixelRatio||4,4);renderer.setPixelRatio(a),renderer.setSize(n,o,!1),console.log("‚úÖ Three.js initialized successfully"),viewerInitialized=!0,animateViewer()}function animateViewer(){if(viewerInitialized&&(requestAnimationFrame(animateViewer),updateNavigationRing(),renderer&&scene&&camera))try{renderer.render(scene,camera)}catch(e){}}function setupViewerEventListeners(){const e=document.getElementById("canvas");if(!e)return;let t=!1,n=0,o=0,a=0,r=0,i=0;e.addEventListener("mousedown",a=>{t=!0,n=a.clientX,o=a.clientY,e.style.cursor="grabbing",document.body.classList.add("dragging-pano")}),e.addEventListener("mousemove",e=>{if(!t||!sphere)return;const a=e.clientX-n,r=e.clientY-o;sphere.rotation.y-=.01*a,sphere.rotation.x-=.01*r,currentYaw=sphere.rotation.y,currentPitch=sphere.rotation.x,n=e.clientX,o=e.clientY,updateNavigationRing(),updateViewCone(),refreshBranchButtons()}),e.addEventListener("mouseup",()=>{t=!1,setTimeout(()=>{e.style.cursor="grab"},50),document.body.classList.remove("dragging-pano")}),e.addEventListener("mouseenter",()=>{e.style.cursor="grab"}),e.addEventListener("mouseleave",()=>{t=!1,e.style.cursor="default"}),e.addEventListener("wheel",handleWheelZoom,{passive:!1}),e.addEventListener("touchstart",e=>{if(e.preventDefault(),1==e.touches.length&&(a=e.touches[0].clientX,r=e.touches[0].clientY),2==e.touches.length){const t=e.touches[0].clientX-e.touches[1].clientX,n=e.touches[0].clientY-e.touches[1].clientY;i=Math.sqrt(t*t+n*n)}},{passive:!1}),e.addEventListener("touchmove",e=>{if(1==e.touches.length&&sphere){const t=e.touches[0].clientX-a,n=e.touches[0].clientY-r;sphere.rotation.y-=.01*t,sphere.rotation.x-=.01*n,currentYaw=sphere.rotation.y,currentPitch=sphere.rotation.x,a=e.touches[0].clientX,r=e.touches[0].clientY,updateNavigationRing(),updateViewCone(),refreshBranchButtons()}if(2==e.touches.length){const t=e.touches[0].clientX-e.touches[1].clientX,n=e.touches[0].clientY-e.touches[1].clientY,o=Math.sqrt(t*t+n*n);if(i>0){const e=i-o,t=2;currentFov=Math.max(30,Math.min(120,currentFov+e*t*.1)),camera.fov=currentFov,camera.updateProjectionMatrix(),i=o,updateViewCone()}}}),e.addEventListener("touchend",e=>{e.preventDefault(),a=0,r=0,i=0},{passive:!1})}function handleWheelZoom(e){e.preventDefault(),e.stopPropagation();const t=0===e.deltaMode?2:60,n=e.deltaY>0?t:-t,o=currentFov;currentFov=Math.max(30,Math.min(120,currentFov+n)),currentFov!==o&&(camera.fov=currentFov,camera.updateProjectionMatrix(),updateViewCone(),renderer&&renderer.render(scene,camera))}function updateNavigationRing(e=!1){const t=document.querySelector(".navigation-ring"),n=document.getElementById("nextImageBtn"),o=document.getElementById("prevImageBtn"),a=document.getElementById("branchImageBtn");if(!t||!sphere)return;const r=THREE.MathUtils.radToDeg(currentYaw);t.style.transform=`rotateZ(${-r}deg)`;const i=getCurrentTrack();if(!i||!selectedMarbleId)return;const s=i.marbles.findIndex(e=>e.id===selectedMarbleId),l=i.marbles.length;let c=!1,d=!1,u=!1;if(s<l-1&&(c=!0),s>0&&(d=!0),s>0&&s<l-1){c=!!getBestMarbleInDirection(currentYaw),d=!!getBestMarbleInDirection(currentYaw+Math.PI)}const m=navGraph.get(selectedMarbleId)||[];m.length>2&&(c=!0,d=!0);const p=0===s||s===l-1,g=m.length;u=p&&g>=2||g>2;shouldShowBranchAtBottom()?t.classList.add("has-branch"):t.classList.remove("has-branch"),n.disabled=!c,o.disabled=!d,a.disabled=!u,n.style.opacity=c?1:0,o.style.opacity=d?1:0,a.style.opacity=u?1:0,e&&(t.style.transition="none",requestAnimationFrame(()=>t.style.transition=""))}function shouldShowBranchAtBottom(){if(!selectedMarbleId)return!1;const e=getCurrentTrack();if(!e)return!1;const t=e.marbles.findIndex(e=>e.id===selectedMarbleId);if(!(0===t||t===e.marbles.length-1))return!1;const n=navGraph.get(selectedMarbleId)||[],o=0===t?1:t-1,a=e.marbles[o];return n.filter(e=>e.toMarbleId!==a?.id).length>0}function getBestMarbleInDirection(e){if(!selectedMarbleId)return null;const t=getFacingOptions(selectedMarbleId,e,1);if(!t.length)return null;const n=getCurrentTrack().marbles.find(e=>e.id===t[0].toMarbleId);return n?{index:n.index,distance:t[0].distanceM}:null}function getFacingOptions(e,t,n=3){const o=navGraph.get(e)||[],a=(THREE.MathUtils.radToDeg(t)+360)%360;return o.map(e=>{const t=angularDiffDeg(a,e.bearingDeg);let n=t;if(null!=lastHopBearingDeg){n+=.3*angularDiffDeg(lastHopBearingDeg,e.bearingDeg)}const o=[...allTracks.entries()].find(([t,n])=>n.marbles.some(t=>t.id===e.toMarbleId))?.[0],r=getCurrentTrack()?.id;return o===r&&e.distanceM<8?n+=20:n+=.001*e.distanceM,{...e,angleToView:t,score:n}}).sort((e,t)=>e.score-t.score).slice(0,n)}async function loadGPXFromManifest(){try{const e=FRAMES_BASE+"index.json",t=await fetch(e,{cache:"no-store"});if(!t.ok)return void console.log("No predefined tracks found");const n=await t.json();window.yawFixesByFile=n.yawfixes||{},console.log("Yaw fixes loaded:",window.yawFixesByFile);let o=[];if(n.gpxFiles&&n.gpxFiles.length?o=n.gpxFiles:n.files&&(o=n.files.filter(e=>e.toLowerCase().endsWith(".gpx"))),!o.length)return void console.log("No GPX files in manifest");let a=0;for(const e of o)try{await loadSingleGPX(e),a++}catch(t){console.error("Failed GPX:",e,t)}if(a>0&&allTracks.size>0){selectTrack(Array.from(allTracks.keys())[0]),console.log(`Loaded ${a} GPX files with marbles`)}}catch(e){console.error("Error loading manifest:",e)}}async function loadSingleGPX(e){const t=e.startsWith(FRAMES_BASE)?e:FRAMES_BASE+e,n=await fetch(t);if(!n.ok)throw new Error(`HTTP ${n.status}`);const o=e.split("/").pop(),a=window.yawFixesByFile?.[o]??0;console.log(`Applying yaw fix ${a}¬∞ to ${o}`);parseGPX(await n.text(),o,!0,a)}function parseGPX(e,t,n=!1,o=0){const a=(new DOMParser).parseFromString(e,"text/xml"),r=a.querySelectorAll("trkpt"),i=[];if(r.forEach((e,t)=>{const n=parseFloat(e.getAttribute("lat")),o=parseFloat(e.getAttribute("lon")),a=e.querySelector("time");i.push({id:t,coordinates:[o,n],originalIndex:t,time:a?a.textContent:null})}),!i.length)return;const s=`track-${allTracks.size+1}`,l={id:s,name:t.replace(".gpx",""),color:"#4285F4",yawFixDeg:o,originalPoints:i,activePoints:i.map(e=>({...e})),isActive:!1,isPredefined:n,originalStats:calculateOriginalStatsFromPoints(i),marbles:[],marbleSpacing:10};parseWaypointsFromGPX(a,l),allTracks.set(s,l),rebuildNavGraph(),updateMarbleDisplay(),console.log(`Parsed ${t} with ${l.marbles.length} marbles`)}function parseWaypointsFromGPX(e,t){const n=e.querySelectorAll("wpt"),o=getDisplayCoordinates(t);calculateTotalDistance(o);n.forEach((e,n)=>{const a=parseFloat(e.getAttribute("lat")),r=parseFloat(e.getAttribute("lon")),i=e.querySelector("name"),s=e.querySelector("desc"),l=e.querySelector("time"),c=i?i.textContent:`Waypoint_${n+1}`,d=s?s.textContent:"",u=l?l.textContent:null,m={id:Date.now()+n+Math.random(),index:t.marbles.length,position:[r,a],distanceAlongRoute:0,isLocked:!1,isFixed:!1,assignedImage:extractImageIndexFromWaypoint(c,d),isWaypoint:!0,originalName:c,description:d,time:u},p=findClosestPointOnRoute([r,a],o);p&&(m.distanceAlongRoute=p.distance),t.marbles.push(m)}),t.marbles.sort((e,t)=>e.distanceAlongRoute-t.distanceAlongRoute),t.marbles.forEach((e,t)=>{e.index=t})}function getDisplayCoordinates(e){return e.activePoints.map(e=>e.coordinates)}function calculateTotalDistance(e){if(e.length<2)return 0;let t=0;for(let n=1;n<e.length;n++)t+=calculateDistance(e[n-1],e[n]);return t}function calculateOriginalStatsFromPoints(e){const t=e.map(e=>e.coordinates),n=e.map(e=>e.time).filter(Boolean),o=calculateTotalDistance(t),a=calculateDurationFromTimes(n);return{distance:o,duration:a,avgSpeed:calculateAverageSpeedFromStats(o,a),pointCount:e.length}}function calculateDurationFromTimes(e){if(e.length<2)return"0s";const t=new Date(e[0]),n=new Date(e[e.length-1])-t,o=Math.floor(n/36e5),a=Math.floor(n%36e5/6e4),r=Math.floor(n%6e4/1e3);return o>0?`${o}h ${a}m ${r}s`:a>0?`${a}m ${r}s`:`${r}s`}function calculateAverageSpeedFromStats(e,t){if("0s"===t||!e)return 0;const n=t.match(/(\d+)h/),o=t.match(/(\d+)m/),a=t.match(/(\d+)s/),r=(n?+n[1]:0)+(o?+o[1]/60:0)+(a?+a[1]/3600:0);return r>0?e/1e3/r:0}function extractImageIndexFromWaypoint(e,t){const n=(e+" "+t).toLowerCase(),o=n.match(/image[^\d]*(\d+)/);if(o)return parseInt(o[1])-1;const a=n.match(/photo[^\d]*(\d+)/);if(a)return parseInt(a[1])-1;const r=e?.match(/(\d+)$/);return r?parseInt(r[1])-1:null}function selectTrack(e){currentTrackId&&allTracks.has(currentTrackId)&&(allTracks.get(currentTrackId).isActive=!1),currentTrackId=e;const t=allTracks.get(e);t.isActive=!0,updateMarbleDisplay(),load360Images(),console.log(`Selected track: ${t.name}`)}function selectTrackWithoutMapReset(e){currentTrackId&&allTracks.has(currentTrackId)&&(allTracks.get(currentTrackId).isActive=!1),currentTrackId=e;const t=allTracks.get(e);t.isActive=!0,resetViewerOrientationForTrack(t),updateMarbleDisplay(),viewConeMarker&&(viewConeMarker.remove(),viewConeMarker=null),updateNavigationRing(!0),updateViewCone(),load360Images(),console.log(`Switched to track: ${t.name} - ${t.marbles.length} marbles`)}function resetViewerOrientationForTrack(e){e&&panoGroup&&(currentYaw=0,currentPitch=0,panoGroup&&(panoGroup.rotation.y=currentYaw,panoGroup.rotation.x=currentPitch),lastHopBearingDeg=null,console.log(`Orientation reset for track: ${e.name}`))}function getCurrentTrack(){return currentTrackId?allTracks.get(currentTrackId):null}function selectMarble(e){const t=selectedMarbleId;selectedMarbleId=e;const n=getCurrentTrack();if(n){if(t){const o=n.marbles.find(e=>e.id===t),a=n.marbles.find(t=>t.id===e);o&&a&&(lastHopBearingDeg=bearingDeg(o.position,a.position))}updateMarbleDisplay(),updateViewCone(),refreshBranchButtons(),console.log(`Selected marble: ${e}`)}}function deselectMarble(){selectedMarbleId=null,updateMarbleDisplay(),hideViewCone()}function rebuildNavGraph(){navGraph.clear(),allTracks.forEach(e=>{const t=e.marbles;for(let e=0;e<t.length-1;e++){const n=t[e],o=t[e+1],a=calculateDistance(n.position,o.position),r=bearingDeg(n.position,o.position),i=bearingDeg(o.position,n.position);navGraph.has(n.id)||navGraph.set(n.id,[]),navGraph.has(o.id)||navGraph.set(o.id,[]),navGraph.get(n.id).push({toMarbleId:o.id,distanceM:a,bearingDeg:r}),navGraph.get(o.id).push({toMarbleId:n.id,distanceM:a,bearingDeg:i})}t.forEach(e=>{navGraph.has(e.id)||navGraph.set(e.id,[])})});const e=[];allTracks.forEach(t=>t.marbles.forEach(n=>{e.push({trackId:t.id,m:n})}));for(let t=0;t<e.length;t++)for(let n=t+1;n<e.length;n++){const o=e[t].m,a=e[n].m,r=calculateDistance(o.position,a.position);if(r>8)continue;const i=bearingDeg(o.position,a.position),s=bearingDeg(a.position,o.position);navGraph.has(o.id)||navGraph.set(o.id,[]),navGraph.has(a.id)||navGraph.set(a.id,[]),navGraph.get(o.id).push({toMarbleId:a.id,distanceM:r,bearingDeg:i}),navGraph.get(a.id).push({toMarbleId:o.id,distanceM:r,bearingDeg:s})}navGraph.forEach((e,t)=>{const n=new Map;e.forEach(e=>{const t=n.get(e.toMarbleId);(!t||e.distanceM<t.distanceM)&&n.set(e.toMarbleId,e)}),navGraph.set(t,Array.from(n.values()))}),console.log("Navigation graph rebuilt")}function refreshBranchButtons(){const e=document.getElementById("branch-buttons");if(!e)return;if(e.innerHTML="",!selectedMarbleId)return;getFacingOptions(selectedMarbleId,currentYaw).forEach((t,n)=>{const o=document.createElement("button");o.className="small-btn";const a=Math.round(t.distanceM);o.innerHTML=0===n?`Go ‚Üí (${a}<span translate="no">m</span>)`:`Alt ${n+1} ‚Üí`,o.onclick=async()=>{const e=getCurrentTrack();if(!e)return;let n=null,o=null;for(const[e,a]of allTracks)if(n=a.marbles.find(e=>e.id===t.toMarbleId),n){o=a;break}if(!n)return;const a=map.getZoom();o.id!==currentTrackId?(selectTrackWithoutMapReset(o.id),await load360Images(),selectMarble(n.id)):selectMarble(n.id);const r=e.marbles.find(e=>e.id===selectedMarbleId);r&&(lastHopBearingDeg=bearingDeg(r.position,n.position)),null!=n.assignedImage?showMarbleImage(n.id):(map.flyTo({center:n.position,zoom:a,duration:1e3}),console.log(`Moved to marble ${n.index+1}${o.id!==currentTrackId?` in ${o.name}`:""}`)),updateNavigationRing(!0)},e.appendChild(o)})}function updateMarbleDisplay(){const e=map.getSource("marbles");if(!e)return;const t=[];allTracks.forEach((e,n)=>{e.marbles.forEach((e,o)=>{const a=null!==e.assignedImage;t.push({type:"Feature",geometry:{type:"Point",coordinates:e.position},properties:{id:e.id,trackId:n,index:o,isSelected:e.id===selectedMarbleId,hasImage:a}})})}),e.setData({type:"FeatureCollection",features:t})}function setupMapInteractions(){map.on("move",()=>{selectedMarbleId&&updateViewCone()}),map.on("zoom",()=>{selectedMarbleId&&updateViewCone()}),enableMarbleClickOnly()}function enableMarbleClickOnly(){map.off("click","marbles-click-layer",handleMarbleClick),map.off("click",handleMapClickForDeselect),map.on("click","marbles-click-layer",handleMarbleClick),map.on("click",handleMapClickForDeselect)}function handleMarbleClick(e){if(e.originalEvent.stopPropagation(),!e.features?.length)return void deselectMarble();const t=e.features[0].properties.id,n=e.features[0].properties.trackId;n!==currentTrackId?selectTrackAndThenMarble(n,t):(selectMarble(t),showMarbleImage(t))}function handleMapClickForDeselect(e){map.queryRenderedFeatures(e.point,{layers:["marbles-click-layer"]}).length||deselectMarble()}function initConeSystem(){map.getSource("view-cone")||(map.addSource("view-cone",{type:"geojson",data:{type:"Feature",geometry:{type:"Polygon",coordinates:[[[0,0],[0,0],[0,0]]]}}}),map.addLayer({id:"view-cone-fill",type:"fill",source:"view-cone",paint:{"fill-color":"#ff8400","fill-opacity":.5}}),map.addLayer({id:"view-cone-outline",type:"line",source:"view-cone",paint:{"line-color":"#ff6b6b","line-width":2,"line-opacity":0}}))}function hideViewCone(){map&&map.getSource("view-cone")&&map.getSource("view-cone").setData({type:"Feature",geometry:{type:"Polygon",coordinates:[[[0,0],[0,0],[0,0]]]}})}function getHorizontalFovDeg(){const e=document.getElementById("canvas"),t=camera&&camera.aspect||(e&&e.clientHeight?e.clientWidth/e.clientHeight:16/9),n=THREE.MathUtils.degToRad(currentFov),o=2*Math.atan(Math.tan(n/2)*t);return THREE.MathUtils.radToDeg(o)}function updateViewCone(){if(!map||!map.getSource("view-cone"))return;const e=getCurrentTrack();if(!e||!selectedMarbleId)return;const t=e.marbles.find(e=>e.id===selectedMarbleId);if(!t)return;const n=e.marbles.findIndex(e=>e.id===selectedMarbleId);let o=e._lastPathBearing||0;if(n<e.marbles.length-1){const a=e.marbles[n+1],r=a.position[0]-t.position[0],i=a.position[1]-t.position[1];o=(180*Math.atan2(r,i)/Math.PI+360)%360}else if(n>0){const a=e.marbles[n-1],r=t.position[0]-a.position[0],i=t.position[1]-a.position[1];o=(180*Math.atan2(r,i)/Math.PI+360)%360}if(void 0!==e._lastPathBearing){const t=o-e._lastPathBearing;Math.abs(t)>180&&(o+=t>0?-360:360)}e._lastPathBearing=o;const a=(o+THREE.MathUtils.radToDeg(currentYaw)+360)%360,r=getHorizontalFovDeg(),i=makeViewConeRing(t.position[1],t.position[0],a,r,15,24);map.getSource("view-cone").setData({type:"Feature",geometry:{type:"Polygon",coordinates:[i]}})}function makeViewConeRing(e,t,n,o,a=7,r=24){const i=Math.max(0,Math.min(89,o/2)),s=n-i,l=n+i,c=[[t,e]];for(let n=0;n<=r;n++){const o=s+(l-s)*(n/r);c.push(destFromBearingDistance(e,t,o,a))}return c.push([t,e]),c}function showImageInViewer(e,t){if(console.log("üñºÔ∏è Loading image:",e),showViewerLoading("Loading 360¬∞ image..."),preloadedImages[e])return console.log("‚úÖ Using preloaded image"),hideViewerLoading(),applyImageToSphere(preloadedImages[e],t),void preloadAdjacentImages();const n=new Image;n.crossOrigin="Anonymous",n.onload=function(){console.log("‚úÖ Image loaded successfully:",e),preloadedImages[e]=n,hideViewerLoading(),applyImageToSphere(n,t),preloadAdjacentImages()},n.onerror=function(){console.error("‚ùå Failed to load image:",e),hideViewerLoading(),showToaster("Failed to load 360 image")},console.log("üì§ Setting image src:",e),n.src=e+(e.includes("?")?"&":"?")+"t="+Date.now()}function applyImageToSphere(e,t){sphere&&(panoGroup.remove(sphere),sphere.geometry?.dispose(),sphere.material&&(sphere.material.map?.dispose(),sphere.material.dispose()));const n=new THREE.SphereGeometry(500,60,40);n.scale(-1,1,1),n.rotateY(Math.PI);const o=getCurrentTrack();o&&o.yawFixDeg&&n.rotateY(THREE.MathUtils.degToRad(o.yawFixDeg));const a=new THREE.Texture(e);a.needsUpdate=!0;const r=new THREE.MeshBasicMaterial({map:a});sphere=new THREE.Mesh(n,r),sphere.rotation.y=currentYaw,sphere.rotation.x=currentPitch,panoGroup.add(sphere),updateNavigationRing(!0)}function preloadAdjacentImages(){const e=currentImageIndex-1,t=currentImageIndex+1;e>=0&&!preloadedImages[currentImages[e].url]&&preloadOne(e),t<currentImages.length&&!preloadedImages[currentImages[t].url]&&preloadOne(t)}function preloadOne(e){return new Promise(t=>{const n=currentImages[e];if(!n)return t();const o=n.url;if(preloadedImages[o])return t();const a=new Image;a.crossOrigin="Anonymous",a.onload=()=>{preloadedImages[o]=a,t()},a.onerror=()=>t(),a.src=o,a.decode&&a.decode().catch(()=>{})})}function nextImage(){currentImageIndex<currentImages.length-1&&(currentImageIndex++,showImageByIndex(currentImageIndex),updateNavigationRing(!0)),updateViewerUI(),refreshBranchButtons()}function previousImage(){currentImageIndex>0&&(currentImageIndex--,showImageByIndex(currentImageIndex),updateNavigationRing(!0)),updateViewerUI(),refreshBranchButtons()}function showImageByIndex(e){if(e<0||e>=currentImages.length)return;const t=currentImages[e];preloadedImages[t.url]?(applyImageToSphere(preloadedImages[t.url],t),currentImageIndex=e,updateViewerUI(),highlightMarbleWithImage(e)):(showImageInViewer(t.url,t),currentImageIndex=e,updateViewerUI(),highlightMarbleWithImage(e)),preloadAdjacentImages()}function updateViewerUI(){document.getElementById("time").textContent=`${currentImageIndex+1}/${currentImages.length}`,document.getElementById("viewer-info").textContent=`Image ${currentImageIndex+1}/${currentImages.length}`}function highlightMarbleWithImage(e){const t=getCurrentTrack();if(!t)return;const n=t.marbles.find(t=>t.assignedImage===e);n&&selectMarble(n.id)}function showMarbleImage(e){const t=getCurrentTrack();if(!t)return;const n=t.marbles.find(t=>t.id===e);if(n){if(null==n.assignedImage)return console.log("‚ùå Marble has no assigned image:",n),void showToaster(`Marble ${n.index+1} has no image`);console.log("üñºÔ∏è Showing image for marble:",n),console.log("üñºÔ∏è Assigned image index:",n.assignedImage),open360ViewerInModal(),setTimeout(()=>{showImageByIndex(n.assignedImage),refreshBranchButtons()},300)}}function showViewerLoading(e){const t=document.getElementById("viewer-loading"),n=document.getElementById("loading-text");t&&n&&(n.textContent=e,t.style.display="block")}function hideViewerLoading(){const e=document.getElementById("viewer-loading");e&&(e.style.display="none")}async function load360Images(){try{await createImagesFromFramesFolder(),currentImages.length>0&&startBackgroundPreload(3)}catch(e){console.error(e),showToaster("Error loading 360 images")}}async function createImagesFromFramesFolder(){currentImages=[],currentImageIndex=-1;const e=getCurrentTrack();if(!e)return void showToaster("No track selected");const t=(e.name||"").replace(/\.[^.]+$/,"");if(!t)return void showToaster("GPX name missing");const n=(t+"-").toLowerCase();let o;try{const e=await fetch(FRAMES_BASE+"index.json",{cache:"no-store"});if(!e.ok)return void showToaster("Could not fetch frames index");const t=await e.json();o=Array.isArray(t)?t:Array.isArray(t.files)?t.files:[]}catch(e){return void showToaster("Error reading frames manifest")}const a=o.map(e=>String(e).split("/").pop()).filter(Boolean).filter(e=>e.toLowerCase().startsWith(n)).filter(e=>/\.(?:jpe?g|png)$/i.test(e)).sort((e,t)=>e.localeCompare(t));a.length?currentImages=a.map((e,t)=>({url:FRAMES_BASE+e,index:t,filename:e,timestamp:e,sequence:t})):showToaster(`No frames for "${t}"`)}function startBackgroundPreload(e=3){if(currentImages.length<=1)return;runPreloadPool(buildPreloadOrder(currentImageIndex,currentImages.length),e)}function buildPreloadOrder(e,t){const n=[];for(let o=1;o<t;o++){const a=e+o,r=e-o;a<t&&n.push(a),r>=0&&n.push(r)}return n}function runPreloadPool(e,t){let n=0;const o=Array.from({length:Math.min(t,e.length)},async()=>{for(;n<e.length;){const t=e[n++];await preloadOne(t).catch(()=>{})}});Promise.all(o).then(()=>console.log("Background preload complete"))}function open360ViewerInModal(){const e=document.getElementById("lotModal"),t=document.getElementById("viewer-container"),n=(document.querySelector(".modal-content-wrapper"),document.getElementById("lotDetails")),o=document.getElementById("modalInfo"),a=document.getElementById("calendlyEmbed"),r=document.getElementById("backButton"),i=document.getElementById("headerFracc"),s=document.getElementById("headerLotNumber"),l=document.querySelector(".plus-button"),c=document.querySelector(".bottom-plus-button"),d=document.getElementById("customScrollbar"),u=document.getElementById("customScrollthumb");n&&(n.style.display="none"),o&&(o.style.display="none"),a&&(a.style.display="none"),d&&(d.style.display="none",d.style.visibility="hidden"),u&&(u.style.display="none",u.style.visibility="hidden"),t&&(t.style.display="block"),e.classList.add("viewer-mode"),e.classList.remove("pin-mode","info-mode","lot-mode"),i&&(i.textContent="STREET VIEW"),s&&(s.style.display="none"),r&&(r.style.display="none"),l&&(l.style.display="none"),c&&(c.style.display="none"),e.classList.contains("show")||(e.classList.add("show"),e.style.display="block",adjustMapForModal()),isDetailOpen=!0,document.getElementById("communitySearchBtn")?.classList.add("hide"),document.getElementById("lalalandInfoBtn")?.classList.add("hide"),console.log("360 Viewer opened in modal"),requestAnimationFrame(()=>{setTimeout(()=>{viewerInitialized&&renderer&&scene&&camera||(viewerInitialized=!1,initThreeJSViewer())},100)})}function close360ViewerInModal(e=null){const t=document.getElementById("lotModal"),n=document.getElementById("viewer-container"),o=document.querySelector(".modal-content-wrapper"),a=document.getElementById("lotDetails"),r=document.getElementById("modalInfo"),i=document.getElementById("customScrollbar"),s=document.getElementById("backButton"),l=document.getElementById("headerLotNumber"),c=document.getElementById("headerFracc"),d=document.querySelector(".plus-button"),u=document.querySelector(".bottom-plus-button");n&&(n.style.display="none"),t.classList.remove("info-mode","pin-mode","viewer-mode","expanded"),t.classList.add("lot-mode"),window.isDetailOpen=!1,o&&o.classList.remove("show-details"),a&&(a.classList.remove("active"),a.style.display="block",a.innerHTML=""),r&&(r.style.display="",r.style.opacity="1"),i&&(i.style.display="",i.style.visibility="");const m=document.getElementById("customScrollthumb");m&&(m.style.display="",m.style.visibility=""),s&&(s.style.display="none"),c&&(c.textContent="INVERTA"),l&&(l.style.display="none"),d&&(d.style.display="none"),u&&(u.style.display="none");const p=document.getElementById("pinLockButton");p&&(p.style.display="none");try{scrollHandlerAttached=!0}catch{}try{clampCooldown=!1}catch{}if(document.getElementById("communitySearchBtn")?.classList.remove("hide"),document.getElementById("lalalandInfoBtn")?.classList.remove("hide"),isDataLoaded){try{enableInfiniteScrollbar(),highlightCenter(),updateScrollbar()}catch{}const t=null!==e?e:lastOpenedBaseIndex;"number"==typeof t&&-1!==t&&requestAnimationFrame(()=>{scrollToBaseIndex(t,!1)}),console.log("360 Viewer closed in modal")}else{const t=document.getElementById("loadingSpinner");t&&(t.style.display="block"),fetchLots().then(()=>{render(),setupLotClickHandlers();try{enableInfiniteScrollbar(),highlightCenter(),updateScrollbar()}catch{}const n=null!==e&&"number"==typeof e?e:"string"==typeof e?baseLots.findIndex(t=>t.number===e):lastOpenedBaseIndex;"number"==typeof n&&-1!==n&&requestAnimationFrame(()=>{scrollToBaseIndex(n,!1)}),t&&(t.style.display="none"),console.log("List loaded and 360 Viewer closed")})}}document.getElementById("branchImageBtn").addEventListener("click",async()=>{if(!selectedMarbleId)return;const e=(navGraph.get(selectedMarbleId)||[]).filter(e=>e.distanceM<10);if(!e.length)return void console.log("No nearby marble (<10 m)");const t=e.sort((e,t)=>e.distanceM-t.distanceM)[0];let n=null,o=null;for(const[e,a]of allTracks){const e=a.marbles.find(e=>e.id===t.toMarbleId);if(e){n=a,o=e;break}}n&&o&&(n.id!==currentTrackId&&(selectTrackWithoutMapReset(n.id),await new Promise(e=>setTimeout(e,100))),selectMarble(o.id),null!=o.assignedImage?showMarbleImage(o.id):map.flyTo({center:o.position,zoom:map.getZoom(),duration:800}),console.log(`Jumped to ${n.name} (${Math.round(t.distanceM)} m)`))}),document.getElementById("nextImageBtn").addEventListener("click",nextImage),document.getElementById("prevImageBtn").addEventListener("click",previousImage),document.getElementById("nextImageBtnTop").addEventListener("click",nextImage),document.getElementById("prevImageBtnTop").addEventListener("click",previousImage);const originalCloseModal=window.closeModal;function calculateBounds(e){if(!e.length)return null;const t=new mapboxgl.LngLatBounds;return e.forEach(e=>t.extend(e)),t}function setStatus(e){console.log(e)}async function selectTrackAndThenMarble(e,t){if(isSwitchingTrack)return;isSwitchingTrack=!0;const n=currentTrackId;try{selectTrackWithoutMapReset(e),await new Promise(e=>setTimeout(e,100)),selectMarble(t),showMarbleImage(t),console.log(`Switched to ${allTracks.get(e).name} and selected marble`)}catch(e){console.error("Switch error",e),n&&selectTrackWithoutMapReset(n)}finally{isSwitchingTrack=!1}}function resetViewerState(){currentTrackId=null,selectedMarbleId=null,currentImages=[],currentImageIndex=-1,isSwitchingTrack=!1,renderer}let stripe,elements;console.log("üì¶ Saving originalCloseModal:",typeof originalCloseModal),window.closeModal=function(){console.log("üéØ Wrapper closeModal CALLED");if(document.getElementById("lotModal").classList.contains("viewer-mode"))return console.log("üìπ In viewer mode, closing viewer only"),void close360ViewerInModal();console.log("üîÑ Calling originalCloseModal, exists:",!!originalCloseModal),originalCloseModal?originalCloseModal():console.error("‚ùå originalCloseModal is not defined!")};let currentLotForPayment=null;const STRIPE_PUBLISHABLE_KEY="pk_test_51SUyrUAQALfcnICXujwh3b1nXGhHCoiAR5OfQPuhtAtbY4NIGCv3wF7sV7bVvNw7Y8AN1zPpdu0CnY6A4TOfTDlc00XQ7qFApi",RESERVATION_AMOUNT=5e3;async function showPaymentViewInModal(e){currentLotForPayment=e;const t=baseLots.findIndex(t=>t.number===e.number);-1!==t&&(lastOpenedBaseIndex=t);const n=document.getElementById("lotDetails");n.innerHTML="",n.classList.add("payment-mode"),n.innerHTML=`\n    <div class="payment-scroll-wrapper" style="height: 100%; overflow-y: auto; overflow-x: hidden; padding: 16px; padding-bottom: 80px;">\n      <div style="margin-bottom: 24px;">\n        <h2 style="font-size: 28px; font-weight: 700; color: #ff8400; text-align: center; margin-bottom: 8px;">APARTAR LOTE ${e.number}</h2>\n        <p style="font-size: 16px; color: #8a8880; text-align: center; margin-bottom: 24px;">Monto de separaci√≥n: <span style="color: #ff8400; font-weight: 700; font-size: 20px;">$${5e3.toLocaleString("en-US")} MXN</span></p>\n      </div>\n\n\x3c!-- Reservation Process Steps --\x3e\n<div style="background: rgba(255, 132, 0, 0.1); border-left: 4px solid #ff8400; padding: 16px; margin-bottom: 24px; border-radius: 4px;">\n  <h3 style="color: #ff8400; font-size: 18px; font-weight: 700; margin-bottom: 12px;">üìç Separa con $5,000 MXN:</h3>\n  <p style="color: #1a1a1a; font-size: 14px; line-height: 1.6; margin-bottom: 16px;">\n    Elige tu lote y realiza tu primera separaci√≥n de $5,000 MXN. \n    <strong>Recibir√°s $4,758.72 MXN de reembolso</strong> si cambias de opini√≥n \n    (equivalente al monto total menos cargos de procesamiento).\n    <br><span style="color: #ff8400; font-weight: 600;">¬°Aseguras el lote y tu inversi√≥n est√° protegida!</span>\n  </p>\n\n  <h3 style="color: #ff8400; font-size: 18px; font-weight: 700; margin-bottom: 12px;">‚úÖ Confirma en 24 Horas:</h3>\n  <p style="color: #1a1a1a; font-size: 14px; line-height: 1.6; margin-bottom: 16px;">\n    Tienes 24 horas para completar tu separaci√≥n con un segundo dep√≥sito de $5,000 MXN \n    (se te proporcionar√°n las cuentas bancarias oficiales de INVERTA a trav√©s de WhatsApp).\n    <br><span style="color: #ff8400; font-weight: 600;">¬°F√°cil, r√°pido y sin complicaciones!</span>\n  </p>\n\n  <h3 style="color: #ff8400; font-size: 18px; font-weight: 700; margin-bottom: 12px;">üìù Firma tu Contrato en 10 D√≠as:</h3>\n  <p style="color: #1a1a1a; font-size: 14px; line-height: 1.6;">\n    Durante la semana siguiente, nuestro equipo te ayudar√° con toda la papeler√≠a \n    y la firma formal de tu contrato de compraventa.\n    <br><span style="color: #ff8400; font-weight: 600;">Tiempo m√°s que suficiente para tomar la mejor decisi√≥n con tranquilidad.</span>\n  </p>\n</div>\n\n      \x3c!-- Contact Information --\x3e\n      <div style="background: white; padding: 12px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 12px;">\n        <h3 style="color: #ff8400; font-size: 14px; font-weight: 700; margin-bottom: 10px;">Informaci√≥n de Contacto</h3>\n\n        <div style="margin-bottom: 10px;">\n          <label style="display: block; color: #1a1a1a; font-size: 13px; font-weight: 600; margin-bottom: 4px;">Nombre Completo *</label>\n          <input type="text" id="customer-name" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px; font-size: 13px; font-family: 'Barlow Condensed', Arial, sans-serif; box-sizing: border-box;" placeholder="Juan P√©rez">\n        </div>\n\n        <div style="margin-bottom: 10px;">\n          <label style="display: block; color: #1a1a1a; font-size: 13px; font-weight: 600; margin-bottom: 4px;">Email *</label>\n          <input type="email" id="customer-email" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px; font-size: 13px; font-family: 'Barlow Condensed', Arial, sans-serif; box-sizing: border-box;" placeholder="tu@email.com">\n        </div>\n\n        <div style="margin-bottom: 0;">\n          <label style="display: block; color: #1a1a1a; font-size: 13px; font-weight: 600; margin-bottom: 4px;">Tel√©fono *</label>\n          <input type="tel" id="customer-phone" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px; font-size: 13px; font-family: 'Barlow Condensed', Arial, sans-serif; box-sizing: border-box;" placeholder="55 1234 5678">\n        </div>\n      </div>\n\n      \x3c!-- Stripe Payment Element --\x3e\n      <div id="stripe-payment-element" style="margin-bottom: 16px; width: 100%; padding: 0; background: white; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); box-sizing: border-box;">\n        <div style="text-align: center; color: #8a8880; padding: 20px 10px;">Cargando formulario de pago...</div>\n      </div>\n\n      \x3c!-- Error message --\x3e\n      <div id="payment-error" style="color: #f44336; margin-bottom: 16px; text-align: center; display: none; font-size: 14px;"></div>\n\n      \x3c!-- Payment Button (Single Step) --\x3e\n      <div id="payment-button-wrapper" style="text-align: center; margin-bottom: 60px;">\n        <button id="submit-payment" style="width: 100%; max-width: 400px; padding: 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 700; background: #ff8400; color: #fcfaf3; font-family: 'Barlow Condensed', Arial, sans-serif; font-size: 18px;">\n          PAGAR $${5e3.toLocaleString("en-US")} MXN\n        </button>\n      </div>\n    </div>\n  `,initializePayment()}async function initializePayment(){const e=document.getElementById("submit-payment");e&&(e.disabled=!0,e.textContent="CARGANDO...");try{0,stripe||(stripe=Stripe(STRIPE_PUBLISHABLE_KEY)),await window.supabaseReady;const e=window.supabaseClient?.supabaseUrl,t=window.supabaseClient?.supabaseKey;if(!e||!t)throw new Error("Supabase not initialized. Check Supabase configuration.");const n=currentLotForPayment;if(!n)throw new Error("No lot selected for payment");const o=lotData.find(e=>extractLotNumber(e.name)===n.number),a=o?.name||"",r=document.getElementById("customer-email"),i=document.getElementById("customer-phone"),s=`${e}/functions/v1/create-payment-intent`,l=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json",apikey:t},body:JSON.stringify({amount:5e5,lotNumber:n.number,lotName:a,lotId:n.id,client_id:CURRENT_CLIENT,customer_email:r?.value||"guest",customer_phone:i?.value||""})});if(!l.ok){const e=await l.text();throw new Error(`Edge function error: ${l.status} - ${e}`)}const{clientSecret:c}=await l.json();if(!c)throw new Error("No client secret returned from payment intent");elements=stripe.elements({clientSecret:c,appearance:{theme:"stripe"},loader:"auto",locale:"es"});elements.create("payment",{layout:{type:"tabs",defaultCollapsed:!1},terms:{card:"never"},wallets:{applePay:"never",googlePay:"never"}}).mount("#stripe-payment-element");const d=document.getElementById("submit-payment");d&&(d.disabled=!1,d.textContent=`PAGAR $${5e3.toLocaleString("en-US")} MXN`),document.getElementById("submit-payment")?.addEventListener("click",handlePaymentSubmit)}catch(e){console.error("Error initializing payment:",e),showPaymentError(e.message||"Error al inicializar el pago. Por favor intenta de nuevo.");const t=document.getElementById("submit-payment");t&&(t.disabled=!1,t.textContent=`PAGAR $${5e3.toLocaleString("en-US")} MXN`)}}function showPaymentError(e){const t=document.getElementById("payment-error");t&&(t.textContent=e,t.style.display="block")}async function handlePaymentSubmit(e){if(e?.preventDefault(),!stripe||!elements)return void showPaymentError("Error al procesar el pago");const t=document.getElementById("customer-name"),n=document.getElementById("customer-email"),o=document.getElementById("customer-phone");if(!t?.value||t.value.trim().length<3)return void showPaymentError("Por favor ingresa tu nombre completo");if(!n?.value||!n.value.includes("@"))return void showPaymentError("Por favor ingresa un email v√°lido");if(!o?.value||o.value.length<10)return void showPaymentError("Por favor ingresa un tel√©fono v√°lido");const a=document.getElementById("submit-payment");if(a){a.disabled=!0,a.textContent="PROCESANDO...";try{const{error:e}=await elements.submit();if(e)return showPaymentError(e.message),a.disabled=!1,void(a.textContent=`PAGAR $${5e3.toLocaleString("en-US")} MXN`);const{error:r}=await stripe.confirmPayment({elements:elements,confirmParams:{return_url:window.location.href,payment_method_data:{billing_details:{name:t.value,email:n.value,phone:o.value}}},redirect:"if_required"});if(r)showPaymentError(r.message),a.disabled=!1,a.textContent=`PAGAR $${5e3.toLocaleString("en-US")} MXN`;else{if(console.log("Payment succeeded - webhook will update lot status"),a.textContent="APARTADO",a.disabled=!0,a.style.opacity="0.5",a.style.cursor="not-allowed",a.style.background="#8a8880",window.showToaster?.("¬°Pago exitoso! El lote ha sido apartado."),"undefined"!=typeof confetti){const e=document.createElement("canvas");e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.pointerEvents="none",e.style.zIndex="999999",document.body.appendChild(e);const t=confetti.create(e,{resize:!0});t({particleCount:150,spread:90,origin:{x:.5,y:.75},colors:["#ff8400","#fcfaf3","#b18d69"],ticks:200}),setTimeout(()=>{t({particleCount:100,spread:70,origin:{x:.5,y:.75},colors:["#ff8400","#fcfaf3","#b18d69"],ticks:150})},250),setTimeout(()=>{document.body.removeChild(e)},5e3)}setTimeout(async()=>{"function"==typeof loadBaseLots&&await loadBaseLots()},3e3)}}catch(e){console.error("Payment error:",e),showPaymentError("Error al procesar el pago"),a.disabled=!1,a.textContent=`PAGAR $${5e3.toLocaleString("en-US")} MXN`}}}async function markLotAsSold(e){try{await window.supabaseReady;const t=lotData.find(t=>extractLotNumber(t.name)===e.number);if(!t)throw new Error(`Could not find lot_name for lot number ${e.number}`);const{error:n}=await window.supabaseClient.from("lots").update({availability:"Sold"}).eq("lot_name",t.name).eq("client_id",CURRENT_CLIENT);if(n)throw console.error("Error updating lot availability:",n),n;console.log(`Lot ${e.number} (${t.name}) marked as sold`)}catch(e){throw console.error("Error marking lot as sold:",e),e}}window.showPaymentViewInModal=showPaymentViewInModal</script></div></body></html>