<!DOCTYPE html>
<html>
<head>
  <title>Lots Map — Final</title>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <style>
    body { margin:0; padding:0; overflow-x:hidden; display:flex; }
    #map { position:absolute; top:0; bottom:0; left:0; right:0; overflow:hidden; }
    #menu { position:absolute; background:white; padding:10px; z-index:1; top:10px; left:10px; font-family:sans-serif; font-size:14px; }
    #overlay { position:absolute; top:50px; right:20px; width:300px; background:white; padding:20px; box-shadow:0px 0px 10px rgba(0,0,0,0.3); z-index:2; max-height:80%; overflow-y:auto; overflow-x:hidden; border-radius:8px; display:none; }
    .form-group { margin-bottom:15px; }
    .form-group input { width:100%; padding:10px; margin-top:5px; border:1px solid #ccc; border-radius:4px; box-sizing:border-box; }
    .form-group button { width:100%; padding:10px; margin-top:10px; border:none; background-color:#28a745; color:white; border-radius:4px; cursor:pointer; }
    .form-group button:hover { background-color:#218838; }
    .expandable-content { display:none; margin-top:10px; }
    .expandable-content.open { display:block; }
    .expand-btn { background-color:#007bff; color:white; padding:10px; text-align:center; border:none; cursor:pointer; width:100%; border-radius:4px; }
    .expand-btn:hover { background-color:#0056b3; }
    #toggleAdminPanelBtn { position:absolute; top:10px; right:10px; padding:10px; background-color:#007bff; color:white; border:none; border-radius:4px; cursor:pointer; z-index:3; }
    #toggleAdminPanelBtn:hover { background-color:#0056b3; }
  </style>
</head>
<body>

<div id="map"></div>

<div id="menu">
  <input id="blueprint" type="radio" name="style" value="blueprint" checked>
  <label for="blueprint">Blueprint</label>
  <input id="satellite" type="radio" name="style" value="satellite">
  <label for="satellite">Satellite</label>
</div>

<button id="toggleAdminPanelBtn">Toggle Admin Panel</button>

<div id="overlay">
  <h2>Manage Lots</h2>
  <div id="lotFormContainer">
    <div class="form-group">
      <label for="lotName">Lot Name</label>
      <input type="text" id="lotName" placeholder="Enter Lot Name">
    </div>
    <div class="form-group">
      <label for="availability">Availability</label>
      <input type="text" id="availability" placeholder="Enter Availability Status">
    </div>
    <button id="expandBtn" class="expand-btn">Show More</button>
    <div id="expandableContent" class="expandable-content">
      <div class="form-group">
        <label for="size">Size (m²)</label>
        <input type="number" id="size" placeholder="Enter Lot Size">
      </div>
      <div class="form-group">
        <label for="price">Price (MXN)</label>
        <input type="number" id="price" placeholder="Enter Lot Price">
      </div>
    </div>
    <div class="form-group">
      <button id="updateLotBtn">Update Lot</button>
    </div>
  </div>
</div>

<script>
let lotData = [];
let animationPlayed = false;
let mapReady = false;
let currentStyle = 'blueprint';

const supabase = window.supabase.createClient(
  'https://jmoxbhodpvnlmtihcwvt.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imptb3hiaG9kcHZubG10aWhjd3Z0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIxODM1MDgsImV4cCI6MjA2Nzc1OTUwOH0.-jP1akHIo9R4a2lD15byC5dESSGfeFHu8qlbmHteeJo'
);

fetch('https://lalaland.mx/mapbox.txt')
  .then(res => res.text())
  .then(token => {
    mapboxgl.accessToken = token.trim();
    initMap();
  });

function initMap() {
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/andresmtzc/cmcxf2vmh015o01s097ao7n6k',
    center: [-100.15994, 25.461823],
    zoom: 16
  });

  fetch('https://lalaland.mx/lots.txt')
    .then(res => res.text())
    .then(text => {
      lotData = parseLotData(text);
      if (mapReady && !animationPlayed) {
        animateGroups(map);
        animationPlayed = true;
      }
      enrichLotsWithAvailability(map);
    });

  map.on('style.load', () => {
    mapReady = true;
    if (lotData.length && !animationPlayed) {
      animateGroups(map);
      animationPlayed = true;
    } else if (animationPlayed) {
      addOptimizedLayers(map);
      fadeInOptimizedLayers(map);
      addSoldXs(map);
    }
  });

  document.getElementById('blueprint').onclick = () => {
    if (currentStyle === 'blueprint') return;
    currentStyle = 'blueprint';
    map.setStyle('mapbox://styles/andresmtzc/cmcxf2vmh015o01s097ao7n6k');
  };

  document.getElementById('satellite').onclick = () => {
    if (currentStyle === 'satellite') return;
    currentStyle = 'satellite';
    map.setStyle('mapbox://styles/mapbox/satellite-streets-v12');
  };

  document.getElementById('expandBtn').onclick = function() {
    const expandableContent = document.getElementById('expandableContent');
    expandableContent.classList.toggle('open');
    this.textContent = expandableContent.classList.contains('open') ? "Show Less" : "Show More";
  };

  document.getElementById('toggleAdminPanelBtn').onclick = function() {
    const overlay = document.getElementById('overlay');
    overlay.style.display = (overlay.style.display === "none" || overlay.style.display === "") ? "block" : "none";
  };
}

async function enrichLotsWithAvailability(map) {
  const names = lotData.map(l => l.name);
  const { data } = await supabase
    .from('lots')
    .select('lot_name, availability')
    .in('lot_name', names);

  data.forEach(row => {
    const lot = lotData.find(l => l.name === row.lot_name);
    if (lot) lot.availability = row.availability || 'Unknown';
  });

  addSoldXs(map);
}

function animateGroups(map) {
  const groupCount = 20, groupDelay = 70, animationDuration = 300, buffer = 50;
  const indices = Array.from({length: lotData.length}, (_, i) => i);
  shuffle(indices);
  const groups = Array.from({length: groupCount}, () => []);
  indices.forEach((idx, i) => groups[i % groupCount].push(idx));
  groups.forEach((group, g) => {
    const geojson = { type: "FeatureCollection", features: group.map(i => makeFeature(i, true)) };
    map.addSource(`group-${g}`, { type: "geojson", data: geojson });
    map.addLayer({ id: `group-border-${g}`, type: "line", source: `group-${g}`, paint: { "line-color": "#fff", "line-width": 1, "line-opacity": 0 } });
    setTimeout(() => animateGroup(map, g, group, animationDuration), g * groupDelay);
  });
  const totalTime = ((groupCount - 1) * groupDelay) + animationDuration + buffer;
  setTimeout(() => { addOptimizedLayers(map); }, totalTime);
}

function animateGroup(map, g, group, duration) {
  let progress = 0, start = performance.now();
  const originals = group.map(i => ({ i, coords: lotData[i].coords.map(c => [c.lng, c.lat]), center: getCenter(lotData[i].coords) }));
  function frame(time) {
    progress = (time - start) / duration;
    if (progress > 1) progress = 1;
    const eased = 1 - Math.pow(1 - progress, 3), scale = 1 + (1 - eased) * 0.3, opacity = eased;
    const geojson = {
      type: "FeatureCollection",
      features: originals.map(o => ({ type: "Feature", properties: { name: lotData[o.i].name }, geometry: { type: "Polygon", coordinates: [scaleCoords(o.coords, o.center, scale)] } }))
    };
    map.getSource(`group-${g}`).setData(geojson);
    map.setPaintProperty(`group-border-${g}`, 'line-opacity', opacity);
    if (progress < 1) requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
}

function addOptimizedLayers(map) {
  const features = lotData.map((lot, i) => ({
    type: "Feature",
    properties: { name: lot.name },
    geometry: { type: "Polygon", coordinates: [lot.coords.map(c => [c.lng, c.lat])] },
    id: i
  }));
  const geojson = { type: "FeatureCollection", features };
  if (!map.getSource('lots')) {
    map.addSource('lots', { type: 'geojson', data: geojson });
  } else {
    map.getSource('lots').setData(geojson);
  }
  if (!map.getLayer('lots-fill')) {
    map.addLayer({ id: 'lots-fill', type: 'fill', source: 'lots', paint: { 'fill-color': '#000', 'fill-opacity': ['case', ['boolean', ['feature-state', 'hover'], false], 0.2, 0] } });
  }
  if (!map.getLayer('lots-border')) {
    map.addLayer({ id: 'lots-border', type: 'line', source: 'lots', paint: { 'line-color': '#fff', 'line-width': ['case', ['boolean', ['feature-state', 'hover'], false], 4, 1], 'line-opacity': 1 } });
  }
  setupHover(map);
  map.on('click', 'lots-fill', (e) => {
    const name = e.features[0].properties.name;
    const lot = lotData.find(l => l.name === name);
    const status = lot && lot.availability ? lot.availability : 'Unknown';
    new mapboxgl.Popup()
      .setLngLat(e.lngLat)
      .setHTML(`<strong>${name}</strong><br>Availability: ${status}`)
      .addTo(map);
  });
}

function addSoldXs(map) {
  const soldFeatures = [];
  lotData.forEach(lot => {
    if (!lot.availability || lot.availability.toLowerCase() !== 'sold') return;
    const coords = lot.coords.map(c => [c.lng, c.lat]);
    if (coords[0][0] === coords[coords.length - 1][0] && coords[0][1] === coords[coords.length - 1][1]) coords.pop();
    const n = coords.length;
    if (n < 3) return;
    soldFeatures.push({ type: 'Feature', geometry: { type: 'LineString', coordinates: [coords[0], coords[Math.floor(n/2)]] } });
    soldFeatures.push({ type: 'Feature', geometry: { type: 'LineString', coordinates: [coords[Math.floor(n/4)], coords[Math.floor(3*n/4)]] } });
  });
  if (!soldFeatures.length) return;
  const xGeojson = { type: 'FeatureCollection', features: soldFeatures };
  if (!map.getSource('sold-x')) {
    map.addSource('sold-x', { type: 'geojson', data: xGeojson });
    map.addLayer({ id: 'sold-x-layer', type: 'line', source: 'sold-x', paint: { 'line-color': 'white', 'line-width': 1 } });
  } else {
    map.getSource('sold-x').setData(xGeojson);
  }
}

function fadeInOptimizedLayers(map) {
  map.setPaintProperty('lots-border', 'line-opacity', 1);
  map.setPaintProperty('lots-fill', 'fill-opacity', ['case', ['boolean', ['feature-state', 'hover'], false], 0.2, 0]);
}

function setupHover(map) {
  let hoveredId = null;
  map.on('mousemove', 'lots-fill', (e) => {
    map.getCanvas().style.cursor = 'crosshair';
    if (e.features.length > 0) {
      if (hoveredId !== null) map.setFeatureState({ source: 'lots', id: hoveredId }, { hover: false });
      hoveredId = e.features[0].id;
      map.setFeatureState({ source: 'lots', id: hoveredId }, { hover: true });
    }
  });
  map.on('mouseleave', 'lots-fill', () => {
    if (hoveredId !== null) map.setFeatureState({ source: 'lots', id: hoveredId }, { hover: false });
    hoveredId = null;
    map.getCanvas().style.cursor = '';
  });
}

function makeFeature(i, startBig = false) {
  const coords = lotData[i].coords.map(c => [c.lng, c.lat]), center = getCenter(lotData[i].coords), scale = startBig ? 1.3 : 1;
  return { type: "Feature", properties: { name: lotData[i].name }, geometry: { type: "Polygon", coordinates: [scaleCoords(coords, center, scale)] } };
}

function scaleCoords(coords, center, scale) {
  return coords.map(([lng, lat]) => [center[0] + (lng - center[0]) * scale, center[1] + (lat - center[1]) * scale]);
}

function getCenter(coords) {
  const sum = coords.reduce((acc, c) => [acc[0]+c.lng, acc[1]+c.lat], [0,0]);
  return [sum[0]/coords.length, sum[1]/coords.length];
}

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

function parseLotData(text) {
  const lotData = [], lines = text.split("\n");
  let lotCoords = [], lotName = "";
  lines.forEach(line => {
    const matchLotName = line.match(/^lot\d+/);
    if (matchLotName) {
      if (lotCoords.length) close(lotCoords), lotData.push({ name: lotName, coords: lotCoords });
      lotName = matchLotName[0];
      lotCoords = [];
    }
    const matchCoord = line.match(/lat: ([-\d.]+), lng: ([-\d.]+)/);
    if (matchCoord) lotCoords.push({ lat: +matchCoord[1], lng: +matchCoord[2] });
  });
  if (lotCoords.length) close(lotCoords), lotData.push({ name: lotName, coords: lotCoords });
  return lotData;
}

function close(coords) {
  if (coords[0].lat !== coords[coords.length-1].lat || coords[0].lng !== coords[coords.length-1].lng) coords.push({ ...coords[0] });
}
</script>
</body>
</html>
