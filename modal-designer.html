<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Modal Designer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .designer-container {
            display: flex;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
            height: calc(100vh - 40px);
        }

        /* Control Panel */
        .control-panel {
            background: white;
            border-radius: 12px;
            padding: 24px;
            width: 600px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow-y: auto;
        }

        .control-panel h2 {
            margin-bottom: 24px;
            color: #333;
            font-size: 24px;
        }

        .control-section {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e0e0e0;
        }

        .control-section:last-child {
            border-bottom: none;
        }

        .control-section h3 {
            margin-bottom: 16px;
            color: #555;
            font-size: 16px;
            font-weight: 600;
        }

        .section-controls {
            max-height: 250px;
            overflow-y: auto;
        }

        .section-control {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .section-control.selected {
            border-color: #667eea;
            background: #f0f3ff;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .section-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .btn-remove {
            background: #ff4757;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .height-control {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .height-control label {
            font-size: 12px;
            color: #666;
            min-width: 50px;
        }

        .height-control input[type="range"] {
            flex: 1;
            height: 6px;
        }

        .height-control input[type="number"] {
            width: 60px;
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }

        .btn-add-section {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .btn-add-box {
            width: 100%;
            padding: 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .size-display {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            font-family: monospace;
            font-size: 14px;
            color: #333;
        }

        .margin-controls {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 12px;
        }

        .margin-control {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .margin-control label {
            font-size: 11px;
            color: #666;
            text-align: center;
        }

        .margin-control input {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            text-align: center;
        }

        /* Preview Area */
        .preview-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .modal-preview {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 400px;
            height: 600px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-sections {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .modal-section {
            border-bottom: 1px dashed #e0e0e0;
            position: relative;
            flex-shrink: 0;
            min-height: 1px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-section:hover {
            background: #f8f9fa;
        }

        .modal-section.selected {
            background: #f0f3ff;
            border-left: 4px solid #667eea;
        }

        .modal-section:last-child {
            border-bottom: none;
        }

        .section-label {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            pointer-events: none;
        }

        .section-name-editable {
            position: absolute;
            top: 4px;
            left: 4px;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            border: 1px dashed #667eea;
            cursor: text;
            min-width: 60px;
            outline: none;
        }

        /* Content Boxes */
        .content-box {
            background: #667eea;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            border: 2px solid transparent;
            position: relative;
            min-height: 1px;
            cursor: move;
        }

        .content-box.selected {
            border-color: #ff4757;
            background: rgba(102, 126, 234, 0.8);
        }

        .content-box:hover {
            background: #5568d3;
        }

        .content-box.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .content-box.drag-over {
            border-color: #28a745;
            border-style: dashed;
        }

        .box-label {
            position: absolute;
            top: 4px;
            left: 4px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            pointer-events: none;
        }

        /* Resize Handle */
        .resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 20px;
            height: 20px;
            cursor: nwse-resize;
            background: linear-gradient(135deg, transparent 50%, #667eea 50%);
            border-bottom-right-radius: 12px;
        }

        .resize-handle:hover {
            background: linear-gradient(135deg, transparent 50%, #764ba2 50%);
        }

        /* Export Modal */
        .export-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .export-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .export-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .close-export {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .export-content h3 {
            margin-bottom: 16px;
            color: #333;
        }

        .export-content textarea {
            width: 100%;
            height: 400px;
            padding: 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
            margin-bottom: 16px;
        }

        .export-content button {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .drag-hint {
            font-size: 11px;
            color: #888;
            text-align: center;
            margin-top: 4px;
            font-style: italic;
        }

        .btn-lock {
            background: #ffc107;
            color: #333;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 8px;
            font-weight: 600;
        }

        .btn-lock.locked {
            background: #28a745;
            color: white;
        }

        .section-control.locked {
            background: #e8f5e9;
            border-color: #28a745;
        }

        .section-name.locked::after {
            content: ' ðŸ”’';
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="designer-container">
        <!-- Control Panel -->
        <div class="control-panel">
            <h2>Modal Designer</h2>

            <div class="control-section">
                <h3>Sections <span id="totalHeight" style="float: right; font-size: 14px; color: #667eea;">(100%)</span></h3>
                <div class="section-controls" id="sectionControls"></div>
                <button class="btn-add-section" onclick="addSection()">+ Add Section</button>
                <button class="btn-add-section" onclick="equalizeAllSections()" style="background: #28a745;">âš– Equalize All</button>
            </div>

            <div class="control-section">
                <h3>Add Box</h3>
                <button class="btn-add-box" onclick="addBox()">+ Add Box to Selected Section</button>
                <div style="font-size: 12px; color: #666; margin-top: 8px; text-align: center;">
                    Select a section first
                </div>
                <div class="drag-hint">
                    ðŸ’¡ Drag boxes to reorder them
                </div>
            </div>

            <div class="control-section">
                <h3>Box Margins</h3>
                <div class="margin-controls">
                    <div class="margin-control">
                        <label>Top</label>
                        <input type="number" id="marginTop" value="0" onchange="updateSelectedBoxMargin('top', this.value)">
                    </div>
                    <div class="margin-control">
                        <label>Right</label>
                        <input type="number" id="marginRight" value="0" onchange="updateSelectedBoxMargin('right', this.value)">
                    </div>
                    <div class="margin-control">
                        <label>Bottom</label>
                        <input type="number" id="marginBottom" value="0" onchange="updateSelectedBoxMargin('bottom', this.value)">
                    </div>
                    <div class="margin-control">
                        <label>Left</label>
                        <input type="number" id="marginLeft" value="0" onchange="updateSelectedBoxMargin('left', this.value)">
                    </div>
                </div>
                <div style="font-size: 12px; color: #666; margin-top: 8px; text-align: center;">
                    Select a box to adjust margins
                </div>
            </div>

            <div class="control-section">
                <h3>Modal Size</h3>
                <div class="size-display">
                    <span id="modalWidth">400</span>px Ã— <span id="modalHeight">600</span>px
                </div>
            </div>

            <div class="control-section">
                <h3>Actions</h3>
                <button class="btn-add-section" onclick="exportHTML()" style="background: #17a2b8;">ðŸ“„ Export HTML</button>
                <button class="btn-add-section" onclick="exportJSON()" style="background: #6c757d;">ðŸ’¾ Save JSON</button>
                <button class="btn-add-section" onclick="showImportModal()" style="background: #28a745;">ðŸ“¥ Load JSON</button>
                <button class="btn-add-section" onclick="resetModal()" style="background: #ff4757;">ðŸ—‘ Reset</button>
            </div>
        </div>

        <!-- Preview Area -->
        <div class="preview-area">
            <div class="modal-preview" id="modalPreview">
                <div class="modal-sections" id="modalSections"></div>
                <div class="resize-handle" title="Drag to resize"></div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="export-modal">
        <div class="export-content">
            <span class="close-export" onclick="closeExportModal()">&times;</span>
            <h3 id="exportTitle">Export HTML</h3>
            <textarea id="exportCode" readonly></textarea>
            <button onclick="copyExportCode()">Copy to Clipboard</button>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="export-modal">
        <div class="export-content">
            <span class="close-export" onclick="closeImportModal()">&times;</span>
            <h3>Import Design (JSON)</h3>
            <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
                Paste your saved JSON below to restore your design:
            </p>
            <textarea id="importCode" placeholder='Paste JSON here...&#10;Example: {"modalDimensions":{"width":400,"height":600},...}'></textarea>
            <button onclick="importJSON()">Load Design</button>
        </div>
    </div>

    <script>
        // Modal Designer State
        let sections = [];
        let selectedSectionId = null;
        let selectedBoxId = null;
        let modalWidth = 400;
        let modalHeight = 600;

        // Drag and drop state
        let draggedBox = null;
        let draggedFromSection = null;

        // Initialize with default sections
        function init() {
            // Add default sections
            const defaultSections = ['Header', 'Content', 'Footer'];

            defaultSections.forEach((name, index) => {
                sections.push({
                    id: Date.now() + index,
                    name: name,
                    height: 33.33,
                    boxes: [],
                    locked: false
                });
            });

            renderSections();
            renderControls();
            setupDragAndResize();
        }

        // Add new section
        function addSection() {
            const sectionNumber = sections.length + 1;

            // Calculate space to take from existing unlocked sections
            const targetHeight = 10;
            const unlockedSections = sections.filter(s => !s.locked);
            const lockedTotal = sections.filter(s => s.locked).reduce((sum, s) => sum + s.height, 0);

            if (unlockedSections.length > 0) {
                const availableSpace = 100 - lockedTotal;
                const remainingSpace = availableSpace - targetHeight;

                const totalUnlockedHeight = unlockedSections.reduce((sum, s) => sum + s.height, 0);

                // Shrink existing unlocked sections proportionally
                if (totalUnlockedHeight > 0) {
                    unlockedSections.forEach(s => {
                        const proportion = s.height / totalUnlockedHeight;
                        s.height = remainingSpace * proportion;
                    });
                }
            }

            const newSection = {
                id: Date.now(),
                name: `Section ${sectionNumber}`,
                height: targetHeight,
                boxes: [],
                locked: false
            };

            sections.push(newSection);
            normalizeHeights();
            renderSections();
            renderControls();
        }

        // Remove section
        function removeSection(id) {
            sections = sections.filter(s => s.id !== id);

            if (selectedSectionId === id) {
                selectedSectionId = null;
                selectedBoxId = null;
            }

            normalizeHeights();
            renderSections();
            renderControls();
        }

        // Update section height and redistribute others
        function updateSectionHeight(id, height) {
            const newHeight = parseFloat(height);
            const section = sections.find(s => s.id === id);
            if (!section) return;

            const oldHeight = section.height;
            const difference = newHeight - oldHeight;

            // Get other unlocked sections (excluding the one being changed)
            const unlockedOtherSections = sections.filter(s => s.id !== id && !s.locked);

            if (unlockedOtherSections.length === 0) {
                // No other unlocked sections to adjust
                // Check if we can make the change
                const lockedTotal = sections.filter(s => s.id !== id && s.locked).reduce((sum, s) => sum + s.height, 0);
                const maxAllowed = 100 - lockedTotal;
                section.height = Math.min(newHeight, maxAllowed);
                renderSections();
                renderControls();
                return;
            }

            // Calculate total locked height
            const lockedTotal = sections.filter(s => s.locked && s.id !== id).reduce((sum, s) => sum + s.height, 0);
            const availableSpace = 100 - lockedTotal;

            // Calculate total height of unlocked other sections
            const unlockedOthersTotalHeight = unlockedOtherSections.reduce((sum, s) => sum + s.height, 0);

            // Cap new height to available space
            const cappedNewHeight = Math.min(newHeight, availableSpace);
            section.height = cappedNewHeight;

            // Distribute the remaining space among other unlocked sections proportionally
            const remainingSpace = availableSpace - cappedNewHeight;

            if (unlockedOthersTotalHeight > 0) {
                unlockedOtherSections.forEach(s => {
                    const proportion = s.height / unlockedOthersTotalHeight;
                    s.height = remainingSpace * proportion;
                });
            } else {
                // If others were 0, distribute equally
                const equalHeight = remainingSpace / unlockedOtherSections.length;
                unlockedOtherSections.forEach(s => s.height = equalHeight);
            }

            // Ensure minimum heights and normalize to 100%
            normalizeHeights();
            renderSections();
            renderControls();
        }

        // Normalize all section heights to sum to 100%
        function normalizeHeights() {
            const total = sections.reduce((sum, s) => sum + s.height, 0);
            if (total > 0 && Math.abs(total - 100) > 0.01) {
                sections.forEach(s => {
                    s.height = (s.height / total) * 100;
                });
            }
        }

        // Equalize all sections to same height
        function equalizeAllSections() {
            if (sections.length === 0) return;

            const equalHeight = 100 / sections.length;
            sections.forEach(s => {
                s.height = equalHeight;
            });

            renderSections();
            renderControls();
        }

        // Rename section
        function renameSection(id, newName) {
            const section = sections.find(s => s.id === id);
            if (section) {
                section.name = newName || section.name;
                renderSections();
                renderControls();
            }
        }

        // Select section
        function selectSection(id) {
            selectedSectionId = id;
            selectedBoxId = null;
            renderSections();
            renderControls();
        }

        // Toggle section lock
        function toggleSectionLock(id) {
            const section = sections.find(s => s.id === id);
            if (section) {
                section.locked = !section.locked;
                renderSections();
                renderControls();
            }
        }

        // Add box to selected section
        function addBox() {
            if (!selectedSectionId) {
                alert('Please select a section first!');
                return;
            }

            const section = sections.find(s => s.id === selectedSectionId);
            if (!section) return;

            const boxNumber = section.boxes.length + 1;

            const newBox = {
                id: Date.now(),
                name: `Box ${boxNumber}`,
                margin: { top: 0, right: 0, bottom: 0, left: 0 }
            };

            section.boxes.push(newBox);
            renderSections();
        }

        // Select box
        function selectBox(sectionId, boxId) {
            selectedSectionId = sectionId;
            selectedBoxId = boxId;
            renderSections();
            renderControls();
        }

        // Update box margin
        function updateSelectedBoxMargin(side, value) {
            if (!selectedSectionId || !selectedBoxId) return;

            const section = sections.find(s => s.id === selectedSectionId);
            if (!section) return;

            const box = section.boxes.find(b => b.id === selectedBoxId);
            if (!box) return;

            if (!box.margin) box.margin = { top: 0, right: 0, bottom: 0, left: 0 };
            box.margin[side] = parseInt(value) || 0;

            // Update input values
            document.getElementById('marginTop').value = box.margin.top;
            document.getElementById('marginRight').value = box.margin.right;
            document.getElementById('marginBottom').value = box.margin.bottom;
            document.getElementById('marginLeft').value = box.margin.left;

            renderSections();
        }

        // Remove box
        function removeBox(sectionId, boxId) {
            const section = sections.find(s => s.id === sectionId);
            if (section) {
                section.boxes = section.boxes.filter(b => b.id !== boxId);
                if (selectedBoxId === boxId) {
                    selectedBoxId = null;
                }
                renderSections();
                renderControls();
            }
        }

        // Drag and Drop Functions
        function handleDragStart(e, sectionId, boxId) {
            const section = sections.find(s => s.id === sectionId);
            const box = section?.boxes.find(b => b.id === boxId);

            if (!box) return;

            draggedBox = box;
            draggedFromSection = sectionId;

            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.innerHTML);
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');

            // Remove all drag-over classes
            document.querySelectorAll('.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });

            draggedBox = null;
            draggedFromSection = null;
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            if (e.target.classList.contains('content-box') && !e.target.classList.contains('dragging')) {
                e.target.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            if (e.target.classList.contains('content-box')) {
                e.target.classList.remove('drag-over');
            }
        }

        function handleDrop(e, targetSectionId, targetBoxId) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            e.target.classList.remove('drag-over');

            if (!draggedBox || !draggedFromSection) return false;

            const sourceSection = sections.find(s => s.id === draggedFromSection);
            const targetSection = sections.find(s => s.id === targetSectionId);

            if (!sourceSection || !targetSection) return false;

            // Only allow reordering within the same section
            if (draggedFromSection !== targetSectionId) {
                return false;
            }

            // Get indices
            const draggedIndex = sourceSection.boxes.findIndex(b => b.id === draggedBox.id);
            const targetIndex = targetSection.boxes.findIndex(b => b.id === targetBoxId);

            if (draggedIndex === -1 || targetIndex === -1 || draggedIndex === targetIndex) {
                return false;
            }

            // Remove dragged box from source
            sourceSection.boxes.splice(draggedIndex, 1);

            // Insert at new position
            const newTargetIndex = draggedIndex < targetIndex ? targetIndex : targetIndex;
            targetSection.boxes.splice(newTargetIndex, 0, draggedBox);

            renderSections();
            return false;
        }

        // Render sections in modal
        function renderSections() {
            const container = document.getElementById('modalSections');
            container.innerHTML = '';

            sections.forEach((section, index) => {
                const sectionEl = document.createElement('div');
                sectionEl.className = 'modal-section';
                sectionEl.style.height = `${section.height}%`;

                if (section.id === selectedSectionId) {
                    sectionEl.classList.add('selected');
                }

                sectionEl.onclick = (e) => {
                    if (!e.target.closest('.content-box') && !e.target.closest('.box-name-editable')) {
                        selectSection(section.id);
                    }
                };

                // Add editable section name
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.className = 'section-name-editable';
                nameInput.value = section.name;
                nameInput.onclick = (e) => e.stopPropagation();
                nameInput.onchange = (e) => renameSection(section.id, e.target.value);
                nameInput.onblur = (e) => renameSection(section.id, e.target.value);
                sectionEl.appendChild(nameInput);

                // Add label
                const label = document.createElement('div');
                label.className = 'section-label';
                label.textContent = `${section.height.toFixed(1)}% - ${section.boxes.length} boxes`;
                sectionEl.appendChild(label);

                // Create container for boxes with flex layout
                const boxesContainer = document.createElement('div');
                boxesContainer.style.cssText = `
                    display: flex;
                    width: 100%;
                    height: 100%;
                    gap: 0;
                `;

                // Render boxes
                section.boxes.forEach(box => {
                    const boxEl = document.createElement('div');
                    boxEl.className = 'content-box';
                    boxEl.draggable = true;

                    if (selectedBoxId === box.id) {
                        boxEl.classList.add('selected');
                    }

                    // Make each box take equal width
                    boxEl.style.flex = '1';
                    boxEl.style.height = '100%';

                    // Apply margins
                    boxEl.style.marginTop = `${box.margin?.top || 0}px`;
                    boxEl.style.marginRight = `${box.margin?.right || 0}px`;
                    boxEl.style.marginBottom = `${box.margin?.bottom || 0}px`;
                    boxEl.style.marginLeft = `${box.margin?.left || 0}px`;

                    // Drag and drop event listeners
                    boxEl.addEventListener('dragstart', (e) => handleDragStart(e, section.id, box.id));
                    boxEl.addEventListener('dragend', handleDragEnd);
                    boxEl.addEventListener('dragover', handleDragOver);
                    boxEl.addEventListener('dragenter', handleDragEnter);
                    boxEl.addEventListener('dragleave', handleDragLeave);
                    boxEl.addEventListener('drop', (e) => handleDrop(e, section.id, box.id));

                    boxEl.onclick = (e) => {
                        e.stopPropagation();
                        selectBox(section.id, box.id);
                    };

                    // Add editable box name
                    const boxNameInput = document.createElement('input');
                    boxNameInput.type = 'text';
                    boxNameInput.className = 'box-name-editable';
                    boxNameInput.value = box.name;
                    boxNameInput.style.cssText = `
                        background: transparent;
                        border: 1px dashed rgba(255,255,255,0.5);
                        color: white;
                        font-size: 14px;
                        font-weight: 600;
                        text-align: center;
                        padding: 4px 8px;
                        border-radius: 4px;
                        width: 80%;
                        outline: none;
                    `;
                    boxNameInput.onclick = (e) => e.stopPropagation();
                    boxNameInput.onchange = (e) => renameBox(section.id, box.id, e.target.value);
                    boxNameInput.onblur = (e) => renameBox(section.id, box.id, e.target.value);
                    boxNameInput.placeholder = 'Box name...';

                    // Center the name input
                    const centerContainer = document.createElement('div');
                    centerContainer.style.cssText = `
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        width: 100%;
                        height: 100%;
                        pointer-events: none;
                    `;
                    boxNameInput.style.pointerEvents = 'auto';
                    centerContainer.appendChild(boxNameInput);
                    boxEl.appendChild(centerContainer);

                    // Add box label (margins)
                    const boxLabel = document.createElement('div');
                    boxLabel.className = 'box-label';
                    boxLabel.textContent = `M: ${box.margin?.top || 0},${box.margin?.right || 0},${box.margin?.bottom || 0},${box.margin?.left || 0}`;
                    boxEl.appendChild(boxLabel);

                    // Add remove button
                    const removeBtn = document.createElement('button');
                    removeBtn.textContent = 'Ã—';
                    removeBtn.onclick = (e) => {
                        e.stopPropagation();
                        removeBox(section.id, box.id);
                    };
                    removeBtn.style.cssText = 'position: absolute; top: 4px; right: 4px; background: #ff4757; color: white; border: none; width: 16px; height: 16px; border-radius: 3px; cursor: pointer; font-size: 12px; line-height: 1; padding: 0;';
                    boxEl.appendChild(removeBtn);

                    boxesContainer.appendChild(boxEl);
                });

                sectionEl.appendChild(boxesContainer);
                container.appendChild(sectionEl);
            });
        }

        // Rename box
        function renameBox(sectionId, boxId, newName) {
            const section = sections.find(s => s.id === sectionId);
            if (section) {
                const box = section.boxes.find(b => b.id === boxId);
                if (box) {
                    box.name = newName || box.name;
                    renderSections();
                }
            }
        }

        // Render controls panel
        function renderControls() {
            const container = document.getElementById('sectionControls');
            container.innerHTML = '';

            sections.forEach(section => {
                const controlEl = document.createElement('div');
                controlEl.className = 'section-control';

                if (section.id === selectedSectionId) {
                    controlEl.classList.add('selected');
                }

                if (section.locked) {
                    controlEl.classList.add('locked');
                }

                controlEl.innerHTML = `
                    <div class="section-header">
                        <span class="section-name ${section.locked ? 'locked' : ''}">${section.name}</span>
                        <div>
                            <button class="btn-lock ${section.locked ? 'locked' : ''}" onclick="event.stopPropagation(); toggleSectionLock(${section.id})">
                                ${section.locked ? 'ðŸ”’ Locked' : 'ðŸ”“ Lock'}
                            </button>
                            <button class="btn-remove" onclick="removeSection(${section.id})">Remove</button>
                        </div>
                    </div>
                    <div class="height-control">
                        <label>Height:</label>
                        <input type="range"
                               min="1"
                               max="80"
                               step="0.5"
                               value="${section.height.toFixed(1)}"
                               ${section.locked ? 'disabled' : ''}
                               oninput="updateSectionHeight(${section.id}, this.value); this.nextElementSibling.value = this.value">
                        <input type="number"
                               min="1"
                               max="80"
                               step="0.5"
                               value="${section.height.toFixed(1)}"
                               ${section.locked ? 'disabled' : ''}
                               oninput="updateSectionHeight(${section.id}, this.value); this.previousElementSibling.value = this.value">
                    </div>
                `;

                controlEl.onclick = () => selectSection(section.id);

                container.appendChild(controlEl);
            });

            // Update total height display
            const total = sections.reduce((sum, s) => sum + s.height, 0);
            const totalEl = document.getElementById('totalHeight');
            if (totalEl) {
                totalEl.textContent = `(${total.toFixed(1)}%)`;
                totalEl.style.color = Math.abs(total - 100) < 0.1 ? '#667eea' : '#ff4757';
            }

            // Update margin controls if a box is selected
            if (selectedSectionId && selectedBoxId) {
                const section = sections.find(s => s.id === selectedSectionId);
                const box = section?.boxes.find(b => b.id === selectedBoxId);
                if (box) {
                    document.getElementById('marginTop').value = box.margin?.top || 0;
                    document.getElementById('marginRight').value = box.margin?.right || 0;
                    document.getElementById('marginBottom').value = box.margin?.bottom || 0;
                    document.getElementById('marginLeft').value = box.margin?.left || 0;
                }
            }
        }

        // Setup drag and resize functionality
        function setupDragAndResize() {
            const modal = document.getElementById('modalPreview');
            const resizeHandle = modal.querySelector('.resize-handle');

            // Resizing
            let isResizing = false;
            let originalWidth, originalHeight, originalMouseX, originalMouseY;

            resizeHandle.addEventListener('mousedown', resizeStart);
            document.addEventListener('mousemove', resize);
            document.addEventListener('mouseup', resizeEnd);

            function resizeStart(e) {
                isResizing = true;
                originalWidth = modal.offsetWidth;
                originalHeight = modal.offsetHeight;
                originalMouseX = e.clientX;
                originalMouseY = e.clientY;
                e.preventDefault();
            }

            function resize(e) {
                if (isResizing) {
                    const width = originalWidth + (e.clientX - originalMouseX);
                    const height = originalHeight + (e.clientY - originalMouseY);

                    modal.style.width = Math.max(50, width) + 'px';
                    modalWidth = Math.max(50, width);
                    modal.style.height = Math.max(50, height) + 'px';
                    modalHeight = Math.max(50, height);

                    updateSizeDisplay();
                }
            }

            function resizeEnd() {
                isResizing = false;
            }
        }

        // Update size display
        function updateSizeDisplay() {
            document.getElementById('modalWidth').textContent = Math.round(modalWidth);
            document.getElementById('modalHeight').textContent = Math.round(modalHeight);
        }

        // Export HTML
        function exportHTML() {
            // Create comprehensive export with context, data, HTML, and CSS
            let exportContent = '';

            // 1. Documentation Header
            exportContent += `/**
 * MODAL DESIGNER EXPORT
 * Generated: ${new Date().toISOString()}
 *
 * This file contains the complete design specification for a modal component.
 * It includes structure data, HTML markup, and CSS styles.
 *
 * MODAL DIMENSIONS:
 * - Width: ${modalWidth}px
 * - Height: ${modalHeight}px
 *
 * SECTIONS: ${sections.length}
 * TOTAL BOXES: ${sections.reduce((sum, s) => sum + s.boxes.length, 0)}
 */

`;

            // 2. Design Data (JSON format for easy AI interpretation)
            exportContent += `/* ========== DESIGN DATA (JSON) ========== */
/*
${JSON.stringify({
    modalDimensions: {
        width: modalWidth,
        height: modalHeight
    },
    sections: sections.map(section => ({
        id: section.id,
        name: section.name,
        heightPercentage: section.height,
        locked: section.locked,
        boxes: section.boxes.map(box => ({
            id: box.id,
            name: box.name,
            margin: box.margin
        }))
    }))
}, null, 2)}
*/

`;

            // 3. CSS Styles
            exportContent += `/* ========== CSS STYLES ========== */
<style>
.modal-container {
    width: ${modalWidth}px;
    height: ${modalHeight}px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
}

.modal-section {
    border-bottom: 1px solid #e0e0e0;
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
}

.modal-section:last-child {
    border-bottom: none;
}

.boxes-container {
    display: flex;
    width: 100%;
    height: 100%;
    gap: 0;
}

.content-box {
    flex: 1;
    background: #667eea;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 14px;
    font-weight: 600;
    position: relative;
}

.box-content {
    text-align: center;
    padding: 8px;
}
</style>

`;

            // 4. HTML Structure
            exportContent += `/* ========== HTML STRUCTURE ========== */
<div class="modal-container">
`;

            sections.forEach((section, sectionIndex) => {
                exportContent += `  <!-- Section ${sectionIndex + 1}: ${section.name} (${section.height.toFixed(1)}%) -->\n`;
                exportContent += `  <div class="modal-section" style="height: ${section.height}%;">\n`;

                if (section.boxes.length > 0) {
                    exportContent += `    <div class="boxes-container">\n`;

                    section.boxes.forEach((box, boxIndex) => {
                        const marginStyle = `margin: ${box.margin?.top || 0}px ${box.margin?.right || 0}px ${box.margin?.bottom || 0}px ${box.margin?.left || 0}px;`;
                        exportContent += `      <!-- Box ${boxIndex + 1}: ${box.name} -->\n`;
                        exportContent += `      <div class="content-box" style="${marginStyle}">\n`;
                        exportContent += `        <div class="box-content">${box.name}</div>\n`;
                        exportContent += `      </div>\n`;
                    });

                    exportContent += `    </div>\n`;
                } else {
                    exportContent += `    <!-- No boxes in this section -->\n`;
                }

                exportContent += `  </div>\n\n`;
            });

            exportContent += `</div>\n\n`;

            // 5. Additional Context
            exportContent += `/* ========== IMPLEMENTATION NOTES ========== */
/*
SECTION BREAKDOWN:
${sections.map((section, i) => `${i + 1}. ${section.name}${section.locked ? ' ðŸ”’ [LOCKED]' : ''}:
   - Height: ${section.height.toFixed(1)}%
   - Boxes: ${section.boxes.length}
   ${section.boxes.map((box, j) => `   ${j + 1}. "${box.name}" - Margins: T${box.margin?.top || 0} R${box.margin?.right || 0} B${box.margin?.bottom || 0} L${box.margin?.left || 0}`).join('\n   ')}`).join('\n')}

RESPONSIVE CONSIDERATIONS:
- Modal is fixed size: ${modalWidth}px Ã— ${modalHeight}px
- Sections use percentage heights for proportional scaling
- Boxes within sections use flexbox (equal width distribution)
- Individual box margins are customizable

TO USE THIS DESIGN:
1. Copy the CSS <style> block into your stylesheet or <head>
2. Copy the HTML structure where you need the modal
3. Adjust colors, fonts, and styles as needed
4. Reference the JSON data structure above for programmatic generation
*/`;

            showExportModal('Export Complete Design', exportContent);
        }

        // Show export modal
        function showExportModal(title, code) {
            const modal = document.getElementById('exportModal');
            const titleEl = document.getElementById('exportTitle');
            const codeEl = document.getElementById('exportCode');

            titleEl.textContent = title;
            codeEl.value = code;
            modal.classList.add('active');
        }

        // Close export modal
        function closeExportModal() {
            const modal = document.getElementById('exportModal');
            modal.classList.remove('active');
        }

        // Copy export code
        function copyExportCode() {
            const codeEl = document.getElementById('exportCode');
            codeEl.select();
            document.execCommand('copy');
            alert('Code copied to clipboard!');
        }

        // Export JSON
        function exportJSON() {
            const designData = {
                version: '1.0',
                modalDimensions: {
                    width: modalWidth,
                    height: modalHeight
                },
                sections: sections.map(section => ({
                    id: section.id,
                    name: section.name,
                    heightPercentage: section.height,
                    locked: section.locked,
                    boxes: section.boxes.map(box => ({
                        id: box.id,
                        name: box.name,
                        margin: box.margin
                    }))
                }))
            };

            const jsonString = JSON.stringify(designData, null, 2);
            showExportModal('Save Design (JSON)', jsonString);
        }

        // Show import modal
        function showImportModal() {
            const modal = document.getElementById('importModal');
            const codeEl = document.getElementById('importCode');
            codeEl.value = '';
            modal.classList.add('active');
        }

        // Close import modal
        function closeImportModal() {
            const modal = document.getElementById('importModal');
            modal.classList.remove('active');
        }

        // Import JSON
        function importJSON() {
            const codeEl = document.getElementById('importCode');
            const jsonString = codeEl.value.trim();

            if (!jsonString) {
                alert('Please paste JSON data to import.');
                return;
            }

            try {
                const data = JSON.parse(jsonString);

                // Validate data structure
                if (!data.modalDimensions || !data.sections) {
                    throw new Error('Invalid JSON structure. Missing required fields.');
                }

                // Restore modal dimensions
                modalWidth = data.modalDimensions.width || 400;
                modalHeight = data.modalDimensions.height || 600;

                const modal = document.getElementById('modalPreview');
                modal.style.width = `${modalWidth}px`;
                modal.style.height = `${modalHeight}px`;

                // Restore sections
                sections = data.sections.map(s => ({
                    id: s.id || Date.now() + Math.random(),
                    name: s.name || 'Section',
                    height: s.heightPercentage || 33.33,
                    locked: s.locked || false,
                    boxes: (s.boxes || []).map(b => ({
                        id: b.id || Date.now() + Math.random(),
                        name: b.name || 'Box',
                        margin: b.margin || { top: 0, right: 0, bottom: 0, left: 0 }
                    }))
                }));

                // Reset selection
                selectedSectionId = null;
                selectedBoxId = null;

                // Update display
                updateSizeDisplay();
                renderSections();
                renderControls();

                // Close modal
                closeImportModal();

                alert('Design loaded successfully!');
            } catch (error) {
                alert(`Failed to import JSON: ${error.message}\n\nPlease check your JSON format.`);
            }
        }

        // Reset modal
        function resetModal() {
            if (confirm('Are you sure you want to reset? This will clear everything.')) {
                sections = [];
                selectedSectionId = null;
                selectedBoxId = null;

                const modal = document.getElementById('modalPreview');
                modal.style.width = '400px';
                modal.style.height = '600px';
                modalWidth = 400;
                modalHeight = 600;

                updateSizeDisplay();
                init();
            }
        }

        // Click outside modals to close
        window.onclick = function(event) {
            const exportModal = document.getElementById('exportModal');
            const importModal = document.getElementById('importModal');

            if (event.target === exportModal) {
                closeExportModal();
            }

            if (event.target === importModal) {
                closeImportModal();
            }
        }

        // Initialize on load
        window.onload = init;
    </script>
</body>
</html>
