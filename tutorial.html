<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Tutorial Modal</title>
  <style>
    :root {
      --modal-w: min(92vw, 520px);
      --radius: 16px;
      --pad: 16px;
      --gif-w-max: min(86vw, 314px);
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --gap: 16px;
    }

    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans";
      background: #1a1a1a;
      min-height: 100dvh;
      display: grid;
      place-items: center;
      padding: clamp(16px, 2vw, 24px);
    }

    .btn { border: 1px solid #111; background:#111; color:#fff; padding:12px 18px; border-radius: 14px; cursor:pointer; }
    .btn:hover { opacity:.9; }

    .backdrop { 
      position: fixed; inset: 0; background: #1a1a1a;
      opacity: 0; pointer-events: none; transition: opacity 0.2s;
    }
    .backdrop.show { opacity: 1; pointer-events: auto; }

    .modal {
      position: fixed; inset: 0;
      display: grid; place-items: center; pointer-events:none;
      padding: var(--gap);
      opacity: 0; transition: opacity 0.2s;
    }
    .modal.show { opacity: 1; pointer-events: auto; }

    .card {
      width: var(--modal-w);
      background:#fcfaf3;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      max-height: calc(100dvh - 2*var(--gap));
      display: flex; flex-direction: column;
    }

    header.card-hd {
      padding: 16px 20px 8px;
      border-bottom: 1px solid #e6e6e6;
      text-align: center;
      background:#fcfaf3;
    }
    .eyebrow { font-size: 11px; letter-spacing: .12em; text-transform: uppercase; color:#777; }
    .title { margin:6px 0 0; font-size: 18px; font-weight: 700; color:#111; }

    main.card-main {
      padding: var(--pad);
      overflow: hidden;
      display: flex; flex-direction: column; gap: 12px;
      flex: 1 1 auto; background:#fcfaf3; min-height: 0;
    }

    .gif-container { 
      display: flex; align-items: center; justify-content: center;
      flex: 1 1 auto; min-height: 0; width: 100%;
      position: relative;
    }
    .gif-wrap { 
      border-radius: var(--radius); overflow: hidden; 
      box-shadow: 0 2px 12px rgba(0,0,0,0.08); 
      position: relative; 
      background: #f5f5f5;
    }
    .gif-img { 
      display: block;
      width: 100%;
      height: auto;
      user-select:none; 
      -webkit-user-drag:none;
    }

    .nav-btn {
      position: absolute;
      background: rgba(255,255,255,0.95); border: 1px solid rgba(0,0,0,0.1);
      width: 40px; height: 40px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-size: 18px; color: #111;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15); transition: all 0.2s;
      z-index: 10;
    }
    .nav-btn:hover { background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    .nav-btn:active { transform: scale(0.95); }
    #prevBtn { left: 8px; }
    #nextBtn { right: 8px; }

    footer.card-ft {
      border-top: 1px solid #e6e6e6;
      padding: 10px 20px;
      display:flex; align-items:center; justify-content: space-between;
      color:#666; font-size:12px; background:#fcfaf3;
    }
    .dots { display:flex; gap:6px; flex: 1; justify-content: center; }
    .dot { width: 7px; height: 7px; border-radius: 50%; background: transparent; border: 1.5px solid #999; cursor: pointer; padding: 0; transition: all 0.2s; }
    .dot.active { background: #111; border-color: #111; }
    .link { color:#333; text-decoration: underline; cursor:pointer; }
  </style>
</head>
<body>
  <button class="btn" id="openBtn">Open Tutorial</button>

  <div class="backdrop" id="backdrop"></div>

  <div class="modal" id="modal">
    <div class="card">
      <header class="card-hd">
        <div class="eyebrow">Tutorial LALALAND</div>
        <h2 class="title" id="slideTitle"></h2>
      </header>

      <main class="card-main">
        <div class="gif-container">
          <div class="gif-wrap">
            <img class="gif-img" id="gifImg" src="" alt="">
          </div>
          <button class="nav-btn" id="prevBtn">‹</button>
          <button class="nav-btn" id="nextBtn">›</button>
        </div>
      </main>

      <footer class="card-ft">
        <div class="dots" id="dots"></div>
        <span class="link" id="closeLink">Close</span>
      </footer>
    </div>
  </div>

  <script>
    const ORIGINAL_W = 514, ORIGINAL_H = 1138;
    const CROP_TOP = 57, CROP_BOTTOM = 57;

    const SLIDES = [
      { src: "https://lalaland.mx/tutorial/QuickSearch.gif",   header: "Búsqueda rápida de fraccionamientos" },
      { src: "https://lalaland.mx/tutorial/ViewList.gif",      header: "Lista de disponibilidad en tiempo real" },
      { src: "https://lalaland.mx/tutorial/ChangeStatus.gif",  header: "Cambia a vendido con un click" },
      { src: "https://lalaland.mx/tutorial/LotDetails.gif",    header: "Precio x m2, dimensiones y CTA's" },
      { src: "https://lalaland.mx/tutorial/POI.gif",           header: "Agrega los puntos de interés del proyecto" },
      { src: "https://lalaland.mx/tutorial/PriceQuickEdit.gif",header: "¿Necesitas actualizar un precio rápido?" },
      { src: "https://lalaland.mx/tutorial/CompareLots.gif",   header: "Compara precios para decidir inteligente" },
      { src: "https://lalaland.mx/tutorial/Streetview.gif",    header: "¿Sin Google Streetview? Nosotros nos encargamos" },
    ];

    const REDIRECT_URL = "https://lalaland.mx/wa?link=tuto";

    let index = 0;

    const backdrop = document.getElementById('backdrop');
    const modal = document.getElementById('modal');
    const slideTitle = document.getElementById('slideTitle');
    const gifImg = document.getElementById('gifImg');
    const gifWrap = gifImg.parentElement;
    const gifContainer = document.querySelector('.gif-container');
    const cardMain = document.querySelector('.card-main');
    const cardHd = document.querySelector('.card-hd');
    const cardFt = document.querySelector('.card-ft');
    const dots = document.getElementById('dots');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const closeLink = document.getElementById('closeLink');
    const openBtn = document.getElementById('openBtn');

    // Create dots
    SLIDES.forEach((_, i) => {
      const dot = document.createElement('button');
      dot.className = 'dot';
      dot.onclick = () => goTo(i);
      dots.appendChild(dot);
    });

    function calculateLayout() {
      const containerRect = gifContainer.getBoundingClientRect();
      const availableH = containerRect.height;
      const availableW = containerRect.width;
      
      const maxW = availableW;
      const visibleRatio = (ORIGINAL_H - CROP_TOP - CROP_BOTTOM) / ORIGINAL_H;
      
      let finalW = maxW;
      let scale = finalW / ORIGINAL_W;
      let renderedH = finalW * (ORIGINAL_H / ORIGINAL_W);
      let visibleH = renderedH * visibleRatio;

      if (visibleH > availableH) {
        visibleH = availableH;
        renderedH = visibleH / visibleRatio;
        finalW = (renderedH / ORIGINAL_H) * ORIGINAL_W;
        scale = finalW / ORIGINAL_W;
      }

      return {
        width: Math.max(160, finalW),
        height: Math.max(100, visibleH),
        maskTop: Math.round(CROP_TOP * scale)
      };
    }

    function applyLayout() {
      const d = calculateLayout();
      gifWrap.style.width = d.width + "px";
      gifWrap.style.height = d.height + "px";
      gifImg.style.transform = `translateY(-${d.maskTop}px)`;
    }

    function goTo(i) {
      index = i;
      render();
    }

    function render() {
      const slide = SLIDES[index];
      
      slideTitle.textContent = slide.header;

      // 1. Set the container size first.
      applyLayout(); 
      
      // 2. Then load the GIF into the pre-sized container.
      gifImg.src = slide.src;
      
      document.querySelectorAll('.dot').forEach((dot, i) => {
        dot.className = i === index ? 'dot active' : 'dot';
      });
    }

    // 🏆 THE FINAL FIXED LOGIC FOR OPENING THE MODAL
    function openAndRender() {
        backdrop.classList.add('show');
        modal.classList.add('show');
        
        // Use requestAnimationFrame to ensure the modal is laid out by the browser 
        // (the size of 'gifContainer' is correct) before calling render().
        requestAnimationFrame(() => {
            render();
        });
    }

    function open() {
        // Since we are opening the modal, start at the first slide (index 0)
        index = 0;
        openAndRender();
    }

    function close() {
      backdrop.classList.remove('show');
      modal.classList.remove('show');
      setTimeout(() => location.href = REDIRECT_URL, 200);
    }

    openBtn.onclick = open;
    backdrop.onclick = close;
    closeLink.onclick = close;
    prevBtn.onclick = () => goTo((index - 1 + SLIDES.length) % SLIDES.length);
    nextBtn.onclick = () => goTo((index + 1) % SLIDES.length);

    document.addEventListener('keydown', (e) => {
      if (!modal.classList.contains('show')) return;
      if (e.key === 'Escape') close();
      if (e.key === 'ArrowLeft') prevBtn.onclick();
      if (e.key === 'ArrowRight') nextBtn.onclick();
    });

    window.addEventListener('resize', () => {
      if (modal.classList.contains('show')) {
        applyLayout();
      }
    });

    // Auto-open modal on page load
    window.addEventListener('load', () => open());
  </script>
</body> 
</html>
