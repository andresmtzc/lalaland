<script>
  const ORIGINAL_W = 514, ORIGINAL_H = 1138;

  const SLIDES = [
    { src: "https://lalaland.mx/tutorial/QuickSearch.gif",   header: "Búsqueda rápida de fraccionamientos", cropTop: 57, cropBottom: 57 },
    { src: "https://lalaland.mx/tutorial/ViewList.gif",      header: "Lista de disponibilidad en tiempo real", cropTop: 57, cropBottom: 57 },
    { src: "https://lalaland.mx/tutorial/ChangeStatus.gif",  header: "Cambia a vendido con un click", cropTop: 57, cropBottom: 57 },
    { src: "https://lalaland.mx/tutorial/LotDetails.gif",    header: "Precio x m2, dimensiones y CTA's", cropTop: 57, cropBottom: 57 },
    { src: "https://lalaland.mx/tutorial/POI.gif",           header: "Agrega los puntos de interés del proyecto", cropTop: 57, cropBottom: 57 },
    { src: "https://lalaland.mx/tutorial/PriceQuickEdit.gif",header: "¿Necesitas actualizar un precio rápido?", cropTop: 57, cropBottom: 57 },
    { src: "https://lalaland.mx/tutorial/CompareLots.gif",   header: "Compara precios para decidir inteligente", cropTop: 57, cropBottom: 57 },
    { src: "https://lalaland.mx/tutorial/Streetview.gif",    header: "¿Sin Google Streetview? Nosotros nos encargamos", cropTop: 57, cropBottom: 57 },
  ];

  const SOFT_FADE = false;
  const REDIRECT_URL = "https://lalaland.mx/wa?link=tuto";

  let open = false, index = 0;

  const $ = (id)=>document.getElementById(id);
  const openBtn=$('openBtn'), backdrop=$('backdrop'), modal=$('modal'), card=$('card');
  const cardHd=$('cardHd'), cardMain=$('cardMain'), cardFt=$('cardFt'), title=$('slideTitle');
  const gifContainer=$('gifContainer'), gifWrap=$('gifWrap');
  const prevBtn=$('prevBtn'), nextBtn=$('nextBtn'), dots=$('dots'), closeLink=$('closeLink');

  const raf2 = (fn)=>requestAnimationFrame(()=>requestAnimationFrame(fn));

  function setOpen(v){ open=v; modal.setAttribute('aria-hidden', String(!v)); backdrop.setAttribute('aria-hidden', String(!v)); }
  function handleClose(){ setOpen(false); setTimeout(()=>location.href=REDIRECT_URL, 200); }
  function goNext(){ index=(index+1)%SLIDES.length; render(); }
  function goPrev(){ index=(index-1+SLIDES.length)%SLIDES.length; render(); }

  function calculateGifDimensions(cropTop, cropBottom) {
    const maxW = Math.min(window.innerWidth * 0.86, 314);
    const vh = window.innerHeight;
    const gap = 16;
    const cardMaxH = vh - (2 * gap);
    const hdH = cardHd.offsetHeight;
    const ftH = cardFt.offsetHeight;
    const cs = getComputedStyle(cardMain);
    const mainPadTop = parseFloat(cs.paddingTop);
    const mainPadBottom = parseFloat(cs.paddingBottom);
    const innerGap = 12;
    const availableH = cardMaxH - hdH - ftH - mainPadTop - mainPadBottom - innerGap;

    const visibleRatio = (ORIGINAL_H - cropTop - cropBottom) / ORIGINAL_H;

    let finalW = maxW;
    let scale = finalW / ORIGINAL_W;
    let renderedH = finalW * (ORIGINAL_H / ORIGINAL_W);
    let visibleH = renderedH * visibleRatio;

    if (visibleH > availableH) {
      visibleH = availableH;
      renderedH = visibleH / visibleRatio;
      finalW = (renderedH / ORIGINAL_H) * ORIGINAL_W;
      scale = finalW / ORIGINAL_W;
    }

    return {
      width: Math.max(160, finalW),
      height: Math.max(1, visibleH),
      renderedHeight: renderedH,
      maskTop: Math.round(cropTop * scale),
      maskBottom: Math.round(cropBottom * scale)
    };
  }

  function applyLayout(imgEl, slide) {
    const d = calculateGifDimensions(slide.cropTop, slide.cropBottom);
    gifWrap.style.width = d.width + "px";
    gifWrap.style.height = d.height + "px";
    imgEl.style.transform = `translateY(-${d.maskTop}px)`;
    if (!SOFT_FADE) {
      imgEl.style.clipPath = ''; imgEl.style.webkitMaskImage = ''; imgEl.style.maskImage = '';
    } else {
      imgEl.style.clipPath = 'none';
      imgEl.style.webkitMaskImage = `linear-gradient(0deg, transparent 0, transparent ${d.maskBottom}px, black ${d.maskBottom}px, black ${d.renderedHeight - d.maskTop}px, transparent ${d.renderedHeight - d.maskTop}px)`;
      imgEl.style.maskImage = imgEl.style.webkitMaskImage;
    }
  }

  // Create and mount image with better error handling
  async function mountImage(slide) {
    // Clear and rebuild dots
    dots.innerHTML = '';
    SLIDES.forEach((_, i) => {
      const b = document.createElement('button');
      b.className = 'dot'; b.type = 'button';
      b.setAttribute('aria-label', `Go to slide ${i+1}`);
      if (i === index) b.setAttribute('aria-current', 'true');
      b.addEventListener('click', () => { index = i; render(); });
      dots.appendChild(b);
    });

    // Clear any existing content first
    gifWrap.innerHTML = '';
    
    const newImg = new Image();
    newImg.className = 'gif-img';
    newImg.alt = slide.header;
    newImg.draggable = false;
    newImg.decoding = 'async';
    newImg.loading = 'eager';
    newImg.fetchPriority = 'high';
    newImg.style.visibility = 'hidden'; // Start hidden

    // Add to DOM immediately for consistent layout
    gifWrap.appendChild(newImg);

    try {
      // Set src and wait for load
      newImg.src = slide.src;
      
      await new Promise((resolve, reject) => {
        if (newImg.complete && newImg.naturalHeight !== 0) {
          resolve();
        } else {
          newImg.onload = resolve;
          newImg.onerror = () => reject(new Error(`Failed to load image: ${slide.src}`));
          // Add timeout as fallback
          setTimeout(() => {
            if (newImg.complete) resolve();
          }, 3000);
        }
      });

      // Try to decode if supported
      if (newImg.decode) {
        try { await newImg.decode(); } catch(e) { console.warn('Image decode failed:', e); }
      }

      // Ensure layout is calculated after image is in DOM
      await new Promise(r => requestAnimationFrame(r));
      
      // Apply layout and make visible
      applyLayout(newImg, slide);
      newImg.style.visibility = 'visible';
      
      // Double-check layout on next frame
      requestAnimationFrame(() => {
        applyLayout(newImg, slide);
        newImg.style.visibility = 'visible';
      });

    } catch (error) {
      console.error('Error loading image:', error);
      // Fallback: show error state but don't break the UI
      newImg.style.visibility = 'visible';
      newImg.alt = 'Failed to load image';
    }
  }

  function render() {
    const s = SLIDES[index];
    title.textContent = s.header;
    mountImage(s);
  }

  // Open modal and ensure proper rendering
  openBtn.addEventListener('click', () => { 
    setOpen(true); 
    // Reset to first slide when opening
    index = 0;
    raf2(render); 
  });

  // Event listeners
  backdrop.addEventListener('click', handleClose);
  closeLink.addEventListener('click', handleClose);
  prevBtn.addEventListener('click', goPrev);
  nextBtn.addEventListener('click', goNext);

  window.addEventListener('keydown', (e) => {
    if (!open) return;
    if (e.key === 'Escape') handleClose();
    if (e.key === 'ArrowRight') goNext();
    if (e.key === 'ArrowLeft') goPrev();
  });

  // Resize handling
  window.addEventListener('resize', () => {
    if (!open) return;
    const img = gifWrap.querySelector('img'); 
    if (img && img.complete) applyLayout(img, SLIDES[index]);
  });

  window.addEventListener('pageshow', () => {
    if (!open) return;
    const img = gifWrap.querySelector('img'); 
    if (img && img.complete) applyLayout(img, SLIDES[index]);
  });
</script>
