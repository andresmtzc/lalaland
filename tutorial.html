<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Tutorial Modal + Carousel (GIF mask)</title>
  <style>
    :root {
      --modal-w: min(92vw, 520px);
      --radius: 16px;
      --pad: 16px;
      --gif-w: min(86vw, 314px);
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --gap: 16px;
    }

    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans";
      background: #f5f5f5;
      min-height: 100dvh;
      display: grid;
      place-items: center;
      padding: clamp(16px, 2vw, 24px);
      padding-top: calc(clamp(16px, 2vw, 24px) + env(safe-area-inset-top));
      padding-bottom: calc(clamp(16px, 2vw, 24px) + env(safe-area-inset-bottom));
      padding-left: calc(clamp(16px, 2vw, 24px) + env(safe-area-inset-left));
      padding-right: calc(clamp(16px, 2vw, 24px) + env(safe-area-inset-right));
    }

    .btn { border: 1px solid #111; background:#111; color:#fff; padding:12px 18px; border-radius: 14px; cursor:pointer; }
    .btn:hover { opacity:.9; }

    .backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.6); display:none; }
    .backdrop[aria-hidden="false"] { display:block; }

    .modal {
      position: fixed; inset: 0;
      display: grid; place-items: center;
      pointer-events:none;
      padding: max(var(--gap), env(safe-area-inset-top))
               max(var(--gap), env(safe-area-inset-right))
               max(var(--gap), env(safe-area-inset-bottom))
               max(var(--gap), env(safe-area-inset-left));
      box-sizing: border-box;
    }

    .card {
      width: var(--modal-w);
      background:#fff;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      pointer-events: auto;
      max-height: calc(100dvh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 2*var(--gap));
      display: flex;
      flex-direction: column;
    }

    header.card-hd {
      padding: 16px 20px 8px;
      border-bottom: 1px solid #e6e6e6;
      text-align: center;
      background:#fff;
      flex: 0 0 auto;
    }
    .eyebrow { font-size: 11px; letter-spacing: .12em; text-transform: uppercase; color:#777; }
    .title { margin:6px 0 0; font-size: 18px; font-weight: 700; color:#111; }

    main.card-main {
      padding: var(--pad) calc(var(--pad) + 4px);
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      display: flex;
      flex-direction: column;
      gap: 12px;
      flex: 1 1 auto;
      background:#fff;
    }

    .gif-wrap {
      width: var(--gif-w);
      align-self: center;
      border-radius: var(--radius);
      overflow: hidden; /* crop window */
      box-shadow: 0 2px 12px rgba(0,0,0,.08);
      position: relative;
      /* height set via JS */
    }
    .gif-img {
      display:block;
      width: var(--gif-w);
      height:auto;
      user-select:none;
      -webkit-user-drag:none;
      will-change: transform;
      transform: translateY(0); /* reset default */
    }

    .controls {
      display:flex; align-items:center; justify-content:space-between;
      flex: 0 0 auto;
      min-height: 44px; /* stabilize measurement between slides */
    }
    .tbtn { border:1px solid #d8d8d8; background:#fff; padding:8px 10px; border-radius: 12px; cursor:pointer; font-size: 14px; }
    .tbtn:hover { background:#fafafa; }
    .dots { display:flex; gap:8px; }
    .dot { width:10px; height:10px; border-radius:50%; background:#d0d0d0; border:none; cursor:pointer; }
    .dot[aria-current="true"] { background:#111; }

    footer.card-ft {
      border-top: 1px solid #e6e6e6;
      padding: 10px 20px;
      display:flex; align-items:center; justify-content:space-between;
      color:#666; font-size:12px;
      background:#fff;
      flex: 0 0 auto;
    }
    .link { color:#333; text-decoration: underline; cursor:pointer; }
  </style>
</head>
<body>
  <button class="btn" id="openBtn">Open Tutorial</button>

  <div class="backdrop" id="backdrop" aria-hidden="true"></div>

  <div class="modal" id="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-label="Quick tutorial">
    <div class="card" id="card" role="document">
      <header class="card-hd" id="cardHd">
        <div class="eyebrow">Tutorial LALALAND</div>
        <h2 class="title" id="slideTitle">Loading…</h2>
      </header>

      <main class="card-main" id="cardMain">
        <div class="gif-wrap" id="gifWrap">
          <img class="gif-img" id="gifImg" alt="tutorial step" draggable="false" />
        </div>

        <div class="controls" id="controls">
          <button class="tbtn" id="prevBtn" aria-label="Previous slide">← Prev</button>
          <div class="dots" id="dots"></div>
          <button class="tbtn" id="nextBtn" aria-label="Next slide">Next →</button>
        </div>
      </main>

      <footer class="card-ft" id="cardFt">
        <span>Tip, use ← → keys, Esc to close</span>
        <span class="link" id="closeLink">Close</span>
      </footer>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const ORIGINAL_W = 514;
    const ORIGINAL_H = 1138;

    const SLIDES = [
      { src: "https://lalaland.mx/tutorial/QuickSearch.gif",   header: "Búsqueda rápida de fraccionamientos", cropTop: 57, cropBottom: 57 },
      { src: "https://lalaland.mx/tutorial/ViewList.gif",      header: "Lista de disponibilidad en tiempo real", cropTop: 57, cropBottom: 57 },
      { src: "https://lalaland.mx/tutorial/ChangeStatus.gif",  header: "Cambia a vendido con un click", cropTop: 57, cropBottom: 57 },
      { src: "https://lalaland.mx/tutorial/LotDetails.gif",    header: "Precio x m2, dimensiones y CTA's", cropTop: 57, cropBottom: 57 },
      { src: "https://lalaland.mx/tutorial/POI.gif",           header: "Agrega los puntos de interés del proyecto", cropTop: 57, cropBottom: 57 },
      { src: "https://lalaland.mx/tutorial/PriceQuickEdit.gif",header: "¿Necesitas actualizar un precio rápido?", cropTop: 57, cropBottom: 57 },
      { src: "https://lalaland.mx/tutorial/CompareLots.gif",   header: "Compara precios para decidir inteligente", cropTop: 57, cropBottom: 57 },
      { src: "https://lalaland.mx/tutorial/Streetview.gif",    header: "¿Sin Google Streetview? Nosotros nos encargamos", cropTop: 57, cropBottom: 57 },
    ];

    const SOFT_FADE = false;
    const REDIRECT_URL = "https://lalaland.mx/wa?link=tuto";

    let open = false;
    let index = 0;

    // ===== EL REFS =====
    const openBtn   = document.getElementById('openBtn');
    const backdrop  = document.getElementById('backdrop');
    const modal     = document.getElementById('modal');
    const card      = document.getElementById('card');
    const cardHd    = document.getElementById('cardHd');
    const cardMain  = document.getElementById('cardMain');
    const cardFt    = document.getElementById('cardFt');
    const title     = document.getElementById('slideTitle');
    const gifWrap   = document.getElementById('gifWrap');
    const gifImg    = document.getElementById('gifImg');
    const controls  = document.getElementById('controls');
    const prevBtn   = document.getElementById('prevBtn');
    const nextBtn   = document.getElementById('nextBtn');
    const dots      = document.getElementById('dots');
    const closeLink = document.getElementById('closeLink');

    function setOpen(v) {
      open = v;
      modal.setAttribute('aria-hidden', String(!v));
      backdrop.setAttribute('aria-hidden', String(!v));
    }
    function handleClose() {
      setOpen(false);
      setTimeout(() => window.location.href = REDIRECT_URL, 200);
    }
    function goNext() { index = (index + 1) % SLIDES.length; render(); }
    function goPrev() { index = (index - 1 + SLIDES.length) % SLIDES.length; render(); }

    // Compute max gif height so everything fits without scrolling
    function layoutGifHeight(renderedH, maskTop, maskBottom) {
      // Calculate from viewport down (avoiding circular dependency)
      const vh = window.innerHeight;
      
      // Get gap (16px as defined in CSS --gap)
      const gap = 16;
      
      // Account for safe area insets (will be 0 on most devices)
      const style = getComputedStyle(document.documentElement);
      const safeTop = parseFloat(style.paddingTop) || 0;
      const safeBottom = parseFloat(style.paddingBottom) || 0;
      
      // Total available height for card
      const cardMaxH = vh - (2 * gap) - safeTop - safeBottom;
      
      // Measure actual header and footer heights
      const hdH = cardHd.offsetHeight;
      const ftH = cardFt.offsetHeight;
      
      // Get main padding
      const cs = getComputedStyle(cardMain);
      const mainPadTop = parseFloat(cs.paddingTop);
      const mainPadBottom = parseFloat(cs.paddingBottom);
      
      // Get controls height and gap between gif and controls
      const controlsH = controls.offsetHeight;
      const innerGap = 12;
      
      // Calculate available space for GIF
      const availableForGif = cardMaxH - hdH - ftH - mainPadTop - mainPadBottom - controlsH - innerGap;
      
      // Natural visible height after masking
      const visibleH = renderedH - maskTop - maskBottom;
      
      // Return the smaller of natural size or available space
      return Math.max(1, Math.min(visibleH, availableForGif));
    }

    function render() {
      const s = SLIDES[index];
      title.textContent = s.header;

      // Build dots first (stabilizes controls height)
      dots.innerHTML = '';
      SLIDES.forEach((_, i) => {
        const b = document.createElement('button');
        b.className = 'dot';
        b.type = 'button';
        b.setAttribute('aria-label', `Go to slide ${i+1}`);
        if (i === index) b.setAttribute('aria-current', 'true');
        b.addEventListener('click', () => { index = i; render(); });
        dots.appendChild(b);
      });

      // Set src (may not be loaded yet)
      gifImg.src = s.src;

      // After the browser paints dots/controls, measure and size
      requestAnimationFrame(() => {
        const renderedW = gifWrap.getBoundingClientRect().width || parseFloat(getComputedStyle(gifWrap).width);
        const renderedH = Math.round(renderedW * (ORIGINAL_H / ORIGINAL_W));
        const scale = renderedW / ORIGINAL_W;

        const maskTop = Math.round(s.cropTop * scale);
        const maskBottom = Math.round(s.cropBottom * scale);

        const finalH = layoutGifHeight(renderedH, maskTop, maskBottom);
        gifWrap.style.height = finalH + "px";
        gifImg.style.transform = `translateY(-${maskTop}px)`;

        if (!SOFT_FADE) {
          gifImg.style.clipPath = '';
          gifImg.style.webkitMaskImage = '';
          gifImg.style.maskImage = '';
        } else {
          gifImg.style.clipPath = 'none';
          gifImg.style.webkitMaskImage = `linear-gradient(0deg, transparent 0, transparent ${maskBottom}px, black ${maskBottom}px, black ${renderedH - maskTop}px, transparent ${renderedH - maskTop}px)`;
          gifImg.style.maskImage = gifImg.style.webkitMaskImage;
        }
      });
    }

    // Recompute when the image actually loads (prevents "compressed start")
    gifImg.addEventListener('load', () => { if (open) render(); });

    // Events
    openBtn.addEventListener('click', () => { setOpen(true); render(); });
    backdrop.addEventListener('click', handleClose);
    closeLink.addEventListener('click', handleClose);
    prevBtn.addEventListener('click', goPrev);
    nextBtn.addEventListener('click', goNext);
    window.addEventListener('keydown', (e) => {
      if (!open) return;
      if (e.key === 'Escape') handleClose();
      if (e.key === 'ArrowRight') goNext();
      if (e.key === 'ArrowLeft') goPrev();
    });

    // Keep sizing stable on rotate/resize
    window.addEventListener('resize', () => { if (open) render(); });

    // Initial measurement
    render();
  </script> 
</body>
</html>
